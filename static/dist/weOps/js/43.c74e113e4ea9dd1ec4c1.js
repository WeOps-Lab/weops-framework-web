(window.webpackJsonp=window.webpackJsonp||[]).push([[43],{TuIn:function(e,t,n){"use strict";n.r(t);var i,a=n("G0B5"),s=n("ac6i"),o=n("JnIg"),r=n("uMZD"),l=(i=function(e,t){return i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},i(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function n(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),c=function(e,t,n,i){var a,s=arguments.length,o=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,i);else for(var r=e.length-1;r>=0;r--)(a=e[r])&&(o=(s<3?a(o):s>3?a(t,n,o):a(t,n))||o);return s>3&&o&&Object.defineProperty(t,n,o),o},p=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.visible=!1,t.fieldList=[],t.isAllChecked=!1,t}return l(t,e),t.prototype.show=function(e){var t=this;this.visible=!0,this.fieldList=e.map((function(e){return t.$set(e,"isChecked",!1),e}))},t.prototype.changeFieldStatus=function(){this.isAllChecked=this.fieldList.every((function(e){return e.isChecked}))},t.prototype.setAllChecked=function(e){var t=this;this.fieldList.forEach((function(e){e.isChecked=t.isAllChecked}))},t.prototype.confirm=function(){this.$emit("confirm-export",this.fieldList.filter((function(e){return e.isChecked}))),this.visible=!1},t.prototype.cancel=function(){this.$emit("cancel-export")},t=c([Object(a.a)({name:"ticket-export"})],t)}(a.e),u=p,h=n("KHd+"),m=Object(h.a)(u,(function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("bk-dialog",{attrs:{theme:"primary",width:720,"mask-close":!1,"header-position":"left",title:"工单导出","auto-close":!1},on:{confirm:e.confirm,cancel:e.cancel},model:{value:e.visible,callback:function(t){e.visible=t},expression:"visible"}},[n("div",{staticClass:"content-box"},[n("div",{staticClass:"introduce"},[n("bk-icon",{attrs:{type:"question-circle"}}),e._v(" "),n("div",[e._v("\n                请勾选需要导出的工单信息，系统将根据最新一次工单筛选结果进行导出，系统会默认导出工单服务中最新的字段，不支持附件、自定义表单。\n            ")])],1),e._v(" "),n("div",{staticClass:"select-box"},[n("bk-checkbox",{attrs:{"true-value":!0,"false-value":!1},on:{change:e.setAllChecked},model:{value:e.isAllChecked,callback:function(t){e.isAllChecked=t},expression:"isAllChecked"}},[e._v("\n                全选\n            ")]),e._v(" "),n("div",{staticClass:"mt20"},e._l(e.fieldList,(function(t){return n("bk-checkbox",{key:t.key,staticClass:"mr30",attrs:{"true-value":!0,"false-value":!1},on:{change:e.changeFieldStatus},model:{value:t.isChecked,callback:function(n){e.$set(t,"isChecked",n)},expression:"item.isChecked"}},[e._v("\n                    "+e._s(t.label)+"\n                ")])})),1)],1)])])}),[],!1,null,"469abe0e",null).exports,d=function(){var e=function(t,n){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},e(t,n)};return function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}(),f=function(e,t,n,i){var a,s=arguments.length,o=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,i);else for(var r=e.length-1;r>=0;r--)(a=e[r])&&(o=(s<3?a(o):s>3?a(t,n,o):a(t,n))||o);return s>3&&o&&Object.defineProperty(t,n,o),o},_=function(e,t,n,i){return new(n||(n=Promise))((function(a,s){function o(e){try{l(i.next(e))}catch(e){s(e)}}function r(e){try{l(i.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,r)}l((i=i.apply(e,t||[])).next())}))},v=function(e,t){var n,i,a,s,o={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return s={next:r(0),throw:r(1),return:r(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function r(s){return function(r){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;o;)try{if(n=1,i&&(a=2&s[0]?i.return:s[0]?i.throw||((a=i.return)&&a.call(i),0):i.next)&&!(a=a.call(i,s[1])).done)return a;switch(i=0,a&&(s=[2&s[0],a.value]),s[0]){case 0:case 1:a=s;break;case 4:return o.label++,{value:s[1],done:!1};case 5:o.label++,i=s[1],s=[0];continue;case 7:s=o.ops.pop(),o.trys.pop();continue;default:if(!(a=o.trys,(a=a.length>0&&a[a.length-1])||6!==s[0]&&2!==s[0])){o=0;continue}if(3===s[0]&&(!a||s[1]>a[0]&&s[1]<a[3])){o.label=s[1];break}if(6===s[0]&&o.label<a[1]){o.label=a[1],a=s;break}if(a&&o.label<a[2]){o.label=a[2],o.ops.push(s);break}a[2]&&o.ops.pop(),o.trys.pop();continue}s=t.call(e,o)}catch(e){s=[6,e],i=0}finally{n=a=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,r])}}},y=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.tableLoading=!1,t.dataList=[],t.columns=[],t.toDoColumns=[{type:"selection",width:"50px"},{label:"单号",key:"sn",align:"left",minWidth:"120px",scopedSlots:"sn"},{label:"提单人",key:"creator",align:"left",minWidth:"100px"},{label:"标题",key:"title",align:"left",minWidth:"150px"},{label:"服务",key:"service_name",align:"left",minWidth:"100px",exportFieldKey:"catalog_fullname"},{label:"提单时间",key:"create_at",align:"left",minWidth:"100px"},{label:"剩余处理时间",key:"remain_time",align:"left",minWidth:"250px",scopedSlots:"remain_time",isDisabledExport:!0},{label:"约定完成时间",key:"plan_time",align:"left",minWidth:"200px",scopedSlots:"plan_time",isDisabledExport:!0},{label:"当前步骤",key:"current_steps",align:"left",minWidth:"100px",scopedSlots:"current_steps"},{label:"当前处理人",key:"current_processors",align:"center",minWidth:"100px",isDisabledExport:!0},{label:"操作",key:"operation",align:"left",width:"80px",scopedSlots:"operation",fixed:"right"}],t.historyTicketColumns=[{type:"selection",width:"50px"},{label:"单号",key:"sn",align:"left",minWidth:"120px",scopedSlots:"sn"},{label:"提单人",key:"creator",align:"left",minWidth:"100px"},{label:"标题",key:"title",align:"left",minWidth:"150px"},{label:"服务",key:"service_name",align:"left",minWidth:"100px",exportFieldKey:"catalog_fullname"},{label:"提单时间",key:"create_at",align:"left",minWidth:"100px"},{label:"剩余处理时间",key:"remain_time",align:"left",minWidth:"250px",scopedSlots:"remain_time",isDisabledExport:!0},{label:"约定完成时间",key:"plan_time",align:"left",minWidth:"200px",scopedSlots:"plan_time",isDisabledExport:!0},{label:"状态",key:"current_status_display",align:"left",minWidth:"100px"},{label:"满意度",key:"satisfaction",align:"left",minWidth:"100px",scopedSlots:"satisfaction"}],t.satisfactionMap={0:"未评价",1:"非常不满意",2:"不满意",3:"一般",4:"满意",5:"非常满意"},t.maxHeight="",t.pagination={current:1,count:1,limit:20},t.menuList=[{label:"我的待办",name:"my_todo"},{label:"所有待办",name:"all_todo"},{label:"历史工单",name:"all_history"}],t.currentSearchType="creator__in",t.filterList=[{id:"creator__in",name:"提单人"},{id:"current_processors",name:"当前处理人"},{id:"keyword",name:"单号/标题"},{id:"service_id__in",name:"服务"}],t.active="my_todo",t.searchValue="",t.userData=[],t.servicesList=[],t.ticketPeopleLoading=!0,t.selectTableData=[],t.exportFiledList=[],t.isExportAll=!1,t}return d(t,e),Object.defineProperty(t.prototype,"powerParams",{get:function(){return{id:this.$route.name,type:"operateAuth"}},enumerable:!1,configurable:!0}),t.prototype.mounted=function(){var e=this;this.userData=sessionStorage.getItem("allUserData")?JSON.parse(sessionStorage.getItem("allUserData")):[],this.getServices(),this.getTickets(),this.setColumns();this.maxHeight=window.innerHeight-225,window.onresize=function(){e.maxHeight=window.innerHeight-225}},t.prototype.confirmExport=function(e){this.exportFiledList=e,this.exportTicket()},t.prototype.clearData=function(){this.exportFiledList=[]},t.prototype.selectTable=function(e){this.selectTableData=e||[]},t.prototype.handleDownload=function(e){return _(this,void 0,void 0,(function(){var t,n,i,a;return v(this,(function(s){switch(s.label){case 0:return this.isExportAll=!1,this.dataList&&0!==this.dataList.length?"curPage"!==e?[3,1]:(this.selectTableData=this.dataList,[3,5]):(this.$warn("暂无数据导出"),[2,!1]);case 1:return"select"!==e?[3,2]:this.selectTableData.length?[3,5]:(this.$warn("请选择要导出的数据"),[2,!1]);case 2:return"all"!==e?[3,5]:"all_history"!==this.active?[3,4]:(t={page:this.pagination.current,page_size:-1,view_type:"my_all",overall_current_status__in:"已解决,已完成,被终止,被撤销"},[4,this.$api.ticket.getTickets(t)]);case 3:return n=s.sent(),i=n.result,a=n.data,i?(this.selectTableData=a,[3,5]):[2,!1];case 4:this.isExportAll=!0,s.label=5;case 5:return this.showTicketExport(),[2]}}))}))},t.prototype.exportTicket=function(){var e={view_type:"my_todo"===this.active?this.active:"my_all",export_fields:this.exportFiledList.map((function(e){return e.exportFieldKey||e.key})).join(","),id__in:this.isExportAll?"":this.selectTableData.map((function(e){return e.id})).join(",")},t=[];for(var n in e)t.push("".concat(n,"=").concat(e[n]));var i=window.siteUrl+"/itsm/v2/export_ticket/?".concat(t.join("&"));window.location.href=i,this.clearData()},t.prototype.showTicketExport=function(){this.$refs.ticketExport.show(this.columns.slice(1,"all_history"===this.active?this.columns.length:this.columns.length-1).filter((function(e){return!e.isDisabledExport})))},t.prototype.handleTicket=function(e){if(!this.$BtnPermission(this.powerParams))return!1;this.$router.push({name:"TicketsDetail",query:{id:e.id,title:e.service_name,sn:e.sn}})},t.prototype.handlePageChange=function(e){this.pagination.current=e,this.getTickets()},t.prototype.limitChange=function(e){this.pagination.limit=e,this.pagination.current=1,this.getTickets()},t.prototype.setColumns=function(){var e=this;this.$nextTick((function(){e.columns="all_history"===e.active?e.historyTicketColumns:e.toDoColumns,e.$refs.sourceTable.updateColumns(e.columns)}))},t.prototype.getTickets=function(){var e=this,t={page:this.pagination.current,page_size:this.pagination.limit,view_type:this.active};String(this.searchValue).trim().length&&(t[this.currentSearchType]=this.searchValue),"my_todo"===this.active?t.view_type=this.active:(t.view_type="my_all",t.overall_current_status__in="all_todo"===this.active?"新,处理中,挂起,待确认":"已解决,已完成,被终止,被撤销"),this.tableLoading=!0,this.$api.ticket.getTickets(t).then((function(t){if(!t.result)return e.$error(t.message),e.dataList=[],!1;e.dataList=t.data.items,e.pagination.count=t.data.count,e.setColumns()})).finally((function(){e.tableLoading=!1}))},t.prototype.getTicketsPeople=function(e){var t=this;this.ticketPeopleLoading=!0,this.$api.ticket.getTicketsPeople({ids:e}).then((function(e){var n=e.result,i=e.data;if(!n||"{}"===JSON.stringify(i))return!1;t.dataList.forEach((function(e){t.$set(e,"currentHandler",i.processors[e.id])}))})).finally((function(){t.ticketPeopleLoading=!1}))},t.prototype.getServices=function(){var e=this;this.$api.ticket.getServices({page:1,page_size:9999}).then((function(t){if(!t.result)return!1;e.servicesList=t.data.items}))},t.prototype.toTabMenu=function(e){this.active=e.name,this.searchValue.trim().length?(this.currentSearchType="creator__in",this.searchValue=""):this.getTickets()},t=f([Object(a.a)({name:"ticket-index",components:{menuTab:s.a,ComTable:o.a,HeaderSub:r.a,TicketExport:m},filters:{showSlaTime:function(e){return"".concat(e.name,": ").concat("reply"===e.type?"响应":"处理","时间").concat(e.value)},showSlaRemainTime:function(e,t){void 0===t&&(t="justTime");var n=e.value;if(n instanceof Array){for(var i=n.length,a=!1,s=0;s<n.length;s++)if(0!==n[s]){n[s]<0&&(a=!0),i=s;break}n=n.map((function(e){return Math.abs(e)}));var o="";switch(i){case 0:o=n[0]+"年"+n[1]+"个月"+n[2]+"天"+n[3]+"小时"+n[4]+"分",a&&(o=n[0]+" + 年");break;case 1:o=n[1]+"个月"+n[2]+"天"+n[3]+"小时"+n[4]+"分",a&&(o=n[1]+" + 个月");break;case 2:o=n[2]+"天"+n[3]+"小时"+n[4]+"分";break;case 3:o=n[3]+"小时"+n[4]+"分";break;case 4:o=n[4]+"分";break;default:o=""}var r=o||"0分";return"justTime"===t?"".concat(a?"超时":"剩余").concat(r):"".concat(e.name,": ").concat("reply"===e.type?"响应":"处理","时间").concat(a?"超时":"剩余").concat(r)}}},beforeRouteLeave:function(e,t,n){this.$handleKeepAlive(e,t),n()}})],t)}(a.e),b=y,k=Object(h.a)(b,(function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",{staticClass:"ticket"},[n("header-sub",{staticClass:"ticket-header"},[n("template",{slot:"title"},[n("menu-tab",{attrs:{panels:e.menuList,type:"line","active-panel":e.active},on:{click:e.toTabMenu}})],1)],2),e._v(" "),n("div",{staticClass:"ticket-box"},[n("div",{staticClass:"action-bar"},[n("bk-dropdown-menu",{ref:"dropdown",staticClass:"mr20",attrs:{disabled:e.tableLoading}},[n("bk-button",{attrs:{slot:"dropdown-trigger",theme:"default","icon-right":"icon-angle-down"},slot:"dropdown-trigger"},[e._v("\n                    导出\n                ")]),e._v(" "),n("ul",{staticClass:"bk-dropdown-list",attrs:{slot:"dropdown-content"},slot:"dropdown-content"},[n("li",[n("a",{attrs:{href:"javascript:;"},on:{click:function(t){return e.handleDownload("curPage")}}},[e._v("当前页")])]),e._v(" "),n("li",[n("a",{attrs:{href:"javascript:;"},on:{click:function(t){return e.handleDownload("select")}}},[e._v("当前所选")])]),e._v(" "),n("li",[n("a",{attrs:{href:"javascript:;"},on:{click:function(t){return e.handleDownload("all")}}},[e._v("全部")])])])],1),e._v(" "),n("div",{staticClass:"search-box"},[n("bk-select",{staticStyle:{width:"120px"},attrs:{clearable:!1,disabled:!1,"ext-cls":"select-custom","ext-popover-cls":"select-popover-custom"},model:{value:e.currentSearchType,callback:function(t){e.currentSearchType=t},expression:"currentSearchType"}},e._l(e.filterList,(function(e){return n("bk-option",{key:e.id,attrs:{id:e.id,name:e.name}})})),1),e._v(" "),["keyword","title"].includes(e.currentSearchType)?n("bk-input",{staticStyle:{flex:"1"},attrs:{clearable:!0},on:{enter:e.getTickets,clear:e.getTickets},model:{value:e.searchValue,callback:function(t){e.searchValue=t},expression:"searchValue"}}):["creator__in","current_processors"].includes(e.currentSearchType)?n("bk-select",{staticStyle:{flex:"1"},attrs:{searchable:"","id-key":"key",list:e.userData,placeholder:"请选择","enable-virtual-scroll":"","search-placeholder":"请选择","ext-cls":"select-custom","display-key":"display","search-with-pinyin":!0,"ext-popover-cls":"select-popover-custom","popover-options":{appendTo:"parent"}},on:{change:e.getTickets},model:{value:e.searchValue,callback:function(t){e.searchValue=t},expression:"searchValue"}}):n("bk-select",{staticStyle:{flex:"1"},attrs:{disabled:!1,"ext-cls":"select-custom","ext-popover-cls":"select-popover-custom",searchable:""},on:{change:e.getTickets},model:{value:e.searchValue,callback:function(t){e.searchValue=t},expression:"searchValue"}},e._l(e.servicesList,(function(e){return n("bk-option",{key:e.id,attrs:{id:e.id,name:e.name}})})),1)],1)],1),e._v(" "),n("com-table",{directives:[{name:"bkloading",rawName:"v-bkloading",value:{isLoading:e.tableLoading,zIndex:10},expression:"{ isLoading: tableLoading, zIndex: 10 }"}],ref:"sourceTable",staticClass:"com-table",attrs:{id:"center_table",data:e.dataList,columns:e.columns,"max-height":e.maxHeight,pagination:e.pagination},on:{"page-change":e.handlePageChange,"page-limit-change":e.limitChange,select:e.selectTable,"select-all":e.selectTable},scopedSlots:e._u([{key:"current_steps",fn:function(t){var i=t.row;return[n("span",[e._v(e._s(i.current_steps[0]?i.current_steps[0].name:"--"))])]}},{key:"remain_time",fn:function(t){var i=t.row;return[i.remain_time.length?[n("bk-popover",{attrs:{content:e._f("showSlaRemainTime")(i.remain_time[0],"justTime"),"tippy-options":{duration:0}}},[n("span",{style:{color:i.sla_color}},[e._v(e._s(e._f("showSlaRemainTime")(i.remain_time[0],"justTime")))])]),e._v(" "),n("span",{class:{"sla-status":!0,"timeout-status":"OVERTIME"===i.sla_type,"warning-status":"WARNING"===i.sla_type}},[i.remain_time.some((function(e){return"reply"===e.type}))?n("span",[e._v("待响应")]):n("span",[e._v("待处理")])]),e._v(" "),i.remain_time.length>1||i.node_remain_time.length?n("bk-popover",{attrs:{placement:"top"}},[n("span",{staticClass:"sla-more"},[e._v("\n                            更多\n                        ")]),e._v(" "),n("div",{staticStyle:{"max-width":"300px"},attrs:{slot:"content"},slot:"content"},[e._l(i.remain_time,(function(t,i){return[n("p",{key:i,staticClass:"m10"},[e._v(e._s(e._f("showSlaRemainTime")(t,"wholeMessage")))])]})),e._v(" "),e._l(i.node_remain_time,(function(t,i){return[n("p",{key:i,staticClass:"m10"},[e._v(e._s(e._f("showSlaRemainTime")({value:t,name:"本节点要求"},"wholeMessage")))])]}))],2)]):e._e()]:i.node_remain_time&&i.node_remain_time.length?[n("bk-popover",{attrs:{content:e._f("showSlaRemainTime")({value:i.node_remain_time[0],name:"本节点要求"},"justTime"),"tippy-options":{duration:0}}},[n("span",[e._v(e._s(e._f("showSlaRemainTime")({value:i.node_remain_time[0],name:"本节点要求"},"justTime")))])]),e._v(" "),n("span",{class:{"sla-status":!0}},[n("span",[e._v("待处理")])]),e._v(" "),i.node_remain_time.length>1?n("bk-popover",{attrs:{placement:"top"}},[n("span",{staticClass:"sla-more"},[e._v("\n                            更多\n                        ")]),e._v(" "),n("div",{staticStyle:{"max-width":"300px"},attrs:{slot:"content"},slot:"content"},[e._l(i.node_remain_time,(function(t,i){return[n("p",{key:i,staticClass:"m10"},[e._v(e._s(e._f("showSlaRemainTime")({value:t,name:"本节点要求"},"wholeMessage")))])]}))],2)]):e._e()]:[e._v("\n                    --\n                ")]]}},{key:"plan_time",fn:function(t){var i=t.row;return[i.plan_time.length?[n("span",{style:{color:i.sla_color}},[e._v(e._s(i.plan_time[0].value))]),e._v(" "),i.plan_time.length>1||i.node_plan_time.length?n("bk-popover",{attrs:{placement:"top"}},[n("span",{staticClass:"sla-more"},[e._v("\n                            更多\n                        ")]),e._v(" "),n("div",{staticStyle:{"max-width":"300px"},attrs:{slot:"content"},slot:"content"},[e._l(i.plan_time,(function(t,i){return[n("p",{key:i,staticClass:"m10"},[e._v(e._s(e._f("showSlaTime")(t)))])]})),e._v(" "),e._l(i.node_plan_time,(function(t,i){return[n("p",{key:i,staticClass:"m10"},[e._v(e._s(e._f("showSlaTime")({value:t,name:"本节点要求"})))])]}))],2)]):e._e()]:i.node_plan_time&&i.node_plan_time.length?[n("span",{attrs:{title:i.node_plan_time[0].value}},[e._v(e._s(i.node_plan_time[0]))]),e._v(" "),i.node_plan_time.length>1?n("bk-popover",{attrs:{placement:"top"}},[n("span",{staticClass:"sla-more"},[e._v("\n                            更多\n                        ")]),e._v(" "),n("div",{staticStyle:{"max-width":"300px"},attrs:{slot:"content"},slot:"content"},[e._l(i.node_plan_time,(function(t,i){return[n("p",{key:i,staticClass:"m10"},[e._v(e._s(e._f("showSlaTime")({value:t,name:"本节点要求"})))])]}))],2)]):e._e()]:[e._v("\n                    --\n                ")]]}},{key:"operation",fn:function(t){var i=t.row;return[n("bk-button",{directives:[{name:"permission",rawName:"v-permission",value:e.powerParams,expression:"powerParams"}],staticClass:"mr10",attrs:{theme:"primary",text:""},on:{click:function(t){return e.handleTicket(i)}}},[e._v("\n                    处理\n                ")])]}},{key:"sn",fn:function(t){var i=t.row;return[n("span",{directives:[{name:"permission",rawName:"v-permission",value:e.powerParams,expression:"powerParams"}],staticStyle:{color:"#3a84ff",cursor:"pointer"},on:{click:function(t){return e.handleTicket(i)}}},[e._v(e._s(i.sn))])]}},{key:"satisfaction",fn:function(t){var i=t.row;return[n("span",[e._v(e._s(e.satisfactionMap[i.satisfaction]))])]}}])})],1),e._v(" "),n("ticket-export",{ref:"ticketExport",on:{"confirm-export":e.confirmExport,"cancel-export":e.clearData}})],1)}),[],!1,null,null,null);t.default=k.exports}}]);