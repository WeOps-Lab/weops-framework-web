(window.webpackJsonp=window.webpackJsonp||[]).push([[25],{FvTB:function(t,e,i){"use strict";i.r(e);var n,r=i("G0B5"),o=i("t2rG"),a=i.n(o),s=(n=function(t,e){return n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])},n(t,e)},function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function i(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}),l=function(t,e,i,n){var r,o=arguments.length,a=o<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,i,n);else for(var s=t.length-1;s>=0;s--)(r=t[s])&&(a=(o<3?r(a):o>3?r(e,i,a):r(e,i))||a);return o>3&&a&&Object.defineProperty(e,i,a),a},c=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.pageUrl="",e.visible=!1,e.iframePlaceholder="请输入IFrame URL（仅支持http协议，不支持https协议）",e}return s(e,t),e.prototype.onInitDataChange=function(t){t&&(this.pageUrl=t.content)},e.prototype.mounted=function(){window.HOST.startsWith("https")&&(this.iframePlaceholder="请输入IFrame URL（仅支持https协议，不支持http协议）")},e.prototype.show=function(){this.visible=!0},e.prototype.close=function(){this.visible=!1},e.prototype.changePageUrl=function(t){this.pageUrl=t},e.prototype.dragEagle=function(t){var e=this.$refs["iframe-editor"].offsetHeight,i=t.clientY,n=this;document.onmousemove=function(t){t.preventDefault();var r=Math.abs(t.clientY-i);t.clientY>i&&(n.detail.height=e+r+"px"),t.clientY<i&&(n.detail.height=e-r+"px"),parseInt(n.detail.height)>=1e3&&(n.detail.height="1000px"),parseInt(n.detail.height)<=400&&(n.detail.height="400px")},document.onmouseup=function(){document.onmousemove=null}},e.prototype.validate=function(t){t.message="请输入正确的url！",t.isEdit=t.isError=!/http[s]{0,1}:\/\/([\w.]+\/?)\S*/.test(t.content)},l([Object(r.d)({type:Object,default:{}})],e.prototype,"detail",void 0),l([Object(r.d)({type:Object,default:{}})],e.prototype,"initData",void 0),l([Object(r.f)("initData",{deep:!0,immediate:!0})],e.prototype,"onInitDataChange",null),e=l([Object(r.a)({components:{},name:"IframeEditor"})],e)}(r.e),u=c,f=i("KHd+"),p=Object(f.a)(u,(function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{ref:"iframe-editor",staticClass:"iframe-editor"},[i("div",{ref:"iframeWraper",staticClass:"iframe-wrapper"},[i("iframe",{style:{height:t.detail.height,width:"100%"},attrs:{src:t.pageUrl,frameborder:"no",border:"0"}})]),t._v(" "),t.detail.isEdit?i("div",{staticClass:"mask"}):t._e(),t._v(" "),t.detail.isEdit?i("bk-input",t._g(t._b({staticClass:"content",attrs:{clearable:!0,placeholder:t.iframePlaceholder}},"bk-input",t.$attrs,!1),t.$listeners)):t._e(),t._v(" "),t.detail.isEdit?i("div",{staticClass:"adjust-height",on:{mousedown:t.dragEagle}}):t._e()],1)}),[],!1,null,"0f263920",null).exports,d=i("pXDs"),h=i("EcEN"),m=i.n(h),g=function(){var t=function(e,i){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])},t(e,i)};return function(e,i){if("function"!=typeof i&&null!==i)throw new TypeError("Class extends value "+String(i)+" is not a constructor or null");function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),y=function(t,e,i,n){var r,o=arguments.length,a=o<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,i,n);else for(var s=t.length-1;s>=0;s--)(r=t[s])&&(a=(o<3?r(a):o>3?r(e,i,a):r(e,i))||a);return o>3&&a&&Object.defineProperty(e,i,a),a},v=function(t,e,i,n){return new(i||(i=Promise))((function(r,o){function a(t){try{l(n.next(t))}catch(t){o(t)}}function s(t){try{l(n.throw(t))}catch(t){o(t)}}function l(t){var e;t.done?r(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,s)}l((n=n.apply(t,e||[])).next())}))},b=function(t,e){var i,n,r,o,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return o={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(o){return function(s){return function(o){if(i)throw new TypeError("Generator is already executing.");for(;a;)try{if(i=1,n&&(r=2&o[0]?n.return:o[0]?n.throw||((r=n.return)&&r.call(n),0):n.next)&&!(r=r.call(n,o[1])).done)return r;switch(n=0,r&&(o=[2&o[0],r.value]),o[0]){case 0:case 1:r=o;break;case 4:return a.label++,{value:o[1],done:!1};case 5:a.label++,n=o[1],o=[0];continue;case 7:o=a.ops.pop(),a.trys.pop();continue;default:if(!(r=a.trys,(r=r.length>0&&r[r.length-1])||6!==o[0]&&2!==o[0])){a=0;continue}if(3===o[0]&&(!r||o[1]>r[0]&&o[1]<r[3])){a.label=o[1];break}if(6===o[0]&&a.label<r[1]){a.label=r[1],r=o;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(o);break}r[2]&&a.ops.pop(),a.trys.pop();continue}o=e.call(t,a)}catch(t){o=[6,t],n=0}finally{i=r=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,s])}}},w=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.targetFiles=[],e}return g(e,t),e.prototype.onDetailChanged=function(t){t.content?this.targetFiles=[{id:m()(),src:t.content}]:this.targetFiles=[]},e.prototype.handleDelete=function(t){var e=this.targetFiles.findIndex((function(e){return e.id===t.id}));-1!==e&&this.targetFiles.splice(e,1),this.detail.content=""},e.prototype.handleMousewheel=function(t){if(this.detail.isEdit){var e=this.$refs.previewImg[0];this.detail.zoomVal+=t.wheelDelta/1200,this.detail.zoomVal>=1||(this.detail.zoomVal=1),this.commonMethos(e)}},e.prototype.commonMethos=function(t){t.style.transform="scale(".concat(this.detail.zoomVal,")"),t.style.transformOrigin="top left",this.detail.width=t.width*this.detail.zoomVal+"px",this.detail.height=t.height*this.detail.zoomVal+"px"},e.prototype.onUpload=function(t){return v(this,void 0,void 0,(function(){var e,i,n,r,o,a;return b(this,(function(s){switch(s.label){case 0:return e=t.target.files[0],i=e.size,n=e.name,i/1024/1024>5?(this.$error("文件不能超过5M,上传失败"),this.clearFile(),[2]):(r=new FormData,o="".concat(m()(),"_").concat(n),r.append("file_name",o),r.append("file",e),[4,this.$api.lore.uploadImage(r)]);case 1:return(a=s.sent()).result?(this.detail.content=a.data,this.detail.images={},this.detail.images[o]=a.data,this.targetFiles=[{id:m()(),src:this.detail.content}],[2]):(this.$error("上传图片失败！"),this.clearFile(),[2])}}))}))},e.prototype.clearFile=function(){this.$refs.uploadInput.value="",this.detail.content="",this.detail.images={},this.targetFiles=[]},e.prototype.validate=function(t){t.isEdit=t.isError=!t.content,t.message="内容不能为空！"},y([Object(r.d)({type:Object,default:function(){return{zoomVal:1,width:"",height:""}}})],e.prototype,"detail",void 0),y([Object(r.f)("detail",{immediate:!0,deep:!0})],e.prototype,"onDetailChanged",null),e=y([Object(r.a)({components:{}})],e)}(r.e),_=w,D=Object(f.a)(_,(function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"picture-editor"},[i("div",{staticClass:"photo-wrapper"},[t.targetFiles.length?i("div",{staticClass:"img-box"},t._l(t.targetFiles,(function(e){return i("div",{key:e.id,staticClass:"img-item"},[i("img",{ref:"previewImg",refInFor:!0,attrs:{src:e.src,alt:"图片加载失败"}}),t._v(" "),t.detail.isEdit?i("bk-icon",{staticClass:"close-icon show-close",attrs:{type:"close-circle"},on:{click:function(i){return t.handleDelete(e)}}}):t._e()],1)})),0):i("div",{staticClass:"add-picture"},[i("div",{staticClass:"selpic"},[i("label",{staticClass:"picadd",attrs:{for:"picadd"}}),t._v(" "),i("input",{ref:"uploadInput",staticClass:"input-file",attrs:{id:"picadd",type:"file",maxlength:"",multiple:!1,accept:"image/*"},on:{change:function(e){return t.onUpload(e)}}})])])])])}),[],!1,null,"771ac51a",null).exports,I=i("iwDU"),k=function(){var t=function(e,i){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])},t(e,i)};return function(e,i){if("function"!=typeof i&&null!==i)throw new TypeError("Class extends value "+String(i)+" is not a constructor or null");function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),O=function(t,e,i,n){var r,o=arguments.length,a=o<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,i,n);else for(var s=t.length-1;s>=0;s--)(r=t[s])&&(a=(o<3?r(a):o>3?r(e,i,a):r(e,i))||a);return o>3&&a&&Object.defineProperty(e,i,a),a},C=function(t,e,i,n){return new(i||(i=Promise))((function(r,o){function a(t){try{l(n.next(t))}catch(t){o(t)}}function s(t){try{l(n.throw(t))}catch(t){o(t)}}function l(t){var e;t.done?r(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,s)}l((n=n.apply(t,e||[])).next())}))},E=function(t,e){var i,n,r,o,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return o={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(o){return function(s){return function(o){if(i)throw new TypeError("Generator is already executing.");for(;a;)try{if(i=1,n&&(r=2&o[0]?n.return:o[0]?n.throw||((r=n.return)&&r.call(n),0):n.next)&&!(r=r.call(n,o[1])).done)return r;switch(n=0,r&&(o=[2&o[0],r.value]),o[0]){case 0:case 1:r=o;break;case 4:return a.label++,{value:o[1],done:!1};case 5:a.label++,n=o[1],o=[0];continue;case 7:o=a.ops.pop(),a.trys.pop();continue;default:if(!(r=a.trys,(r=r.length>0&&r[r.length-1])||6!==o[0]&&2!==o[0])){a=0;continue}if(3===o[0]&&(!r||o[1]>r[0]&&o[1]<r[3])){a.label=o[1];break}if(6===o[0]&&a.label<r[1]){a.label=r[1],r=o;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(o);break}r[2]&&a.ops.pop(),a.trys.pop();continue}o=e.call(t,a)}catch(t){o=[6,t],n=0}finally{i=r=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,s])}}},j=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.targetFiles=[],e.uploadKey=String(new Date),e}return k(e,t),e.prototype.onDetailChanged=function(t){t.content?this.targetFiles=t.content:this.targetFiles=[]},e.prototype.download=function(t){Object(I.e)(t.link,t.name)},e.prototype.handleDelete=function(t){var e=this.targetFiles.findIndex((function(e){return e.fileName===t.fileName}));-1!==e&&this.targetFiles.splice(e,1),this.detail.content=this.targetFiles},e.prototype.onUpload=function(t){var e=this;t.fileList.forEach((function(t,i){return C(e,void 0,void 0,(function(){var e,i,n,r,o;return E(this,(function(a){switch(a.label){case 0:return t.fileSize?[3,2]:(e=new FormData,i="".concat(m()(),"_").concat(t.origin.name),t.fileName=i,e.append("file",t.origin),e.append("file_name",i),[4,this.$api.lore.uploadImage(e)]);case 1:if(n=a.sent(),r=((null===(o=t.origin)||void 0===o?void 0:o.size)||0)/1024/1024>500,!n.result||r)return this.$error(r?"单个文件不能超过500M,上传失败":"上传图片失败！"),this.uploadKey=String(new Date),[2];t.link=n.data,this.targetFiles.push({link:t.link,fileName:t.fileName,name:t.name,fileSize:t.fileSize||this.getOriginSize(t)}),a.label=2;case 2:return[2]}}))}))})),this.detail.content=this.targetFiles},e.prototype.getOriginSize=function(t){var e=1e3*t.size/1024,i=e>=1024,n=i?(e/1024).toFixed(2):e.toFixed(2);return"（".concat(n).concat(i?"MB":"KB","）")},e.prototype.validate=function(t){var e;t.isEdit=t.isError=!(null===(e=t.content)||void 0===e?void 0:e.length),t.message="内容不能为空！"},O([Object(r.d)({type:Object,default:function(){return{}}})],e.prototype,"detail",void 0),O([Object(r.f)("detail",{immediate:!0,deep:!0})],e.prototype,"onDetailChanged",null),e=O([Object(r.a)({components:{}})],e)}(r.e),x=j,$=Object(f.a)(x,(function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"file-editor"},[t.detail.isEdit?i("div",{staticClass:"upload-wrapper"},[i("bk-upload",{key:t.uploadKey,ref:"uploadFiles",attrs:{"with-credentials":!0,"custom-request":t.onUpload,files:t.targetFiles,url:"",multiple:!0,"ext-cls":"upload-sec",size:102400,tip:""}})],1):t._e(),t._v(" "),i("ul",{staticClass:"file-list"},t._l(t.targetFiles,(function(e){return i("li",{key:e.fileName,staticClass:"file-item"},[i("i",{staticClass:"cw-icon weops-link link-icon"}),t._v(" "),i("span",{staticClass:"file",on:{click:function(i){return t.download(e)}}},[t._v(t._s(""+e.name+e.fileSize))]),t._v(" "),t.detail.isEdit?i("bk-button",{attrs:{text:""},on:{click:function(i){return t.handleDelete(e)}}},[t._v("\n                删除\n            ")]):t._e()],1)})),0)])}),[],!1,null,"8604d61c",null).exports,F=function(){var t=function(e,i){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])},t(e,i)};return function(e,i){if("function"!=typeof i&&null!==i)throw new TypeError("Class extends value "+String(i)+" is not a constructor or null");function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),L=function(t,e,i,n){var r,o=arguments.length,a=o<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,i,n);else for(var s=t.length-1;s>=0;s--)(r=t[s])&&(a=(o<3?r(a):o>3?r(e,i,a):r(e,i))||a);return o>3&&a&&Object.defineProperty(e,i,a),a},P=function(t,e,i,n){return new(i||(i=Promise))((function(r,o){function a(t){try{l(n.next(t))}catch(t){o(t)}}function s(t){try{l(n.throw(t))}catch(t){o(t)}}function l(t){var e;t.done?r(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,s)}l((n=n.apply(t,e||[])).next())}))},T=function(t,e){var i,n,r,o,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return o={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(o){return function(s){return function(o){if(i)throw new TypeError("Generator is already executing.");for(;a;)try{if(i=1,n&&(r=2&o[0]?n.return:o[0]?n.throw||((r=n.return)&&r.call(n),0):n.next)&&!(r=r.call(n,o[1])).done)return r;switch(n=0,r&&(o=[2&o[0],r.value]),o[0]){case 0:case 1:r=o;break;case 4:return a.label++,{value:o[1],done:!1};case 5:a.label++,n=o[1],o=[0];continue;case 7:o=a.ops.pop(),a.trys.pop();continue;default:if(!(r=a.trys,(r=r.length>0&&r[r.length-1])||6!==o[0]&&2!==o[0])){a=0;continue}if(3===o[0]&&(!r||o[1]>r[0]&&o[1]<r[3])){a.label=o[1];break}if(6===o[0]&&a.label<r[1]){a.label=r[1],r=o;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(o);break}r[2]&&a.ops.pop(),a.trys.pop();continue}o=e.call(t,a)}catch(t){o=[6,t],n=0}finally{i=r=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,s])}}},A=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.visible=!1,e.formData={template_name:"",imgData:null},e.type="",e.row={},e.targetFiles=[],e.newKeys=[],e.canGoBack=!1,e.rules={template_name:[{required:!0,message:"请输入模板名称",trigger:"blur"}]},e}return F(e,t),e.prototype.handleConfirm=function(t){return t},e.prototype.beforeDestroy=function(){this.canGoBack?this.deleteImages(this.canGoBack):this.deleteImages()},e.prototype.show=function(t,e){return P(this,void 0,void 0,(function(){var i,n;return T(this,(function(r){switch(r.label){case 0:return this.newKeys=e.template_img?[e.template_img]:[],this.type=t,this.row=e,this.row.fileKey=e.template_img,(i={images:[]}).template=!0,e.template_img&&i.images.push(e.template_img),this.visible=!0,this.formData.template_name=e.template_name||"",[4,this.$api.lore.getImages(i)];case 1:return n=r.sent(),e.template_img&&(this.targetFiles=[{src:n.data[e.template_img],id:m()(),file_name:e.template_img}]),[2]}}))}))},e.prototype.close=function(){this.visible=!1,this.deleteImages(),this.row.template_img=this.row.fileKey||""},e.prototype.deleteImages=function(t){return P(this,void 0,void 0,(function(){var e,i,n,r=this;return T(this,(function(o){switch(o.label){case 0:return e=this.newKeys,i=this.row.fileKey?[this.row.fileKey]:[],n={images:[],template:!0},t?n.images=e.length?e.filter((function(t){var e;return t!==((null===(e=r.targetFiles[0])||void 0===e?void 0:e.file_name)||"")})):[]:e.forEach((function(t){i.includes(t)||n.images.push(t)})),n.images.length?[4,this.$api.lore.deleteImages(n)]:[2];case 1:return o.sent(),[2]}}))}))},e.prototype.confirm=function(){var t=this;this.row.template_name=this.formData.template_name,this.$refs.validateForm.validate().then((function(e){t.targetFiles.length?(t.row.template_img=t.targetFiles[0].src,t.formData.imgData=t.targetFiles):(t.formData.imgData=[],t.row.template_img=""),t.visible=!1,t.canGoBack=!0,t.handleConfirm(t.formData)}))},e.prototype.handleUpload=function(t){return P(this,void 0,void 0,(function(){var e,i,n,r,o=this;return T(this,(function(a){switch(a.label){case 0:return t.fileList.forEach((function(e){e.id=m()(),1e3*e.size/1024/1024>5&&(o.$error("文件不能超过5M,上传失败"),t.fileList=[])})),this.targetFiles=t.fileList,this.targetFiles.length?(e=new FormData,i=this.targetFiles[0],n="".concat(m()(),"_").concat(i.name),i.file_name=n,e.append("file",i.origin),e.append("file_name",n),e.append("template",!0),[4,this.$api.lore.uploadImage(e)]):[2];case 1:return(r=a.sent()).result?(i.src=r.data,this.newKeys.push(n),this.$set(this.targetFiles,0,i),[2]):(this.$error("上传图片失败"),this.targetFiles=[],[2])}}))}))},e.prototype.handleDelete=function(t){var e=this.targetFiles.findIndex((function(e){return e.id===t.id}));-1!==e&&this.targetFiles.splice(e,1)},e.prototype.getTemplate=function(){return this.formData.template_name},L([Object(r.b)("confirm")],e.prototype,"handleConfirm",null),e=L([Object(r.a)({components:{}})],e)}(r.e),S=A,K=Object(f.a)(S,(function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"save-template"},[i("bk-dialog",{attrs:{"render-directive":"if","mask-close":!1,"header-position":"left",width:"500px",title:"保存模板"},on:{cancel:t.close},model:{value:t.visible,callback:function(e){t.visible=e},expression:"visible"}},[i("div",[i("bk-form",{ref:"validateForm",attrs:{"label-width":100,model:t.formData,rules:t.rules,"ext-cls":"save-template-form"}},[i("bk-form-item",{attrs:{label:"模板名称：",required:"",property:"template_name"}},[i("bk-input",{attrs:{placeholder:"请输入模板名称",clearable:""},model:{value:t.formData.template_name,callback:function(e){t.$set(t.formData,"template_name",e)},expression:"formData.template_name"}})],1),t._v(" "),i("bk-form-item",{attrs:{label:"模板图标："}},[i("bk-upload",{attrs:{theme:"button","ext-cls":"upload-sec",tip:"最大上传5(Mb)的图片","with-credentials":!0,url:"0",multiple:!1,size:10,limit:1,"custom-request":t.handleUpload,accept:"image/png,image/jpeg,image/jpg"}}),t._v(" "),t.targetFiles.length?i("ul",{staticClass:"photo-list"},t._l(t.targetFiles,(function(e){return i("li",{key:e.id},[i("img",{attrs:{src:e.src,alt:""}}),t._v(" "),i("bk-icon",{staticClass:"close-icon show-close",attrs:{type:"close-circle"},on:{click:function(i){return t.handleDelete(e)}}})],1)})),0):t._e()],1)],1)],1),t._v(" "),i("div",{staticStyle:{width:"100%"},attrs:{slot:"footer"},slot:"footer"},[i("div",[i("bk-button",{staticClass:"mr20",attrs:{theme:"primary"},on:{click:t.confirm}},[t._v("\n                    确定\n                ")]),t._v(" "),i("bk-button",{attrs:{theme:"default"},on:{click:t.close}},[t._v("\n                    取消\n                ")])],1)])])],1)}),[],!1,null,null,null).exports,z=i("ToxV"),N=i("L2JU"),M=function(){var t=function(e,i){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])},t(e,i)};return function(e,i){if("function"!=typeof i&&null!==i)throw new TypeError("Class extends value "+String(i)+" is not a constructor or null");function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),R=function(){return R=Object.assign||function(t){for(var e,i=1,n=arguments.length;i<n;i++)for(var r in e=arguments[i])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t},R.apply(this,arguments)},B=function(t,e,i,n){var r,o=arguments.length,a=o<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,i,n);else for(var s=t.length-1;s>=0;s--)(r=t[s])&&(a=(o<3?r(a):o>3?r(e,i,a):r(e,i))||a);return o>3&&a&&Object.defineProperty(e,i,a),a},U=function(t,e,i,n){return new(i||(i=Promise))((function(r,o){function a(t){try{l(n.next(t))}catch(t){o(t)}}function s(t){try{l(n.throw(t))}catch(t){o(t)}}function l(t){var e;t.done?r(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,s)}l((n=n.apply(t,e||[])).next())}))},G=function(t,e){var i,n,r,o,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return o={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(o){return function(s){return function(o){if(i)throw new TypeError("Generator is already executing.");for(;a;)try{if(i=1,n&&(r=2&o[0]?n.return:o[0]?n.throw||((r=n.return)&&r.call(n),0):n.next)&&!(r=r.call(n,o[1])).done)return r;switch(n=0,r&&(o=[2&o[0],r.value]),o[0]){case 0:case 1:r=o;break;case 4:return a.label++,{value:o[1],done:!1};case 5:a.label++,n=o[1],o=[0];continue;case 7:o=a.ops.pop(),a.trys.pop();continue;default:if(!(r=a.trys,(r=r.length>0&&r[r.length-1])||6!==o[0]&&2!==o[0])){a=0;continue}if(3===o[0]&&(!r||o[1]>r[0]&&o[1]<r[3])){a.label=o[1];break}if(6===o[0]&&a.label<r[1]){a.label=r[1],r=o;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(o);break}r[2]&&a.ops.pop(),a.trys.pop();continue}o=e.call(t,a)}catch(t){o=[6,t],n=0}finally{i=r=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,s])}}},q=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.menuList=[{type:"markDown",name:"MarkDown",id:3,isEdit:!0,mdConfigs:{editable:!0,autofocus:!1,subfield:!0,toolbarsFlag:!0},content:"",height:"",images:{},icon:"weops-markdown"},{type:"iframe",name:"嵌入页面",id:4,isEdit:!0,mdConfigs:{},content:"",height:"400px",icon:"weops-code-fill"},{type:"photo",name:"图片",id:6,isEdit:!0,mdConfigs:{},content:"",height:"100px",width:"100px",zoomVal:1,images:{},icon:"weops-image-fill"},{type:"file",name:"文件",id:7,isEdit:!0,mdConfigs:{},content:[],height:"",images:{},icon:"weops-log-fill"}],e.contentList=[],e.dragOptions={forceFallback:!0,animation:0,sort:!1},e.loading=!1,e.templateInfo={},e.tags=[],e.templateId="",e.origin="",e.showError=!1,e.showTitleEdit=!1,e.formData={title:""},e.rules={title:[{required:!0,message:"请输文章标题!",trigger:"blur"}]},e.initData={},e.tempalteName="",e.canGoBack=!1,e.isDeltePhoto=!0,e.mdPreviewConfigs={toolbarsFlag:!1,boxShadow:!1,subfield:!1,previewBackground:"#ffffff",defaultOpen:"preview",transition:!1},e.timer=null,e.imageKeys={},e.allImageInfo={},e.baseId="",e.isAddDraft=!1,e}return M(e,t),Object.defineProperty(e.prototype,"isArticle",{get:function(){return"lore"===this.origin},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"canDrag",{get:function(){return this.contentList.every((function(t){return!t.isEdit}))},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"permissionObj",{get:function(){return{id:this.isArticle?"lore":"loreManage",type:this.isArticle?"manageAllArticlesAuth":"operateAuth",secondAuth:this.isArticle?"manageMyArticlesAuth":""}},enumerable:!1,configurable:!0}),e.prototype.created=function(){var t=this.$route.meta.canGoBack;this.origin=null==t?void 0:t.name,this.getDetail()},e.prototype.beforeDestroy=function(){this.clearTimer()},e.prototype.clearTimer=function(){this.timer&&clearInterval(this.timer)},e.prototype.saveDraft=function(t){this.handleConfirm({template_name:this.formData.title},{isDraft:!0,isConfirm:t})},e.prototype.getDetail=function(t){return U(this,void 0,void 0,(function(){var e,i,n,r,o;return G(this,(function(a){switch(a.label){case 0:if(e=this.$route.query.articleId,i=this.$route.query.id,n=i&&!t?"getTemplateDetial":"getArticleDetial",r=t||e||i,this.templateId=i,!r)return[3,6];this.loading=!t,a.label=1;case 1:return a.trys.push([1,,4,5]),[4,this.$api.lore[n]({id:r})];case 2:return(o=a.sent()).result?[4,this.initArticleDetial(o.data)]:(this.$error(o.message),[2]);case 3:return a.sent(),[3,5];case 4:return this.loading=!1,[7];case 5:return[3,7];case 6:i||(this.showTitleEdit=!0),a.label=7;case 7:return[2]}}))}))},e.prototype.initArticleDetial=function(t){return U(this,void 0,void 0,(function(){var e,i,n=this;return G(this,(function(r){switch(r.label){case 0:return[4,this.$api.lore.getImages({images:this.getImageIdsOrMarkDownLists(t)})];case 1:return(e=r.sent()).result?(this.imageKeys=e.data,this.contentList=this.getImageIdsOrMarkDownLists(t,this.imageKeys),this.contentList.forEach((function(e){if("photo"===e.type){var i=t.images[e.id];e.content=n.imageKeys[i]}"file"===e.type&&e.content.forEach((function(t){t.link=n.imageKeys[t.fileName]}))})),this.templateInfo=t,this.tags=this.templateInfo.labels,this.templateInfo.body=this.contentList,this.tempalteName=this.templateInfo.template_name||"",this.initData=this.$copy(this.templateInfo),this.updateKnowledgeList(this.contentList),this.formData.title=this.templateInfo.title,this.showTitleEdit=!this.formData.title,i=this.$route.query.draftId,this.isAddDraft=i?!i:!this.templateInfo.drafts,this.baseId=i||this.templateInfo.drafts,this.clearTimer(),this.isArticle&&(this.timer=setInterval((function(){n.compareDataChanged()||n.saveDraft(!1)}),3e5)),[2]):(this.$error(e.message),[2])}}))}))},e.prototype.getImageIdsOrMarkDownLists=function(t,e,i){var n=this,r=this.$copy(t),o=r.body||r,a=r.body?o.reduce((function(e,i){var n,r;return"photo"===i.type&&(null===(n=t.images)||void 0===n?void 0:n[i.id])&&e.push(t.images[i.id]),"file"===i.type&&(null===(r=i.content)||void 0===r?void 0:r.length)&&e.push.apply(e,i.content.map((function(t){return t.fileName}))),e}),[]):[];return o.forEach((function(t){if("markDown"===t.type){var r=t.content.replace(/\!\[.*\]\((.*?)\).*/gi,(function(t,r){return a.push(r),i?"![image.png](".concat(n.getObjectKey(n.allImageInfo,r)||r,")"):e?"![image.png](".concat(e[r]||r,")"):t}));t.content=r.replace(/<img [^>]*src=['"]([^'"]+)[^>]*>/gi,(function(t,r){return a.push(r),i?'<img src="'.concat(n.getObjectKey(n.allImageInfo,r)||r,'" style="" />'):e?'<img src="'.concat(e[r]||r,'" style="" />'):t}))}})),e?o:a},e.prototype.deletePhotos=function(t){return U(this,void 0,void 0,(function(){var e,i,n,r,o,a=this;return G(this,(function(s){switch(s.label){case 0:return e=Object.keys(this.imageKeys),i=[],this.contentList.forEach((function(t){var e;"photo"===t.type&&t.images&&i.push.apply(i,Object.keys(t.images)),"file"===t.type&&(null===(e=t.content)||void 0===e?void 0:e.length)&&i.push.apply(i,t.content.map((function(t){return t.fileName})))})),n=this.getImageIdsOrMarkDownLists(this.contentList),this.allImageInfo=this.$copy(this.imageKeys),Object.assign(this.allImageInfo,this.getCurrentImgInfo()),n.forEach((function(t){var e=a.getObjectKey(a.allImageInfo,t);e&&i.push(e)})),r={images:[]},o=t?i:e,(t?e:i).forEach((function(t){o.includes(t)||r.images.push(t)})),r.images.length?[4,this.$api.lore.deleteImages(r)]:[2];case 1:return s.sent(),[2]}}))}))},e.prototype.getCurrentImgInfo=function(){var t={};return this.contentList.forEach((function(e){e.images instanceof Object&&Object.assign(t,e.images)})),t},e.prototype.getObjectKey=function(t,e){return Object.keys(t).find((function(i){return t[i]===e}))},e.prototype.showTitle=function(){var t=this;this.showTitleEdit=!0,this.$nextTick((function(){var e;null===(e=t.$refs.titleInput)||void 0===e||e.focus()}))},e.prototype.handleBur=function(){this.formData.title&&(this.showTitleEdit=!1)},e.prototype.getIniTData=function(t){var e=this.knowledgeList.find((function(e){return e.id===t.id})),i=this.$copy(t);return i.content="",e||i},e.prototype.saveTemplate=function(){var t;return U(this,void 0,void 0,(function(){var e;return G(this,(function(i){switch(i.label){case 0:if(!this.$BtnPermission(this.permissionObj))return[2];if(!this.isArticle)return[3,5];i.label=1;case 1:return i.trys.push([1,3,,4]),[4,null===(t=this.$refs.validateForm)||void 0===t?void 0:t.validate()];case 2:return!i.sent()&&this.handleConfirm({template_name:this.formData.title}),[3,4];case 3:return e=i.sent(),console.log(e),[3,4];case 4:return[2];case 5:return this.$refs.saveTemplate.show("edit",this.templateInfo),[2]}}))}))},e.prototype.validateCurrent=function(t,e){this.$refs["".concat(t.type).concat(e)][0].validate(t),this.showError=!0},e.prototype.editorValidate=function(){var t=this;return new Promise((function(e,i){t.contentList.forEach((function(e,i){t.validateCurrent(e,i),t.$set(t.contentList,i,e)}));var n=t.contentList.some((function(t){return t.isError}));if(n)for(var r=0;r<t.contentList.length;r++)if(t.contentList[r].isError)return t.$refs.showError[r].scrollIntoView({behavior:"smooth"}),void i(t.contentList[r]);e({result:!n})}))},e.prototype.confirm=function(t){return U(this,void 0,void 0,(function(){return G(this,(function(e){return this.handleConfirm(t),[2]}))}))},e.prototype.getCommonParams=function(){var t={};t.labels=this.$refs.addTag.getLabelIds();var e=this.contentList.reduce((function(t,e){if("photo"===e.type){var i={};i[e.id]=Object.keys(e.images)[0],Object.assign(t,i)}return t}),{});t.images=e,t.title=this.formData.title,this.allImageInfo=this.$copy(this.imageKeys),Object.assign(this.allImageInfo,this.getCurrentImgInfo());var i=this.getImageIdsOrMarkDownLists(this.contentList,this.allImageInfo,!0);i.forEach((function(t){"markDown"===t.type&&(t.images={})})),t.body=i;var n=this.$copy(this.contentList);n.forEach((function(t){if("markDown"===t.type){var e=t.content.replace(/\!\[.*\]\((.*?)\).*/gi,(function(t,e){return""}));t.content=e.replace(/<img [^>]*src=['"]([^'"]+)[^>]*>/gi,(function(t,e){return""}))}}));var r=n.reduce((function(t,e){return t+("markDown"===e.type?e.content:"")}),"");return t.content=r,t},e.prototype.handleConfirm=function(t,e){return U(this,void 0,void 0,(function(){return G(this,(function(i){switch(i.label){case 0:return e?[3,2]:[4,this.editorValidate()];case 1:if(!i.sent().result)return[2];i.label=2;case 2:return this.isArticle?(this.confirmArticle(e),[2]):(this.confirmTemplate(t,e),[2])}}))}))},e.prototype.confirmTemplate=function(t){var e,i=t.template_name,n=t.imgData,r=this.getCommonParams();delete r.content;var o={};r.template_name=i,r.template_img=(null===(e=n[0])||void 0===e?void 0:e.file_name)||"",this.templateId&&(r.id=this.templateId,o.id=this.templateId),this.createOrEdit(r,"template",o)},e.prototype.confirmArticle=function(t){var e=this.getCommonParams(),i={},n=this.$route.query,r=n.id,o=n.articleId;i.draftInfo=t,r?(e.template_id=r,t&&(e.base_id=0),this.isAddDraft=!0,this.baseId&&(i.id=this.baseId,e.base_id=this.baseId,this.isAddDraft=!1)):(i.id=this.isAddDraft?o:this.baseId,e.drafts=!1,t&&(e.drafts=!0,e.base_id=o)),this.createOrEdit(e,t?"draft":"article",i)},e.prototype.createOrEdit=function(t,e,i){var n,r;return U(this,void 0,void 0,(function(){var o,a,s,l,c;return G(this,(function(u){switch(u.label){case 0:o=!i.draftInfo||(null===(n=i.draftInfo)||void 0===n?void 0:n.isConfirm),this.loading=o,a=this.$route.query.articleId,s=this.templateId?"editTemplate":"createTemplate","article"===e&&(s=a?"editArticle":"createArticle"),"draft"===e&&(s="editArticle",this.isAddDraft&&(s="createDrafts")),u.label=1;case 1:return u.trys.push([1,,7,8]),(l=this.$copy(t)).body.forEach((function(t){t.isEdit=!1,"markDown"===t.type&&(t.mdConfigs.editable=!1)})),[4,this.$api.lore[s](l,i)];case 2:return(c=u.sent()).result?(this.baseId=c.data,this.isAddDraft=!1,this.isDeltePhoto=!i.draftInfo,i.draftInfo?[3,3]:(this.canGoBack=!0,this.$success(this.isArticle?"发布成功":"保存成功"),this.$router.go(-1),[3,6])):(this.$error(c.message),[2]);case 3:return this.$router.replace({name:"AticleOperation",query:{articleId:a||this.baseId,subName:this.formData.title,draftId:this.baseId}}),(null===(r=i.draftInfo)||void 0===r?void 0:r.isConfirm)?(this.$success("保存成功"),[4,this.getDetail(this.baseId)]):[3,5];case 4:return u.sent(),[2];case 5:this.$success("为防止内容丢失，已自动保存草稿"),u.label=6;case 6:return[3,8];case 7:return this.loading=!1,[7];case 8:return[2]}}))}))},e.prototype.handleCopy=function(t,e){var i=m()(),n=this.$copy(t);n.id=i,this.contentList.splice(e,0,n)},e.prototype.handleEdit=function(t,e){t.isEdit=!0,"iframe"!==t.type&&(t.mdConfigs.editable=!0,t.mdConfigs.subfield=!0,t.mdConfigs.toolbarsFlag=!0)},e.prototype.cancelEdit=function(t,e){return U(this,void 0,void 0,(function(){var i;return G(this,(function(n){return(i=this.knowledgeList.find((function(e){return e.id===t.id})))?(t.content=i.content,t.images=i.images):this.contentList.splice(e,1),this.updateKnowledgeList(this.contentList),this.validateCurrent(t,e),[2]}))}))},e.prototype.finishEidt=function(t,e){t.isEdit=!1,"iframe"===t.type&&this.$refs["".concat(t.type).concat(e)][0].changePageUrl(t.content),this.validateCurrent(t,e),t.isError||this.updateKnowledgeList(this.contentList)},e.prototype.onMove=function(t,e){return this.canDrag},e.prototype.handleMoved=function(t){if(t.added){var e=t.added.element,i=this.contentList.findIndex((function(t){return t.id===e.id})),n=JSON.parse(JSON.stringify(this.contentList));n[i].id=m()(),this.contentList=n}},e.prototype.deleteItem=function(t){this.contentList.splice(t,1)},e.prototype.compareDataChanged=function(){var t=JSON.stringify(this.contentList)+JSON.stringify(this.tags)+this.formData.title+this.tempalteName,e=this.initData,i=e.labels,n=e.body,r=e.template_name,o=e.template_repository_name,a=e.title,s=n;return t===JSON.stringify(s||[])+JSON.stringify(i||[])+(o||a||"")+(r||"")},e=B([Object(r.a)({components:{Draggable:a.a,IframeEditor:p,MarkDownEditor:d.a,SaveTemplateDialog:K,AddTag:z.a,PhotoEditor:D,FileEditor:$},computed:R({},Object(N.mapState)("knowledge",{knowledgeList:"knowledgeList"})),methods:R({},Object(N.mapActions)("knowledge",{updateKnowledgeList:"updateKnowledgeList"})),beforeRouteLeave:function(t,e,i){var n=this,r=this.compareDataChanged();if(this.canGoBack||r)return this.isDeltePhoto&&this.deletePhotos(this.canGoBack||r),void i();this.$bkInfo({title:"确认离开当前页面",subTitle:"离开将导致未保存信息丢失",theme:"primary",confirmFn:function(){n.isDeltePhoto&&n.deletePhotos(),i()},cancelFn:function(){n.$bus.$emit("refreshNav",e)}})}})],e)}(r.e),V=q,J=Object(f.a)(V,(function(){var t=this,e=t.$createElement,n=t._self._c||e;return n("div",{directives:[{name:"bkloading",rawName:"v-bkloading",value:{isLoading:t.loading,zIndex:10},expression:"{ isLoading: loading, zIndex: 10 }"}],staticClass:"article-template"},[n("div",{staticClass:"article-template-top"},[n("bk-button",{directives:[{name:"permission",rawName:"v-permission",value:t.permissionObj,expression:"permissionObj"}],staticClass:"mr10 mb10",attrs:{theme:"primary"},on:{click:t.saveTemplate}},[t._v("\n            "+t._s(t.isArticle?"发布文章":"保存模板")+"\n        ")]),t._v(" "),t.isArticle?n("bk-button",{directives:[{name:"permission",rawName:"v-permission",value:t.permissionObj,expression:"permissionObj"}],staticClass:"mr10 mb10",on:{click:function(e){return t.saveDraft(!0)}}},[t._v("\n            保存草稿\n        ")]):t._e(),t._v(" "),n("AddTag",{ref:"addTag",attrs:{tags:t.tags}})],1),t._v(" "),n("div",{staticClass:"article-template-menu"},[n("Draggable",t._b({staticClass:"list-group",attrs:{list:t.menuList,group:{name:"comp",pull:"clone",put:!1},"chosen-class":"chosen",move:t.onMove}},"Draggable",t.dragOptions,!1),t._l(t.menuList,(function(e){return n("div",{key:e.id,staticClass:"list-group-item"},[n("i",{class:["cw-icon",e.icon]}),t._v(" "),n("span",[t._v(t._s(e.name))]),t._v(" "),n("img",{staticClass:"move-tip",attrs:{src:i("XtNy")}})])})),0)],1),t._v(" "),n("div",{ref:"canvasImgObj",staticClass:"article-template-content"},[n("div",{staticClass:"article-title"},[!t.showTitleEdit&&t.formData.title?n("div",{on:{click:t.showTitle}},[t._v("\n                "+t._s(t.formData.title)+"\n            ")]):t.showTitleEdit||!t.formData.title?n("bk-form",{ref:"validateForm",staticStyle:{width:"100%"},attrs:{"label-width":0,model:t.formData,rules:t.isArticle?t.rules:{},"ext-cls":"save-template-form"}},[n("bk-form-item",{attrs:{required:t.isArticle,property:"title","error-display-type":"normal"}},[n("bk-input",{ref:"titleInput",staticClass:"article-title-input",attrs:{placeholder:"请输入文章名称，最多255个字符",clearable:!1,behavior:"simplicity"},on:{blur:t.handleBur},model:{value:t.formData.title,callback:function(e){t.$set(t.formData,"title",e)},expression:"formData.title"}})],1)],1):t._e()],1),t._v(" "),n("Draggable",{staticClass:"drag-content",attrs:{list:t.contentList,group:"comp",sort:!0,"ghost-class":"drag-content-chosen",draggable:".can-drag"},on:{change:t.handleMoved}},t._l(t.contentList,(function(e,i){return n("div",{key:i+"item",class:["drag-content-item",t.canDrag&&"can-drag"]},[n("div",{ref:"showError",refInFor:!0,class:[t.canDrag&&"content",t.showError&&e.isError&&"error"]},[n("div",{class:[e.isEdit&&"edit-show","operation-area-hide",t.canDrag&&"operation-area-show"]},[e.isEdit?n("div",{staticClass:"operation-btn"},[n("bk-button",{staticClass:"mr10",attrs:{theme:"primary",size:"small"},on:{click:function(n){return t.finishEidt(e,i)}}},[t._v("\n                                完成\n                            ")]),t._v(" "),n("bk-button",{attrs:{size:"small"},on:{click:function(n){return t.cancelEdit(e,i)}}},[t._v("撤消")])],1):n("div",{staticClass:"operation-btn"},[n("bk-button",{attrs:{text:"",theme:"primary",icon:"edit",size:"small"},on:{click:function(n){return t.handleEdit(e,i)}}}),t._v(" "),"photo"!==e.type?n("bk-button",{attrs:{text:"",icon:"clipboard",size:"small"},on:{click:function(n){return t.handleCopy(e,i)}}}):t._e(),t._v(" "),n("bk-button",{attrs:{text:"",icon:"close3-shape",size:"small"},on:{click:function(e){return t.deleteItem(i)}}})],1)]),t._v(" "),n("div",{staticClass:"editor"},[n(e.type+"Editor",{ref:""+e.type+i,refInFor:!0,tag:"component",attrs:{detail:e,"is-preview":!e.mdConfigs.editable,"init-data":t.getIniTData(e),configs:e.mdConfigs.editable?e.mdConfigs:t.mdPreviewConfigs},model:{value:e.content,callback:function(i){t.$set(e,"content",i)},expression:"element.content"}})],1)]),t._v(" "),t.showError&&e.isError?n("div",{staticClass:"tip"},[t._v(t._s(e.message))]):t._e()])})),0)],1),t._v(" "),n("SaveTemplateDialog",{ref:"saveTemplate",attrs:{origin:t.origin},on:{confirm:t.confirm}})],1)}),[],!1,null,"2c491033",null);e.default=J.exports},XtNy:function(t,e,i){t.exports=i.p+"static/dist/weOps/img/down_drop.83d7f5c.webp"}}]);