(window.webpackJsonp=window.webpackJsonp||[]).push([[15],{h34u:function(e,t,n){e.exports=n.p+"static/dist/weOps/img/sla.c9852e0.png"},jQwD:function(e,t){tinymce.PluginManager.add("formatpainter",(function(e,t){var n="",i="",o=!1,a=!1,s=!1,r=!1,c=!1,l=!1,d=!1,u=!1,f=!1;function p(){var t=e.dom;if(!1===f){var p=e.selection.getRng().startContainer;for(n="",i="",o=!1,a=!1,s="";;){if("P"===(p=p.parentNode).nodeName){n=t.getAttrib(p,"style");break}if("SPAN"===p.nodeName&&(i=t.getAttrib(p,"style")),"EM"===p.nodeName&&(a=!0),"STRONG"===p.nodeName&&(o=!0),"H1"===p.nodeName){s=!0;break}if("H2"===p.nodeName){r=!0;break}if("H3"===p.nodeName){c=!0;break}if("H4"===p.nodeName){l=!0;break}if("H5"===p.nodeName){d=!0;break}if("H6"===p.nodeName){u=!0;break}}}f=!f}return e.ui.registry.addIcon("brushes",'<svg t="1614665382680" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1129" width="19" height="19"><path d="M960 448H512v192h32v320a64 64 0 1 1-128 0V640h32v-192a64 64 0 0 1 64-64h448V192h-64V128h64a64 64 0 0 1 64 64v192a64 64 0 0 1-64 64zM64 192H32a32 32 0 1 1 0-64h32V0h832v320H64V192z m64 64h704V64H128v192z" p-id="1130"></path></svg>'),e.ui.registry.addButton("formatpainter",{icon:"brushes",onAction:p}),e.ui.registry.addToggleButton("formatpainter",{icon:"brushes",tooltip:"格式刷(Beta)",onAction:p,onSetup:function(t){var p=function(){var t,p,h=e.selection.getRng(),m=function(e){return console.log(s),o&&(e="<strong>"+e+"</stong>"),a&&(e="<em>"+e+"</em>"),i&&(e="<span style='"+i+"'>"+e+"</span>"),s&&(e="<h1>"+e+"</h1>"),r&&(e="<h2>"+e+"</h2>"),c&&(e="<h3>"+e+"</h3>"),l&&(e="<h4>"+e+"</h4>"),d&&(e="<h5>"+e+"</h5>"),u&&(e="<h6>"+e+"</h6>"),console.log(e),e};if(!0===f){for(var v=e.selection.getSelectedBlocks(),g=0;g<v.length;g++)if(e.dom.setAttrib(v[g],"style",n),0===g)if(h.startContainer===h.endContainer)p=e.selection.getContent({format:"text"}),e.selection.setContent(m(p));else{t=h.cloneRange();for(var y=h.startContainer;;){var b=e.dom.getNext(y,(function(e){return!0}));if(!e.dom.isChildOf(b,v[g]))break;y=b}t.setEnd(y,y.length),e.selection.setRng(t),p=e.selection.getContent({format:"text"}),e.selection.setContent(m(p)),e.selection.setRng(h)}else if(v.length-1===g&&v.length>1){t=h.cloneRange();for(var w=h.endContainer;;){var k=e.dom.getPrev(w,(function(e){return!0}));if(!e.dom.isChildOf(k,v[g]))break;w=k}t.setStart(w,0),e.selection.setRng(t),p=e.selection.getContent({format:"text"}),e.selection.setContent(m(p)),e.selection.setRng(h)}else p=v[g].innerHTML.replace(/(<([^>]+)>)/gi,""),v[g].innerHTML=m(p);f=!1,n="",i="",o=!1,a=!1}};return t.setActive(f),e.on("mouseup",p),function(){e.off("mouseup",p)}}}),{getMetadata:function(){return{name:"formatpainter"}}}}))},lYgw:function(e,t,n){"use strict";n.r(t);var i,o=n("G0B5"),a=n("ac6i"),s=n("uMZD"),r=n("qz1i"),c=n("JnIg"),l=(i=function(e,t){return i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},i(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function n(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),d=function(e,t,n,i){var o,a=arguments.length,s=a<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,n,i);else for(var r=e.length-1;r>=0;r--)(o=e[r])&&(s=(a<3?o(s):a>3?o(t,n,s):o(t,n))||s);return a>3&&s&&Object.defineProperty(t,n,s),s},u=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.isShow=!1,t.type="",t.viewAgreementIsShow=!1,t.formData={beginNode:"",endNode:"",serviceAgreement:"",color:"#64CFC2",realityActive:!1,isReTimeSla:!1},t.rules={beginNode:[{required:!0,message:"必填项",trigger:"blur"}],endNode:[{required:!0,message:"必填项",trigger:"blur"}],serviceAgreement:[{required:!0,message:"必填项",trigger:"blur"}]},t.serviceAgreementList=[],t.endNodeList=[],t.way="",t.transitionLines={},t.editSlaId="",t}return l(t,e),Object.defineProperty(t.prototype,"isNode",{get:function(){return"node"===this.type},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"isAdd",{get:function(){return"add"===this.way},enumerable:!1,configurable:!0}),t.prototype.show=function(e,t,n){if(this.isShow=!0,this.type=e,this.way=t,this.isAdd)this.formData.color=this.getRandomColor();else if(this.isNode){this.editSlaId=n.id;var i=n.sla;this.formData.color=i.color,this.formData.serviceAgreement=i.sla_id,this.formData.beginNode=i.start_node_id,this.formData.isReTimeSla=i.is_retime_sla,this.formData.realityActive=i.reality_active,this.selectBeginNode(this.formData.beginNode),this.formData.endNode=i.end_node_id}else this.formData.color=n.color,this.formData.serviceAgreement=n.sla_id;this.getSlaList()},t.prototype.selectEndNode=function(){var e=this,t={workflow_version_id:this.processVersion,start_id:this.formData.beginNode,end_id:this.formData.endNode};this.$api.serviceDeskManage.getTransitionLines(t).then((function(t){var n=t.result,i=t.data;if(!n)return!1;e.transitionLines=i}))},t.prototype.getRandomColor=function(){for(var e="#",t=["0","1","2","3","4","5","6","7","8","9","A","B","C","D","E","F"],n=0;n<6;n++)e+=t[parseInt(String(16*Math.random()))];return"#FFFFFF"===e&&(e="#87cb12"),e},t.prototype.selectBeginNode=function(e){var t=this;this.formData.endNode="",this.beginNodeList.forEach((function(n){(n.children||[]).forEach((function(i,o){i.id===e&&(t.endNodeList=n.children.slice(o))}))}))},t.prototype.getSlaList=function(){var e=this;this.$api.serviceDeskManage.getSlaList().then((function(t){var n=t.result,i=t.data;if(!n)return!1;e.serviceAgreementList=i}))},t.prototype.checkAgreement=function(){this.viewAgreementIsShow=!0},t.prototype.confirm=function(){var e=this;this.$refs.validateForm.validate().then((function(){var t={},n=e.serviceAgreementList.find((function(t){return t.id===e.formData.serviceAgreement})).name;if(e.isNode){var i="";e.beginNodeList.forEach((function(t){(t.children||[]).forEach((function(t){t.id===e.formData.beginNode&&(i=t.name)}))}));var o=e.endNodeList.find((function(t){return t.id===e.formData.endNode})).name;t={color:e.formData.color,end_node_id:e.formData.endNode,is_retime_sla:e.formData.isReTimeSla,lines:e.transitionLines.lines,reality_active:e.formData.realityActive,sla_id:e.formData.serviceAgreement,start_node_id:e.formData.beginNode,states:e.transitionLines.states,name:"".concat(i,"-").concat(o,"(").concat(n,")")}}else t={color:e.formData.color,end_node_id:-1,name:"整体流程(".concat(n,")"),sla_id:e.formData.serviceAgreement,start_node_id:-1};var a={type:e.isNode?"node":"all",value:t};a.id="add"===e.way?e.$random(5):e.editSlaId,e.$emit("set-service-agreement",a),e.cancel()}))},t.prototype.cancel=function(){Object.assign(this.$data,this.$options.data.call(this)),this.$refs.validateForm.clearError()},d([Object(o.d)({type:Array,default:function(){return[]}})],t.prototype,"beginNodeList",void 0),d([Object(o.d)({type:[Number,String],default:function(){return""}})],t.prototype,"processVersion",void 0),t=d([Object(o.a)({name:"service-agreement"})],t)}(o.e),f=u,p=n("KHd+"),h=Object(p.a)(f,(function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("div",[i("bk-sideslider",{attrs:{width:550,"is-show":e.isShow,"before-close":e.cancel,"quick-close":!0},on:{"update:isShow":function(t){e.isShow=t},"update:is-show":function(t){e.isShow=t}}},[i("div",{staticClass:"content-header",attrs:{slot:"header"},slot:"header"},[i("span",[e._v("绑定服务协议")]),e._v(" "),i("span",{staticClass:"sub-title",on:{click:e.checkAgreement}},[e._v("查看协议计时说明")])]),e._v(" "),i("div",{staticClass:"content-box",attrs:{slot:"content"},slot:"content"},[i("div",{staticClass:"main-box"},[i("bk-form",{ref:"validateForm",attrs:{"label-width":210,model:e.formData,rules:e.rules,"form-type":"vertical"}},[e.isNode?i("bk-form-item",{attrs:{label:"开始节点",required:!0,property:"beginNode"}},[i("bk-select",{attrs:{placeholder:"请选择开始节点",searchable:""},on:{change:e.selectBeginNode},model:{value:e.formData.beginNode,callback:function(t){e.$set(e.formData,"beginNode",t)},expression:"formData.beginNode"}},e._l(e.beginNodeList,(function(t,n){return i("bk-option-group",{key:n,attrs:{name:t.name}},e._l(t.children,(function(e){return i("bk-option",{key:e.id,attrs:{id:e.id,name:e.name}})})),1)})),1)],1):e._e(),e._v(" "),e.isNode?i("bk-form-item",{attrs:{label:"结束节点",required:!0,property:"endNode"}},[i("bk-select",{attrs:{placeholder:"请选择结束节点",searchable:""},on:{change:e.selectEndNode},model:{value:e.formData.endNode,callback:function(t){e.$set(e.formData,"endNode",t)},expression:"formData.endNode"}},e._l(e.endNodeList,(function(e){return i("bk-option",{key:e.id,attrs:{id:e.id,name:e.name}})})),1)],1):e._e(),e._v(" "),i("bk-form-item",{attrs:{label:"服务协议",required:!0,property:"serviceAgreement"}},[i("bk-select",{attrs:{placeholder:"请选择服务协议",searchable:""},model:{value:e.formData.serviceAgreement,callback:function(t){e.$set(e.formData,"serviceAgreement",t)},expression:"formData.serviceAgreement"}},e._l(e.serviceAgreementList,(function(e){return i("bk-option",{key:e.id,attrs:{id:e.id,name:e.name}})})),1)],1),e._v(" "),i("bk-form-item",{attrs:{label:"颜色标志设置"}},[i("bk-color-picker",{attrs:{size:"small"},model:{value:e.formData.color,callback:function(t){e.$set(e.formData,"color",t)},expression:"formData.color"}})],1),e._v(" "),e.isNode?i("bk-form-item",{attrs:{label:"允许按实际开始时间进行计时"}},[i("bk-switcher",{attrs:{size:"small",theme:"primary"},model:{value:e.formData.realityActive,callback:function(t){e.$set(e.formData,"realityActive",t)},expression:"formData.realityActive"}})],1):e._e(),e._v(" "),e.isNode?i("bk-form-item",{attrs:{label:"环节未结束不重新计时"}},[i("bk-switcher",{attrs:{size:"small",theme:"primary"},model:{value:e.formData.isReTimeSla,callback:function(t){e.$set(e.formData,"isReTimeSla",t)},expression:"formData.isReTimeSla"}})],1):e._e()],1)],1),e._v(" "),i("div",{staticClass:"foot-box"},[i("bk-button",{attrs:{theme:"default",type:"submit"},on:{click:e.cancel}},[e._v("\n                    取消\n                ")]),e._v(" "),i("bk-button",{staticClass:"mr10",attrs:{theme:"primary"},on:{click:e.confirm}},[e._v("\n                    确认\n                ")])],1)])]),e._v(" "),i("bk-dialog",{attrs:{position:{top:80},theme:"primary",width:"1220","mask-close":!1,"cancel-text":"关闭",title:"协议计时说明"},model:{value:e.viewAgreementIsShow,callback:function(t){e.viewAgreementIsShow=t},expression:"viewAgreementIsShow"}},[i("img",{attrs:{src:n("h34u"),alt:""}})])],1)}),[],!1,null,"0835a926",null).exports,m=n("yXPU"),v=n.n(m),g=n("o0o1"),y=n.n(g),b=(n("f3/d"),n("0l/t"),n("hEkN"),n("CX2u"),n("Btvt"),n("VRzm"),n("RW0V"),n("ioFf"),n("mYba"),n("XfO3"),n("yt8O"),n("rGqo"),n("T39b"),n("bWfx"),n("a1Th"),n("I78e"),n("dRSK"),n("INYr"),n("91GP"),n("4ZMo"));function w(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function k(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},i=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(i=i.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),i.forEach((function(t){w(e,t,n[t])}))}return e}var _=function(e,t,n,i,o,a,s,r,c,l){"boolean"!=typeof s&&(c=r,r=s,s=!1);var d,u="function"==typeof n?n.options:n;if(e&&e.render&&(u.render=e.render,u.staticRenderFns=e.staticRenderFns,u._compiled=!0,o&&(u.functional=!0)),i&&(u._scopeId=i),a?(d=function(e){(e=e||this.$vnode&&this.$vnode.ssrContext||this.parent&&this.parent.$vnode&&this.parent.$vnode.ssrContext)||"undefined"==typeof __VUE_SSR_CONTEXT__||(e=__VUE_SSR_CONTEXT__),t&&t.call(this,c(e)),e&&e._registeredComponents&&e._registeredComponents.add(a)},u._ssrRegister=d):t&&(d=s?function(){t.call(this,l(this.$root.$options.shadowRoot))}:function(e){t.call(this,r(e))}),d)if(u.functional){var f=u.render;u.render=function(e,t){return d.call(t),f(e,t)}}else{var p=u.beforeCreate;u.beforeCreate=p?[].concat(p,d):[d]}return n},S="undefined"!=typeof navigator&&/msie [6-9]\\b/.test(navigator.userAgent.toLowerCase()),x=document.head||document.getElementsByTagName("head")[0],D={},C=function(e){return function(e,t){return function(e,t){var n=S?t.media||"default":e,i=D[n]||(D[n]={ids:new Set,styles:[]});if(!i.ids.has(e)){i.ids.add(e);var o=t.source;if(t.map&&(o+="\n/*# sourceURL="+t.map.sources[0]+" */",o+="\n/*# sourceMappingURL=data:application/json;base64,"+btoa(unescape(encodeURIComponent(JSON.stringify(t.map))))+" */"),i.element||(i.element=document.createElement("style"),i.element.type="text/css",t.media&&i.element.setAttribute("media",t.media),x.appendChild(i.element)),"styleSheet"in i.element)i.styles.push(o),i.element.styleSheet.cssText=i.styles.filter(Boolean).join("\n");else{var a=i.ids.size-1,s=document.createTextNode(o),r=i.element.childNodes;r[a]&&i.element.removeChild(r[a]),r.length?i.element.insertBefore(s,r[a]):i.element.appendChild(s)}}}(e,t)}},L=_({render:function(){var e=this.$createElement;return(this._self._c||e)("div",{staticClass:"palette-panel"},[this._t("palette",[this._m(0)])],2)},staticRenderFns:[function(){var e=this.$createElement,t=this._self._c||e;return t("ul",{staticClass:"palette-group"},[t("li",[t("div",{staticClass:"palette-default-item type-a",attrs:{"data-type":"type-a"}},[this._v("A")])]),t("li",[t("div",{staticClass:"palette-default-item type-b",attrs:{"data-type":"type-b"}},[this._v("B")])]),t("li",[t("div",{staticClass:"palette-default-item type-c",attrs:{"data-type":"type-c"}},[this._v("C")])]),t("li",[t("div",{staticClass:"palette-default-item type-d",attrs:{"data-type":"type-d"}},[this._v("D")])])])}]},(function(e){e&&e("data-v-6c6ee110_0",{source:".palette-group{margin:0;padding:0;background:#fcfcfc;text-align:center;list-style:none}.palette-group>li{padding:14px 0}.palette-default-item{display:inline-block;width:40px;height:40px;line-height:40px;font-size:12px;color:#888;border:1px solid #999;border-radius:2px;cursor:pointer;user-select:none}.palette-default-item:hover{box-shadow:0 0 8px rgba(50,50,50,.3)}.type-a{border-radius:50%}.type-b{border-radius:50%;border:4px solid #333}.type-c,.type-d{height:30px;line-height:30px;border:1px solid #999}.type-d{position:relative}.type-d:after{content:'';position:absolute;top:0;right:0;width:5px;height:5px;border-radius:50%;background:#ccc}",map:void 0,media:void 0})}),{name:"PalettePanel",props:["selector"],data:function(){return{}},mounted:function(){this.$emit("registerPaletteEvent")}},void 0,!1,void 0,C,void 0),N=_({render:function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",{staticClass:"tool-panel"},e._l(e.tools,(function(t,i){return n("div",{key:i,class:["tool-item",t.cls,{actived:"frameSelect"===t.type&&e.isFrameSelecting}],attrs:{title:t.title},on:{click:function(n){return e.onToolClick(t)}}},[e._v("\n        "+e._s(t.name)+"\n    ")])})),0)},staticRenderFns:[]},(function(e){e&&e("data-v-20cba315_0",{source:".tool-item{display:inline-block;margin-right:10px;user-select:none;cursor:pointer}.tool-item:last-child{margin-right:0}.tool-item.actived{color:#3a84ff}",map:void 0,media:void 0})}),{name:"ToolPanel",props:["tools","isFrameSelecting"],data:function(){return{}},methods:{onToolClick:function(e){this.$emit("onToolClick",e)}}},void 0,!1,void 0,C,void 0),O=_({render:function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",{staticClass:"bk-flow-location",on:{mousedown:function(t){e.moveFlag=!1},mousemove:function(t){e.moveFlag=!0},mouseup:function(t){return e.onNodeClick(e.node,t)}}},["type-a"===e.node.type?n("div",{staticClass:"type-a"},[e._v("start")]):"type-b"===e.node.type?n("div",{staticClass:"type-b"},[e._v("end")]):"type-c"===e.node.type?n("div",{staticClass:"type-c"},[e._v("taskNode")]):"type-d"===e.node.type?n("div",{staticClass:"type-d"},[e._v("subFlow")]):n("div",{staticClass:"node-default"})])},staticRenderFns:[]},(function(e){e&&e("data-v-2d0e3090_0",{source:".bk-flow-location .type-c,.bk-flow-location .type-d{width:120px;height:60px;line-height:60px;border:1px solid #ccc;text-align:center;cursor:pointer}.bk-flow-location .type-c:hover,.bk-flow-location .type-d:hover{border-color:#348aff}.bk-flow-location .type-d{position:relative}.bk-flow-location .type-d:after{content:'';position:absolute;top:0;right:0;width:10px;height:10px;border-radius:50%;background:#ccc}.bk-flow-location .type-a,.bk-flow-location .type-b{width:60px;height:60px;line-height:60px;border-radius:50%;border:1px solid #ccc;text-align:center}.bk-flow-location .type-b{border:4px solid #333}.bk-flow-location .node-default{width:120px;height:80px;line-height:80px;border:1px solid #ccc;border-radius:2px;text-align:center}.bk-flow-location .node-default.selected{border:1px solid #3a84ff}",map:void 0,media:void 0})}),{name:"NodeTemplate",props:{node:{type:Object,default:function(){return{}}}},data:function(){return{moveFlag:!1}},methods:{onNodeClick:function(e,t){this.moveFlag||console.log(e.x,e.y)}}},void 0,!1,void 0,C,void 0);function R(e){return"touches"in e?e.touches[0]:e}function $(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",t="",n=0;n<7;n++)t+=Math.floor(65536*(1+Math.random())).toString(16).substring(1);return e+t}var I={showPalette:{type:Boolean,default:!0},showTool:{type:Boolean,default:!0},tools:{type:Array,default:function(){return[{type:"zoomIn",name:"放大",cls:"tool-item"},{type:"zoomOut",name:"缩小",cls:"tool-item"},{type:"resetPosition",name:"重置",cls:"tool-item"},{type:"frameSelect",name:"框选",cls:"tool-item"}]}},editable:{type:Boolean,default:!0},selector:{type:String,default:"palette-default-item"},quickConnect:{type:Boolean,default:!0},data:{type:Object,default:function(){return{nodes:[],lines:[]}}},nodeOptions:{type:Object,default:function(){return{grid:[5,5]}}},connectorOptions:{type:Object,default:function(){return{paintStyle:{fill:"transparent",stroke:"#a9adb6",strokeWidth:2},hoverPaintStyle:{fill:"transparent",stroke:"#3a84ff"}}}},endpointOptions:{type:Object,default:function(){return{endpoint:"Dot",connector:["Flowchart",{stub:[1,6],alwaysRespectStub:!0,gap:8,cornerRadius:2}],connectorOverlays:[["PlainArrow",{width:8,length:6,location:1,id:"arrow"}]],anchor:["Left","Right","Top","Bottom"],isSource:!0,isTarget:!0}}}},A={mousedown:"ontouchstart"in document.documentElement?"touchstart":"mousedown",mousemove:"ontouchmove"in document.documentElement?"touchmove":"mousemove",mouseup:"ontouchend"in document.documentElement?"touchend":"mouseup"},E=_({render:function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",{staticClass:"jsflow"},[n("div",{staticClass:"canvas-area"},[e.showTool?n("div",{staticClass:"tool-panel-wrap"},[e._t("toolPanel",[n("tool-panel",{attrs:{tools:e.tools,"is-frame-selecting":e.isFrameSelecting},on:{onToolClick:e.onToolClick}})])],2):e._e(),e.showPalette?n("div",{ref:"palettePanel",staticClass:"palette-panel-wrap"},[e._t("palettePanel",[n("palette-panel",{attrs:{selector:e.selector}})])],2):e._e(),n("div",{ref:"canvasFlowWrap",staticClass:"canvas-flow-wrap",style:e.canvasWrapStyle,on:e._d({},[e.mousedown,e.onCanvasMouseDown,e.mouseup,e.onCanvasMouseUp])},[n("div",{ref:"canvasFlow",staticClass:"canvas-flow",style:e.canvasStyle,attrs:{id:"canvas-flow"}},e._l(e.nodes,(function(t){return n("div",{key:t.id,staticClass:"jsflow-node canvas-node",attrs:{id:t.id},on:{mouseover:function(n){return e.toggleHighLight(t,!0)},mouseout:function(n){return e.toggleHighLight(t,!1)}}},[e._t("nodeTemplate",[n("node-template",{attrs:{node:t}})],{node:t})],2)})),0),e.isFrameSelecting?n("div",{staticClass:"canvas-frame-selector",style:e.frameSelectorStyle}):e._e()]),e.showAddingNode?n("div",{staticClass:"jsflow-node adding-node",style:e.setNodeInitialPos(e.addingNodeConfig)},[e._t("nodeTemplate",[n("node-template",{attrs:{node:e.addingNodeConfig}})],{node:e.addingNodeConfig})],2):e._e()])])},staticRenderFns:[]},(function(e){e&&e("data-v-e853be96_0",{source:".jsflow{height:100%;border:1px solid #ccc}.jsflow .canvas-area{position:relative;height:100%}.jsflow .tool-panel-wrap{position:absolute;top:20px;left:70px;padding:10px 20px;background:#c4c6cc;opacity:.65;border-radius:4px;z-index:4}.jsflow .palette-panel-wrap{float:left;width:60px;height:100%;border-right:1px solid #ccc}.jsflow .canvas-flow-wrap{position:relative;height:100%;overflow:hidden}.jsflow .canvas-flow{position:relative;min-width:100%;min-height:100%}.jsflow .canvas-frame-selector{position:absolute;border:1px solid #3a84ff;background:rgba(58,132,255,.15)}.jsflow .jsflow-node{position:absolute;z-index:1}.jsflow .jtk-endpoint{z-index:1}.jsflow .adding-node{opacity:.8}.jsflow .jtk-endpoint.jtk-dragging{z-index:0}",map:void 0,media:void 0})}),{name:"JsFlow",components:{PalettePanel:L,ToolPanel:N,NodeTemplate:O},model:{prop:"data",event:"change"},props:I,data:function(){var e=this.data;return k({nodes:e.nodes,lines:e.lines,canvasGrabbing:!1,isFrameSelecting:!1,mouseDownPos:{},canvasPos:{x:0,y:0},canvasOffset:{x:0,y:0},frameSelectorPos:{x:0,y:0},frameSelectorRect:{width:0,height:0},selectedNodes:[],showAddingNode:!1,addingNodeConfig:{},addingNodeRect:{},canvasRect:{},paletteRect:{},zoom:1},A)},computed:{canvasWrapStyle:function(){return{cursor:this.isFrameSelecting?"crosshair":this.canvasGrabbing?"-webkit-grabbing":"-webkit-grab"}},canvasStyle:function(){return{left:"".concat(this.canvasOffset.x,"px"),top:"".concat(this.canvasOffset.y,"px")}},frameSelectorStyle:function(){return{left:"".concat(this.frameSelectorPos.x,"px"),top:"".concat(this.frameSelectorPos.y,"px"),width:"".concat(this.frameSelectorRect.width,"px"),height:"".concat(this.frameSelectorRect.height,"px")}}},watch:{data:{handler:function(e){var t=e.nodes,n=e.lines;this.nodes=t,this.lines=n},deep:!0},editable:function(e){var t=this.$el.querySelectorAll(".canvas-node");this.toggleNodeDraggable(t,e)}},mounted:function(){this.initCanvas(),this.registerEvent(),this.renderData(),this.canvasRect=this.$refs.canvasFlow.getBoundingClientRect(),this.$refs.palettePanel&&(this.paletteRect=this.$refs.palettePanel.getBoundingClientRect(),this.registerPaletteEvent())},beforeDestroy:function(){this.$refs.palettePanel&&this.$refs.palettePanel.removeEventListener(this.mousedown,this.nodeCreateHandler),this.$el.removeEventListener(this.mousemove,this.nodeMovingHandler),document.removeEventListener(this.mouseup,this.nodeMoveEndHandler)},methods:{initCanvas:function(){var e={},t=k({},this.endpointOptions,this.connectorOptions);for(var n in t){var i=n[0].toUpperCase();e["".concat(i).concat(n.slice(1))]=t[n]}this.instance=b.jsPlumb.getInstance(k({container:"canvas-flow"},e))},registerEvent:function(){var e=this;this.instance.bind("beforeDrag",(function(t){return!!e.editable&&("function"!=typeof e.$listeners.onBeforeDrag||e.$listeners.onBeforeDrag(t))})),this.instance.bind("beforeDrop",(function(t){return!!e.editable&&("function"!=typeof e.$listeners.onBeforeDrop||e.$listeners.onBeforeDrop(t))})),this.instance.bind("connectionDrag",(function(t){"function"==typeof e.$listeners.connectionDrag&&e.$emit("connectionDrag",t)})),this.instance.bind("connection",(function(t){if("function"==typeof e.$listeners.onConnection)return e.$listeners.onConnection(t)})),this.instance.bind("connectionDragStop",(function(t,n){if(!t.target||!t.target.classList.contains("jsflow-node")){var i=e.getNodeWithEndpoint(n.target);if(i){var o=e.nodes.find((function(e){return i.id===e.id}));if("function"==typeof e.$listeners.onConnectionDragStop){var a={id:t.source.id,arrow:t.endpoints[0].anchor.type};e.$emit("onConnectionDragStop",a,o.id,n)}}}})),this.instance.bind("beforeDetach",(function(t){return"function"!=typeof e.$listeners.onBeforeDetach||e.$listeners.onBeforeDetach(t)})),this.instance.bind("connectionDetached",(function(t,n){var i=e.lines.filter((function(e){return e.source.id!==t.sourceId&&e.target.id!==t.targetId}));e.lines=i,"function"==typeof e.$listeners.onConnectionDetached&&e.$emit("onConnectionDetached",i)})),this.instance.bind("connectionMoved",(function(t,n){"function"==typeof e.$listeners.onConnectionMoved&&e.$emit("onConnectionMoved",lines)})),this.instance.bind("click",(function(t,n){"function"==typeof e.$listeners.onConnectionClick&&e.$emit("onConnectionClick",t,n)})),this.instance.bind("dblclick",(function(t,n){"function"==typeof e.$listeners.onConnectionDbClick&&e.$emit("onConnectionDbClick",t,n)}))},renderData:function(){var e=this;this.instance.batch((function(){e.nodes.forEach((function(t){e.initNode(t)})),e.lines.forEach((function(t){e.createConnector(t,e.connectorOptions)}))}))},createNode:function(e){var t=this;("function"!=typeof this.$listeners.onCreateNodeBefore||this.$listeners.onCreateNodeBefore(e))&&(this.nodes.push(e),this.$nextTick((function(){t.initNode(e)})))},initNode:function(e){var t=document.getElementById(e.id);t.style.left="".concat(e.x,"px"),t.style.top="".concat(e.y,"px"),this.setNodeDraggable(e,this.nodeOptions),this.setNodeEndPoint(e,this.endpointOptions),"function"==typeof this.$listeners.onCreateNodeAfter&&this.$emit("onCreateNodeAfter",e)},removeNode:function(e){var t=this.nodes.findIndex((function(t){return t.id===e.id}));this.nodes.splice(t,1),this.instance.remove(e.id)},setNodeEndPoint:function(e,t){var n=this;(e.endpoints||["Top","Right","Bottom","Left"]).forEach((function(i){n.instance.addEndpoint(e.id,k({anchor:i,uuid:i+e.id},t))}))},setNodeDraggable:function(e,t){if(this.editable){var n=this;this.instance.draggable(e.id,k({grid:[20,20],drag:function(t){var i=Object.assign({},e);n.$emit("onNodeMoving",i,t)},stop:function(t){var i=n.nodes.findIndex((function(t){return t.id===e.id})),o=Object.assign({},e),a=function(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=[],i=!0,o=!1,a=void 0;try{for(var s,r=e[Symbol.iterator]();!(i=(s=r.next()).done)&&(n.push(s.value),!t||n.length!==t);i=!0);}catch(e){o=!0,a=e}finally{try{i||null==r.return||r.return()}finally{if(o)throw a}}return n}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}(t.pos,2),s=a[0],r=a[1];o.x=s,o.y=r,n.nodes.splice(i,1,o),n.$emit("onNodeMoveStop",o,t)}},t))}},setNodePosition:function(e){var t=document.getElementById(e.id);t.style.left="".concat(e.x,"px"),t.style.top="".concat(e.y,"px"),this.instance.revalidate(t)},toggleNodeDraggable:function(e,t){this.instance.setDraggable(e,t)},setNodeInitialPos:function(e){return{left:"".concat(e.x,"px"),top:"".concat(e.y,"px")}},createConnector:function(e,t){var n=e.options||{};return this.instance.connect({source:e.source.id,target:e.target.id,uuids:[e.source.arrow+e.source.id,e.target.arrow+e.target.id]},k({},t,n))},getConnectorsByNodeId:function(e){return this.instance.getAllConnections().filter((function(t){return t.sourceId===e||t.targetId===e}))},getNodeWithEndpoint:function(e){var t=e.parentNode;return!(!t||"HTML"===t.nodeName)&&(t.classList.contains("jsflow-node")?t:this.getNodeWithEndpoint(t))},removeConnector:function(e){var t=this;this.instance.getConnections({source:e.source.id,target:e.target.id}).forEach((function(e){t.instance.deleteConnection(e)}))},addLineOverlay:function(e,t){var n=this;this.instance.getConnections({source:e.source.id,target:e.target.id}).forEach((function(e){e.addOverlay([t.type,{label:t.name,location:t.location,cssClass:t.cls,id:t.id,events:{click:function(e,t){n.$emit("onOverlayClick",e,t)}}}])}))},removeLineOverlay:function(e,t){this.instance.getConnections({source:e.source.id,target:e.target.id}).forEach((function(e){e.removeOverlay(t)}))},onCanvasMouseDown:function(e){e=R(e),this.isFrameSelecting?this.frameSelectHandler(e):(this.canvasGrabbing=!0,this.mouseDownPos={x:e.pageX,y:e.pageY},this.$refs.canvasFlowWrap.addEventListener(this.mousemove,this.canvasFlowMoveHandler,!1))},canvasFlowMoveHandler:function(e){e=R(e),this.canvasOffset={x:this.canvasPos.x+e.pageX-this.mouseDownPos.x,y:this.canvasPos.y+e.pageY-this.mouseDownPos.y}},onCanvasMouseUp:function(e){this.isFrameSelecting?this.frameSelectEndHandler(e):(this.canvasGrabbing=!1,this.$refs.canvasFlowWrap.removeEventListener(this.mousemove,this.canvasFlowMoveHandler),this.canvasPos={x:this.canvasOffset.x,y:this.canvasOffset.y})},registerPaletteEvent:function(){this.$refs.palettePanel.addEventListener(this.mousedown,this.nodeCreateHandler,!1)},nodeCreateHandler:function(e){var t=this,n=function e(t,n){return 1===t.nodeType&&t.classList.contains(n)?t:"HTML"!==t.parentNode.nodeName?e(t.parentNode,n):null}(e.target,this.selector);if(!n)return!1;var i=n.dataset.type?n.dataset.type:"",o=n.dataset?n.dataset.config:{};this.showAddingNode=!0,this.addingNodeConfig.id=$("node"),this.addingNodeConfig.type=i,this.$nextTick((function(){var n=t.$el.querySelector(".adding-node");t.addingNodeRect=n.getBoundingClientRect();var a=t.getAddingNodePos(e);t.addingNodeConfig=k({id:$("node"),type:i,x:a.x,y:a.y},o),t.$el.addEventListener(t.mousemove,t.nodeMovingHandler,!1),document.addEventListener(t.mouseup,t.nodeMoveEndHandler,!1)}))},nodeMovingHandler:function(e){var t=this.getAddingNodePos(e);this.$set(this.addingNodeConfig,"x",t.x),this.$set(this.addingNodeConfig,"y",t.y)},nodeMoveEndHandler:function(e){if(this.$el.removeEventListener(this.mousemove,this.nodeMovingHandler),document.removeEventListener(this.mouseup,this.nodeMoveEndHandler),this.showAddingNode=!1,e.pageX>this.paletteRect.left+this.paletteRect.width){var t=this.addingNodeConfig.x-this.paletteRect.width-this.canvasOffset.x,n=this.addingNodeConfig.y-this.canvasOffset.y;this.$set(this.addingNodeConfig,"x",t),this.$set(this.addingNodeConfig,"y",n),this.createNode(this.addingNodeConfig)}this.addingNodeConfig={},this.addingNodeRect={}},getAddingNodePos:function(e){return{x:e.pageX-this.paletteRect.left-this.addingNodeRect.width/2,y:e.pageY-this.paletteRect.top-this.addingNodeRect.height/2}},toggleHighLight:function(e){var t=this,n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=(this.instance.getEndpoints(e.id),document.getElementById(e.id));this.instance.selectEndpoints({source:i}).each((function(e){var i=n?t.endpointOptions.hoverPaintStyle:t.endpointOptions.paintStyle;e.setStyle(i)}))},onToolClick:function(e){"function"==typeof this[e.type]&&this[e.type](),this.$emit("onToolClick",e)},setZoom:function(e){this.instance.setContainer("canvas-flow"),this.$refs.canvasFlow.style.transform="matrix("+e+",0,0,"+e+",0,0)",this.$refs.canvasFlow.style.transformOrigin="0 0",this.$refs.canvasFlow.zoom=e,this.zoom=e,this.instance.setZoom(e)},zoomIn:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1.1;this.setZoom(this.zoom*e)},zoomOut:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.9;this.setZoom(this.zoom*e)},resetPosition:function(){this.setZoom(1),this.setCanvasPosition(0,0)},setCanvasPosition:function(e,t){this.canvasOffset={x:e,y:t},this.canvasPos={x:e,y:t}},frameSelect:function(){this.isFrameSelecting=!0},frameSelectHandler:function(e){this.mouseDownPos={x:e.pageX-this.canvasRect.left,y:e.pageY-this.canvasRect.top},this.$refs.canvasFlowWrap.addEventListener(this.mousemove,this.frameSelectMovingHandler,!1)},frameSelectMovingHandler:function(e){var t=e.pageX-this.mouseDownPos.x-this.canvasRect.left,n=e.pageY-this.mouseDownPos.y-this.canvasRect.top;this.frameSelectorRect={width:Math.abs(t),height:Math.abs(n)},this.frameSelectorPos={x:t>0?this.mouseDownPos.x:this.mouseDownPos.x+t,y:n>0?this.mouseDownPos.y:this.mouseDownPos.y+n}},frameSelectEndHandler:function(e){this.$refs.canvasFlowWrap.removeEventListener(this.mousemove,this.frameSelectMovingHandler),this.$refs.canvasFlowWrap.removeEventListener(this.mouseup,this.frameSelectEndHandler),document.addEventListener("keydown",this.nodeLineCopyhandler,!1),document.addEventListener("keydown",this.nodeLinePastehandler,!1),document.addEventListener("keydown",this.nodeLineDeletehandler,!1),document.addEventListener(this.mousedown,this.cancelFrameSelectorHandler,{capture:!1,once:!0});var t=this.getSelectedNodes(),n=t.map((function(e){return e.id}));this.isFrameSelecting=!1,this.frameSelectorPos={x:0,y:0},this.frameSelectorRect={width:0,height:0},this.selectedNodes=t,this.clearNodesDragSelection(),this.addNodesToDragSelection(n),this.$emit("frameSelectNodes",t.slice(0))},getSelectedNodes:function(){var e=this,t=this.frameSelectorPos,n=t.x,i=t.y,o=this.frameSelectorRect,a=o.width,s=o.height;return this.nodes.filter((function(t){var o=document.querySelector("#".concat(t.id)),r=o.getBoundingClientRect(),c=r.left-e.canvasRect.left,l=r.top-e.canvasRect.top;if(n<c&&n+a>c&&i<l&&i+s>l)return o.classList.add("selected"),!0}))},cancelFrameSelectorHandler:function(e){this.selectedNodes.forEach((function(e){var t=document.querySelector("#".concat(e.id));t&&t.classList.remove("selected")})),this.selectedNodes=[],this.clearNodesDragSelection()},nodeLineCopyhandler:function(e){(e.ctrlKey||e.metaKey)&&67===e.keyCode&&this.$emit("onNodeCopy",this.selectedNodes)},nodeLinePastehandler:function(e){(e.ctrlKey||e.metaKey)&&86===e.keyCode&&this.$emit("onNodePaste")},nodeLineDeletehandler:function(e){var t=this;46!==e.keyCode&&8!==e.keyCode||(this.selectedNodes.forEach((function(e){t.removeNode(e)})),this.cancelFrameSelectorHandler())},addNodesToDragSelection:function(e){this.instance.addToDragSelection(e)},clearNodesDragSelection:function(){this.instance.clearDragSelection()}}},void 0,!1,void 0,C,void 0);"undefined"!=typeof window&&"Vue"in window&&window.Vue.component("js-flow",E);var T=E,P={name:"node-template",props:{node:{type:Object,default:function(){return{}}},canvasData:{type:Object,default:function(){return{}}}},data:function(){return{moveFlag:!1,clickSecond:!1,toolStatus:!1,valueInfo:{node:{},line:{}},typeList:[{type:"NORMAL",iconStyle:"icon-icon-person"},{type:"ROUTER",iconStyle:"icon-icon-person"},{type:"TASK",iconStyle:"icon-api-icon"},{type:"TASK-SOPS",iconStyle:"icon-task-node"},{type:"SIGN",iconStyle:"icon-sign-node-white f18"},{type:"APPROVAL",iconStyle:"icon-icon-auto-node"}],clickList:[{type:"NORMAL",name:this.$t('m.treeinfo["手动节点"]'),iconStyle:"icon-icon-artificial"},{type:"TASK",name:this.$t('m.treeinfo["API节点"]'),iconStyle:"icon-api-node"},{type:"SIGN",name:this.$t("m.treeinfo['会签节点']"),iconStyle:"icon-sign-node"},{type:"COVERAGE",name:this.$t('m.treeinfo["汇聚网关"]'),iconStyle:"icon-flow-branch"},{type:"ROUTER-P",name:this.$t('m.treeinfo["并行网关"]'),iconStyle:"icon-flow-convergence"},{type:"COPY",name:this.$t('m.treeinfo["复制节点"]'),iconStyle:"icon-copy-new"}],currentNode:{}}},mounted:function(){this.toolStatus=localStorage.getItem("toolStatus")||!1},methods:{hoverNode:function(e){e.nodeInfo&&e.nodeInfo.errorInfo&&(e.nodeInfo.errorInfo=!1)},moveDoneFn:function(e){this.moveFlag=!1;for(var t=document.getElementsByClassName("jsflow-node"),n=0;n<t.length;n++)t[n].style["z-index"]=101;document.getElementById(e.id)&&(document.getElementById(e.id).style["z-index"]=102)},moveFn:function(){this.moveFlag=!0},clickNode:function(e,t){this.openconfigu(e)},openconfigu:function(e){e.x===this.currentNode.x&&e.y===this.currentNode.y&&"ROUTER-P"!==e.type&&"COVERAGE"!==e.type&&"START"!==e.type&&"END"!==e.type&&this.$emit("configuNode",e.nodeInfo)},closeNode:function(){this.node.showMore=!1},addNormal:function(e,t){var n=this;if(!this.clickSecond)if(this.clickSecond=!0,this.$store.commit("deployCommon/changeNodeStatus",!0),"COPY"!==t.type){var i=this.canvasData.lines.filter((function(t){return t.source.id===e.id})),o="NORMAL"===e.type||"TASK"===e.type?310:210,a={workflow:e.nodeInfo.workflow,name:"",type:t.type,is_terminable:!1,axis:{x:e.x+o,y:e.y+80*i.length},extras:{}};this.$store.dispatch("deployCommon/creatNode",{params:a}).then((function(a){n.valueInfo.node={id:"node_"+a.data.id,x:e.x+o,y:e.y+80*i.length,type:t.type,name:a.data.name,showMore:!1,nodeInfo:a.data},n.$emit("closeShow"),n.$emit("updateNode",n.valueInfo),n.addNewLine(e,a.data.id)})).catch((function(e){n.$bkMessage({message:e.data.msg,theme:"error"})})).finally((function(){n.clickSecond=!1,n.$store.commit("deployCommon/changeNodeStatus",!1)}))}else{var s=this.node.nodeInfo.id;this.$store.dispatch("deployCommon/copyNode",s).then((function(e){n.valueInfo.node={id:"node_"+e.data.id,x:e.data.axis.x,y:e.data.axis.y,type:e.data.type,name:e.data.name,showMore:!1,nodeInfo:e.data},n.$emit("closeShow"),n.$emit("updateNode",n.valueInfo)})).catch((function(e){n.$bkMessage({message:e.data.msg,theme:"error"})})).finally((function(){n.clickSecond=!1,n.$store.commit("deployCommon/changeNodeStatus",!1)}))}},addNewLine:function(e,t){var n=this,i={workflow:e.nodeInfo.workflow,name:this.$t('m.treeinfo["默认"]'),axis:{start:"Right",end:"Left"},from_state:e.nodeInfo.id,to_state:t};this.$store.dispatch("deployCommon/createLine",{lineParams:i}).then((function(t){n.valueInfo.line={source:{arrow:"Right",id:e.id},target:{arrow:"Left",id:n.valueInfo.node.id},lineInfo:t.data},n.$emit("fastAddNode",n.valueInfo),n.$emit("updateLine",n.valueInfo.line,"add")})).catch((function(e){n.$bkMessage({message:e.data.msg,theme:"error"})}))},clickDelete:function(e){this.$emit("openDelete",e)},closeTool:function(){this.toolStatus=!0,localStorage.setItem("toolStatus",!0)}}},j=Object(p.a)(P,(function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",{directives:[{name:"bk-clickoutside",rawName:"v-bk-clickoutside",value:e.closeNode,expression:"closeNode"}],staticClass:"bk-flow-location",class:{"bk-error-flow":e.node.nodeInfo&&e.node.nodeInfo.errorInfo},on:{mousedown:function(t){return e.moveDoneFn(e.node)},mousemove:e.moveFn,mouseout:function(t){return e.hoverNode(e.node)}}},["START"===e.node.type?n("div",{staticClass:"startpoint"},[e._v("\n        开始\n    ")]):e._e(),e._v(" "),"END"===e.node.type?n("div",{staticClass:"endpoint"},[e._v("\n        结束\n    ")]):e._e(),e._v(" "),e._l(e.typeList,(function(t,i){return[e.node.type===t.type?[n("div",{key:i,staticClass:"common-node"},[n("span",{staticClass:"common-auto-icon",class:{"bk-is-draft":e.node.nodeInfo&&e.node.nodeInfo.is_draft},on:{click:function(t){return t.stopPropagation(),e.openconfigu(e.node)}}},["TASK"!==t.type?n("i",{staticClass:"bk-itsm-icon",class:t.iconStyle}):n("span",{staticStyle:{"font-size":"11px","font-weight":"bold"}},[e._v("API")])]),e._v(" "),n("span",{staticClass:"bk-more-word",attrs:{title:e.node.name||e.$t("m.treeinfo['新增节点']")}},[e._v(e._s(e.node.name||e.$t("m.treeinfo['新增节点']")))])])]:e._e()]})),e._v(" "),"ROUTER-P"===e.node.type?n("div",{staticClass:"common-branch"},[n("i",{staticClass:"bk-itsm-icon icon-flow-convergence"}),e._v(" "),n("span",{staticClass:"bk-node-delete",on:{click:function(t){return t.stopPropagation(),e.clickDelete(e.node)}}},[e._v("×")])]):e._e(),e._v(" "),"COVERAGE"===e.node.type?n("div",{staticClass:"common-branch"},[n("i",{staticClass:"bk-itsm-icon icon-flow-branch"}),e._v(" "),n("span",{staticClass:"bk-node-delete",on:{click:function(t){return t.stopPropagation(),e.clickDelete(e.node)}}},[e._v("×")])]):e._e(),e._v(" "),n("div",{directives:[{name:"show",rawName:"v-show",value:e.node.showMore&&"START"!==e.node.type&&"END"!==e.node.type,expression:"node.showMore && node.type !== 'START' && node.type !== 'END'"}],staticClass:"bk-flow-fast"},[n("div",{staticClass:"bk-engine-node"},[n("ul",e._l(e.clickList,(function(t,i){return n("li",{key:i,staticClass:"tool",attrs:{title:t.name},on:{click:function(n){return n.stopPropagation(),e.addNormal(e.node,t)}}},[n("i",{staticClass:"bk-itsm-icon",class:[t.iconStyle,{"bk-font-style":"icon-icon-artificial"===t.iconStyle||"icon-api-node"===t.iconStyle||"icon-task-icon"===t.iconStyle||"icon-copy-new"===t.iconStyle||"icon-sign-node"===t.iconStyle}]})])})),0)]),e._v(" "),n("div",{staticClass:"bk-engine-word"},[n("span",{staticClass:"bk-canvas-span bk-engine-configur",class:{"bk-engine-builtin":"ROUTER-P"===e.node.type||"COVERAGE"===e.node.type},on:{click:function(t){return t.stopPropagation(),e.openconfigu(e.node)}}},[e._v(e._s(e.$t('m.treeinfo["配置"]')))]),e._v(" "),n("span",{staticClass:"bk-canvas-span bk-engine-delete",class:{"bk-engine-builtin":e.node.nodeInfo&&e.node.nodeInfo.is_builtin},on:{click:function(t){return t.stopPropagation(),e.clickDelete(e.node)}}},[e._v(e._s(e.$t('m.treeinfo["删除"]')))])])])],2)}),[],!1,null,"669708c8",null).exports,M={endpoint:"Dot",connector:["Flowchart",{stub:[10,16],alwaysRespectStub:!0,gap:2,cornerRadius:10}],connectorOverlays:[["PlainArrow",{width:8,length:6,location:1,id:"arrow"}]],paintStyle:{fill:"rgba(0, 0, 0, 0)",stroke:"",strokeWidth:1,radius:8},hoverPaintStyle:{fill:"#EE8F62",stroke:"#EE8F62",radius:8},cssClass:"template-canvas-endpoint",hoverClass:"template-canvas-endpoint-hover",isSource:!1,isTarget:!1,maxConnections:-1},F={grid:[5,5],stop:!0},V={paintStyle:{fill:"transparent",stroke:"#a9adb6",strokeWidth:1},hoverPaintStyle:{fill:"transparent",stroke:"#3a84ff",strokeWidth:2},cssClass:"bk-sops-connector",hoverClass:"bk-sops-connector-hover",detachable:!1},H={name:"second-flow",components:{JsFlow:T,NodeTemplate:j},props:{addList:{type:Array,default:function(){return[]}},lineList:{type:Array,default:function(){return[]}},serviceAgreementList:{type:Array,default:function(){return[]}},flowInfo:{type:Object,default:function(){return{}}}},data:function(){return{hoverSlaObj:{},clickSecond:!1,isReset:!0,endpointOptions:M,connectorOptions:V,nodeOptions:F,canvasData:{nodes:[],lines:[]},toolsInfo:[[{type:"zoomIn",name:" ",title:"放大",cls:"bk-itsm-icon icon-flow-other-add"},{type:"zoomOut",name:" ",title:"缩小",cls:"bk-itsm-icon icon-flow-other-reduc"}],[{type:"zoomIn",name:" ",title:"放大",cls:"bk-itsm-icon icon-flow-other-add"},{type:"zoomOut",name:" ",title:"缩小",cls:"bk-itsm-icon icon-flow-other-reduc"}]],nodeInfo:{},toolLimit:4,deleteInfo:{isShow:!1,title:this.$t('m.treeinfo["确认删除"]'),content:this.$t('m.treeinfo["确认后，此节点将从该流程中移除！"]'),info:{}},drawStatus:!1,isFullPage:!1,currentNode:{},instance:[]}},computed:{nodeStatus:function(){return this.$store.state.deployCommon.nodeStatus},stateNodeInfo:function(){return this.$store.state.deployCommon.nodeInfo}},created:function(){this.initDate()},mounted:function(){this.addLineOverlay(),this.instance=this.$refs.jsFlow.instance,this.$refs.jsFlow.zoomOut(this.flowInfo.narrowSize)},methods:{initDate:function(){var e=this;this.addList.forEach((function(t,n){var i=t.axis.x?t.axis.x:165+250*n,o=t.axis.y?t.axis.y:195+(n%2==1?5:0);e.canvasData.nodes.push({id:"node_"+t.id,x:i,y:o,type:t.type,name:t.name,showMore:!1,nodeInfo:t,options:{paintStyle:{fill:"rgba(0, 0, 0, 0)",stroke:"rgba(52, 138, 243, 0.15)",strokeWidth:1,radius:7}}}),e.$set(e.nodeInfo,"node_"+t.id,t)})),this.getLineData()},getLineData:function(){var e=this;this.lineList.forEach((function(t,n){e.canvasData.lines.push({source:{arrow:t.axis.start||"Right",id:"node_"+t.from_state},target:{arrow:t.axis.end||"Left",id:"node_"+t.to_state},lineInfo:t,options:{paintStyle:{fill:"transparent",stroke:e.getLineColor(t.id),strokeWidth:"#a9adb6"===e.getLineColor(t.id)?1:2}}})}))},updateCanvas:function(){this.removeAllConnector(),this.getLineData(),this.renderLineData()},slaIconClick:function(e){this.$emit("slaIconClick",e)},renderLineData:function(){var e=this;this.instance.batch((function(){e.canvasData.lines.forEach((function(t){e.$refs.jsFlow.createConnector(t)}))})),this.addLineOverlay()},removeAllConnector:function(){this.instance.deleteEveryConnection(),this.canvasData.lines=[]},getLineColor:function(e){return"color"in this.hoverSlaObj&&"lines"in this.hoverSlaObj?-1!==this.hoverSlaObj.lines.indexOf(e)?this.hoverSlaObj.color:"rgba(176, 180, 189, 0.3)":"#a9adb6"},getLabelColor:function(e){return"color"in this.hoverSlaObj&&"lines"in this.hoverSlaObj?-1!==this.hoverSlaObj.lines.indexOf(e)?"#a9adb6":"rgba(176, 180, 189, 0.3)":"#a9adb6"},isHoverNode:function(e){return"color"in this.hoverSlaObj&&"lines"in this.hoverSlaObj&&-1===this.hoverSlaObj.states.indexOf(e)},errorNodes:function(e){var t=this;this.canvasData.nodes.forEach((function(n){e.forEach((function(e){n.nodeInfo.id===e&&t.$set(n.nodeInfo,"errorInfo",!0)}))}))},addLineOverlay:function(){var e=this;this.canvasData.lines.forEach((function(t){var n={source:t.source,target:t.target,lineInfo:t.lineInfo,id:t.lineInfo.id,name:t.lineInfo.name};e.lineOverlay(n)}))},lineOverlay:function(e){if(!this.canvasData.nodes.some((function(t){return e.source.id===t.id&&"START"===t.type}))){var t=this.getLabelColor(e.id),n='<span class="bk-label-test-name" style="color: '.concat(t,"; border-color: ").concat(t,'">').concat(e.name||this.$t('m.treeinfo["默认"]'),"</span>"),i={id:"label_"+e.id,type:"Label",name:n,cls:"label-test",location:.5};this.$refs.jsFlow.addLineOverlay(e,i)}},removerLine:function(e){this.$refs.jsFlow.removeConnector({source:{id:e.sourceId},target:{id:e.targetId}})},onToolClick:function(e){"fullPagePosition"===e.type&&(this.isFullPage=!0)},onResetPosition:function(){this.$refs.jsFlow.resetPosition()},onConnectionClick:function(e,t){},onConnection:function(e){this.drawStatus&&(this.drawLine(e),this.drawStatus=!1)},onConnectionDragStop:function(e,t,n){var i={sourceId:e.id,targetId:t};if(this.checkLineInfo(i)){var o,a={source:e,target:{id:t}},s=document.getElementById(t).getBoundingClientRect(),r=n.clientX-s.left,c=n.clientY-s.Top;o=r<s.width/2?c<s.height/2?r>c?"Top":"Left":r>s.height-c?"Bottom":"Left":c<s.height/2?s.width-r>c?"Top":"Right":s.width-r>s.height-c?"Bottom":"Right",a.target.arrow=o,this.$refs.jsFlow.createConnector(a);var l={sourceId:e.id,targetId:t,sourceEndpoint:{anchor:{type:e.arrow}},targetEndpoint:{anchor:{type:o}}};this.drawLine(l),this.drawStatus=!1}},onBeforeDrop:function(e){return this.checkLineInfo(e)},checkLineInfo:function(e){var t=this.canvasData.nodes.filter((function(t){return t.id===e.sourceId})),n=this.canvasData.nodes.filter((function(t){return t.id===e.targetId})),i={status:!0,msg:""};"START"===t[0].type&&(this.canvasData.lines.some((function(e){return e.source.id===t[0].id}))&&(i.status=!1,i.msg="开始节点只能单一输出！"));"START"===n[0].type&&(i.status=!1,i.msg="开始节点只能输出！"),"END"===t[0].type&&(i.status=!1,i.msg="结束节点只能输入！"),"START"===t[0].type&&"END"===n[0].type&&(i.status=!1,i.msg="开始节点和结束节点不能直接相连！"),e.sourceId===e.targetId&&(i.status=!1,i.msg="自身不能相连！");for(var o=0;o<this.canvasData.lines.length;o++)e.sourceId===this.canvasData.lines[o].source.id&&e.targetId===this.canvasData.lines[o].target.id&&(i.status=!1,i.msg="已存在的连线！");return i.status||this.$bkMessage({message:i.msg,theme:"warning"}),this.drawStatus=!0,i.status},drawLine:function(e){var t=this;return v()(y.a.mark((function n(){var i,o,a,s;return y.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(i="",o="",a={targetId:"",sourceId:""},t.canvasData.nodes.forEach((function(t,n){t.id===e.sourceId&&(o=t.nodeInfo.id,a.sourceId=t.id),t.id===e.targetId&&(i=t.nodeInfo.id,a.targetId=t.id)})),s={workflow:t.addList[0].workflow,name:t.$t('m.treeinfo["默认"]'),axis:{start:e.sourceEndpoint.anchor.type,end:e.targetEndpoint.anchor.type},from_state:o,to_state:i},!t.canvasData.lines.some((function(e){return e.source.id===a.sourceId&&e.target.id===a.targetId}))){n.next=8;break}return n.abrupt("return");case 8:if(!t.clickSecond){n.next=10;break}return n.abrupt("return");case 10:return t.clickSecond=!0,n.next=13,t.$store.dispatch("deployCommon/createLine",{lineParams:s}).then((function(n){var i=[{source:{arrow:s.axis.start,id:e.sourceId},target:{arrow:s.axis.end,id:e.targetId},lineInfo:n.data,id:n.data.id,name:n.data.name}];t.updateLine(i,"add"),t.lineOverlay(i[0])})).catch((function(e){t.$bkMessage({message:e.data.msg,theme:"error"}),t.canvasData.lines.some((function(e){return e.source.id===a.sourceId&&e.target.id===a.targetId}))||t.$refs.jsFlow.removeConnector({source:{id:a.sourceId},target:{id:a.targetId}})})).finally((function(){t.clickSecond=!1}));case 13:case"end":return n.stop()}}),n)})))()},updateLine:function(e,t){var n=this;"delete"===t?e.forEach((function(e){n.canvasData.lines.forEach((function(t,i){t.source.id===e.source.id&&t.target.id===e.target.id&&n.canvasData.lines.splice(i,1)}))})):"update"===t?e.forEach((function(e){n.canvasData.lines.forEach((function(t,n){t.source.id===e.source.id&&t.target.id===e.target.id&&(t.lineInfo=e.lineInfo)}))})):"add"===t&&(this.canvasData.lines=this.canvasData.lines.concat(e))},onConnectionDetached:function(){},onZoomIn:function(){this.toolLimit>9||(this.toolLimit+=1,this.$refs.jsFlow&&this.$refs.jsFlow.zoomIn())},onZoomOut:function(){0!==this.toolLimit&&(this.toolLimit-=1,this.$refs.jsFlow&&this.$refs.jsFlow.zoomOut())},onCanvasFrameSelect:function(){},handleScroll:function(e){e.deltaY>0?this.onZoomOut():this.onZoomIn()},updateNode:function(e){var t=this;this.$refs.jsFlow.createNode(e.node);var n=[];this.canvasData.nodes.forEach((function(i){var o=i.x-e.node.x,a=i.y-e.node.y;if(e.node.id!==i.id&&a>=-40&&o>=-150&&o<=150){var s={id:i.id,nodeInfo:i.nodeInfo,x:i.x,y:i.y+100};n.push(s),setTimeout((function(){t.$refs.jsFlow.setNodePosition(s),t.moveNode(s)}),100)}})),this.canvasData.nodes.forEach((function(e){n.forEach((function(t){e.id===t.id&&(e.x=t.x,e.y=t.y)}))}))},deleteNode:function(){var e=this,t=this.deleteInfo.info.nodeInfo.id;this.clickSecond||(this.clickSecond=!0,this.$store.dispatch("deployCommon/deleteNode",t).then((function(t){e.deleteInfo.info.nodeInfo.is_draft||e.$bkMessage({message:e.$t('m.treeinfo["删除成功"]'),theme:"success"});for(var n=e.$refs.jsFlow.getConnectorsByNodeId(e.deleteInfo.info.id),i=[],o=0;o<n.length;o++)i.push({source:{arrow:"Left",id:n[o].sourceId},target:{arrow:"Left",id:n[o].targetId},lineInfo:{}});i.length&&e.updateLine(i,"delete"),e.$refs.jsFlow.removeNode(e.deleteInfo.info),e.closeDelete()})).catch((function(t){e.$bkMessage({message:t.data.msg,theme:"error"})})).finally((function(){e.clickSecond=!1})))},closeDelete:function(){this.deleteInfo.isShow=!1},configuNode:function(e){this.isReset=!1,this.$emit("configuNode",e),this.isReset=!0},onNodeMoveStop:function(e,t){if(e.x===this.currentNode.x&&e.y===this.currentNode.y)return this.canvasData.nodes.forEach((function(e){e.showMore=!1})),void this.canvasData.nodes.forEach((function(t){e.id===t.id&&(t.showMore=!0)}));for(var n=!1,i=0;i<this.canvasData.nodes.length;i++){var o=this.canvasData.nodes[i];if(e.id!==o.id){var a={x:o.x-e.x,y:o.y-e.y};if("NORMAL"===e.type||"ROUTER"===e.type||"TASK"===e.type){if("NORMAL"===o.type||"ROUTER"===o.type||"TASK"===o.type){if(a.x>=-150&&a.x<=150&&a.y>=-40&&a.y<=40){n=!0;break}}else if(a.x>=-40&&a.x<=150&&a.y>=-40&&a.y<=40){n=!0;break}}else if("NORMAL"===o.type||"ROUTER"===o.type||"TASK"===o.type){if(a.x>=-150&&a.x<=40&&a.y>=-40&&a.y<=40){n=!0;break}}else if(a.x>=-40&&a.x<=40&&a.y>=-40&&a.y<=40){n=!0;break}}}if(n){var s={id:e.id,x:this.stateNodeInfo.x,y:this.stateNodeInfo.y};this.$refs.jsFlow.setNodePosition(s);for(var r=0;r<this.canvasData.nodes.length;r++)e.id===this.canvasData.nodes[r].id&&(this.canvasData.nodes[r].x=this.stateNodeInfo.x,this.canvasData.nodes[r].y=this.stateNodeInfo.y)}else this.moveNode(e)},onNodeMoving:function(e,t){var n=e;n.x=t.pos[0],n.y=t.pos[1]},getBestArrow:function(e,t){var n=this,i={parent:[],parentLine:[],children:[],childrenLine:[]},o=[];this.canvasData.lines.forEach((function(e){var t=!1;n.canvasData.lines.forEach((function(n){e.source.id===n.target.id&&e.target.id===n.source.id&&(t=!0)})),t||o.push(e)})),o.forEach((function(t){e.id===t.target.id&&(i.parent.push(t.source.id),i.parentLine.push(t)),e.id===t.source.id&&(i.children.push(t.target.id),i.childrenLine.push(t))}));var a=["NORMAL","ROUTER","TASK","TASK-SOPS"],s=this.getEndPointInfo(e,a),r={},c={};i.parent.forEach((function(e){n.canvasData.nodes.forEach((function(t){e===t.id&&(r[e]=n.getEndPointInfo(t,a))}))})),i.children.forEach((function(e){n.canvasData.nodes.forEach((function(t){e===t.id&&(c[e]=n.getEndPointInfo(t,a))}))}));var l=[];i.parent.forEach((function(t){l=[],s.forEach((function(e){var n;r[t].forEach((function(t){l.push({cArrow:e.anchor,pArrow:t.anchor,distance:Math.pow(e.x-t.x,2)+Math.pow(e.y-t.y,2)})})),l=l.sort((n="distance",function(e,t){return e[n]-t[n]}))}));var i=l[0],o={source:{id:t},target:{id:e.id}};n.deleteBestLine(o,i)}));var d=[];i.children.forEach((function(t){d=[],s.forEach((function(e){var n;c[t].forEach((function(t){d.push({cArrow:t.anchor,pArrow:e.anchor,distance:Math.pow(e.x-t.x,2)+Math.pow(e.y-t.y,2)})})),d=d.sort((n="distance",function(e,t){return e[n]-t[n]}))}));var i=d[0],o={source:{id:e.id},target:{id:t}};n.deleteBestLine(o,i)}))},getEndPointInfo:function(e,t){return[{anchor:"Top",x:e.x+(t.some((function(t){return t===e.type}))?75:20),y:e.y},{anchor:"Left",x:e.x,y:e.y+20},{anchor:"Right",x:e.x+(t.some((function(t){return t===e.type}))?150:40),y:e.y+20},{anchor:"Bottom",x:e.x+(t.some((function(t){return t===e.type}))?75:20),y:e.y+40}]},deleteBestLine:function(e,t){var n=this;this.canvasData.lines.some((function(n){return n.source.id===e.source.id&&n.target.id===e.target.id&&n.source.arrow===t.pArrow&&n.target.arrow===t.cArrow}))||(this.$refs.jsFlow.removeConnector({source:{id:e.source.id},target:{id:e.target.id}}),this.canvasData.lines.forEach((function(i){if(i.source.id===e.source.id&&i.target.id===e.target.id){i.source.arrow=t.pArrow,i.target.arrow=t.cArrow;var o={source:{arrow:t.pArrow,id:e.source.id},target:{arrow:t.cArrow,id:e.target.id},lineInfo:i.lineInfo};n.$refs.jsFlow.createConnector(o);var a={source:o.source,target:o.target,lineInfo:o.lineInfo,id:i.lineInfo.id,name:i.lineInfo.name};n.lineOverlay(a)}})))},moveNode:function(e){var t=this,n={axis:{x:e.x,y:e.y}},i=e.nodeInfo.id;this.$store.dispatch("deployCommon/updateNodeAxis",{params:n,id:i}).then((function(e){})).catch((function(e){t.$bkMessage({message:e.data.msg,theme:"error"})}))}}},z=H,U=Object(p.a)(z,(function(){var e=this,t=e.$createElement,n=e._self._c||t;return e.isReset?n("div",{class:{"bk-second-flow":!0,"bk-full-page":e.isFullPage}},[n("bk-button",{staticClass:"bk-close-btn",attrs:{text:!0,icon:"close"},on:{click:function(t){e.isFullPage=!1,e.onResetPosition()}}}),e._v(" "),n("p",{staticClass:"bk-sla-text"},[e._v("“S”代表协议生效节点，“E”代表协议结束节点，不支持节点间交叉添加协议，提单节点不能为SLA起始节点")]),e._v(" "),n("js-flow",{ref:"jsFlow",attrs:{selector:"entry-item","endpoint-options":e.endpointOptions,"connector-options":e.connectorOptions,"node-options":e.nodeOptions,tools:e.toolsInfo[+e.isFullPage],editable:!1},on:{onToolClick:e.onToolClick,onConnectionClick:e.onConnectionClick,onConnection:e.onConnection,onConnectionDragStop:e.onConnectionDragStop,onBeforeDrop:e.onBeforeDrop,onNodeMoveStop:e.onNodeMoveStop,onNodeMoving:e.onNodeMoving},scopedSlots:e._u([{key:"nodeTemplate",fn:function(t){var i=t.node;return[n("div",{staticClass:"bk-sla-rect"},e._l(e.serviceAgreementList,(function(t,o){return n("span",{key:o},[t.start_node_id===i.nodeInfo.id?n("span",{staticClass:"bk-sla-se",style:"background: "+t.color,on:{click:function(n){return e.slaIconClick(t)},mouseenter:function(n){e.hoverSlaObj=t,e.updateCanvas()},mouseout:function(t){e.hoverSlaObj={},e.updateCanvas()}}},[e._v("S")]):e._e(),e._v(" "),t.end_node_id===i.nodeInfo.id?n("span",{staticClass:"bk-sla-se",style:"background: "+t.color,on:{click:function(n){return e.slaIconClick(t)},mouseenter:function(n){e.hoverSlaObj=t,e.updateCanvas()},mouseout:function(t){e.hoverSlaObj={},e.updateCanvas()}}},[e._v("E")]):e._e()])})),0),e._v(" "),n("node-template",{ref:"templateNode",class:{"bk-sla-hover-node-shadow":e.isHoverNode(i.nodeInfo.id)},attrs:{node:i,"canvas-data":e.canvasData},on:{configuNode:e.configuNode}})]}}],null,!1,3834796666),model:{value:e.canvasData,callback:function(t){e.canvasData=t},expression:"canvasData"}})],1):e._e()}),[],!1,null,"1e0fd9f6",null).exports,B=function(){var e=function(t,n){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},e(t,n)};return function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}(),W=function(e,t,n,i){var o,a=arguments.length,s=a<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,n,i);else for(var r=e.length-1;r>=0;r--)(o=e[r])&&(s=(a<3?o(s):a>3?o(t,n,s):o(t,n))||s);return a>3&&s&&Object.defineProperty(t,n,s),s},q=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.formData={serviceName:"",serviceType:"",serviceProcess:"",processVersion:"",visibleRange:"",serviceManager:[],serviceCatalog:[],desc:""},t.rules={serviceName:[{required:!0,message:"必填项",trigger:"blur"}],serviceType:[{required:!0,message:"必填项",trigger:"blur"}],serviceProcess:[{required:!0,message:"必填项",trigger:"blur"}],processVersion:[{required:!0,message:"必填项",trigger:"blur"}],serviceManager:[{required:!0,message:"必填项",trigger:"blur"}]},t.visibleRangeData=[{type:"OPEN",value:"OPEN",visibleRangeList:[{name:"不限",key:"OPEN",disabled:!1},{name:"组织架构",key:"ORGANIZATION",disabled:!1},{name:"通用角色",key:"GENERAL",disabled:!1},{name:"个人",key:"PERSON",disabled:!1}]}],t.organizationList=[],t.genericRoleList=[],t.serviceManagerList=[],t.directoryList=[],t.serviceTypeList=[],t.serviceProcessList=[],t.processVersionList=[],t.icons=["icon-right-shape","icon-down-shape"],t.enableSla=!1,t.slaLoading=!1,t.allSla="",t.nodeSlaList=[],t.flowSlaList=[],t.pageLoading=!1,t.beginNodeList=[],t.addList=[],t.lineList=[],t.previewInfo={canClick:!1,narrowSize:.9},t}return B(t,e),Object.defineProperty(t.prototype,"isAdd",{get:function(){return"add"===this.operateType},enumerable:!1,configurable:!0}),t.prototype.mounted=function(){this.serviceManagerList=sessionStorage.getItem("allUserData")?JSON.parse(sessionStorage.getItem("allUserData")):[],this.getServiceCategories(),this.getAllWorkFlow(),this.getServiceCatalogsList(),this.getGeneralRoles(),"{}"!==JSON.stringify(this.serviceDetail)?this.initData():this.getRootOrganization()},t.prototype.initData=function(){var e=this;this.formData={serviceName:this.serviceDetail.name,serviceType:this.serviceDetail.key,serviceProcess:"",processVersion:"",visibleRange:"",serviceManager:this.serviceDetail.owners.split(","),serviceCatalog:[],desc:this.serviceDetail.desc},this.enableSla=!!this.serviceDetail.sla.length,this.serviceDetail.sla.forEach((function(t){-1!==t.end_node_id?e.nodeSlaList.push({id:e.$random(5),sla:t}):e.allSla=t})),this.flowSlaList=this.nodeSlaList.map((function(e){return e.sla})),this.visibleRangeData[0].type=this.serviceDetail.display_type,this.visibleRangeData[0].value="OPEN"===this.serviceDetail.display_type?"OPEN":this.serviceDetail.display_role.split(",").map((function(t){return"PERSON"===e.serviceDetail.display_type?t:Number(t)}));var t=!0;if("ORGANIZATION"===this.visibleRangeData[0].type&&(this.getRootOrganization({route_organizations:this.visibleRangeData[0].value.join(",")}),t=!1),this.serviceDetail.extra_info.display_info.length){var n=this.serviceDetail.extra_info.display_info.find((function(e){return"ORGANIZATION"===e.type}));n?t&&this.getRootOrganization({route_organizations:n.value}):t&&this.getRootOrganization()}else t&&this.getRootOrganization()},t.prototype.confirm=function(){var e=this;this.$refs.validateForm.validate().then((function(){var t=e.formData.serviceCatalog.map((function(e){return Number(e.at(-1))})),n={name:e.formData.serviceName,workflow:e.formData.processVersion,sla:[].concat(e.flowSlaList),key:e.formData.serviceType,can_ticket_agency:!1,sla_is_active:e.enableSla,desc:e.formData.desc,is_valid:!0,admin:e.formData.serviceManager,owners:e.formData.serviceManager.join(","),change_is_active:!1,display_type:"OPEN",display_role:"0",extra_info:{articles:[],change_is_active:!1,display_info:[],is_share:!1,ops_type:"OPEN",outer_info:"",type:"service",value:"el-icon-user"},catalog_ids:t};e.allSla&&n.sla.push(e.allSla),"OPEN"!==e.visibleRangeData[0].type&&(n.display_type=e.visibleRangeData[0].type,Array.isArray(e.visibleRangeData[0].value)?"ORGANIZATION"===e.visibleRangeData[0].type?n.display_role=e.visibleRangeData[0].value.map((function(e){return e[e.length-1]})).join(","):n.display_role=e.visibleRangeData[0].value.join(","):n.display_role=e.visibleRangeData[0].value),e.visibleRangeData.length>1&&(n.extra_info.display_info=e.visibleRangeData.filter((function(e){return e.type})).slice(1).map((function(e){var t="";return t="ORGANIZATION"===e.type?e.value.map((function(e){return e[e.length-1]})).join(","):e.value.join(","),{type:e.type,value:t}})));var i=e.isAdd?"createService":"updateService";e.isAdd||(n.id=e.serviceDetail.id),e.pageLoading=!0,e.$api.serviceDeskManage[i](n).then((function(t){var n=t.result,i=t.message;if(!n)return e.$error(i),!1;e.$success("".concat(e.isAdd?"新建":"编辑","成功")),e.$emit("set-current-type","table")})).finally((function(){e.pageLoading=!1}))}))},t.prototype.setServiceAgreement=function(e){if("all"===e.type)this.allSla=e.value;else{var t=this.nodeSlaList.findIndex((function(t){return t.id===e.id}));-1===t?this.nodeSlaList.push({id:e.id,sla:e.value}):this.nodeSlaList[t].sla=e.value,this.flowSlaList=this.nodeSlaList.map((function(e){return e.sla}))}},t.prototype.delAllSla=function(){this.allSla=""},t.prototype.delNodeSla=function(e){this.nodeSlaList.splice(e,1),this.flowSlaList=this.nodeSlaList.map((function(e){return e.sla}))},t.prototype.getGeneralRoles=function(){var e=this;this.$api.serviceDeskManage.getGeneralRoles().then((function(t){var n=t.result,i=t.data;if(!n)return!1;e.genericRoleList=i}))},t.prototype.changeProcessVersion=function(){var e=this;if(!this.formData.processVersion)return!1;this.slaLoading=!0,Promise.all([this.getWorkFlowVersionStates(),this.getWorkFlowVersionTransition(),this.getWorkFlowVersionGroup()]).then((function(t){var n=t[0],i=t[1],o=t[2];e.addList=n.data;for(var a=0;a<e.addList.length;a++)e.addList[a].indexInfo=a;e.lineList=i.data.items,e.beginNodeList=o.data})).finally((function(){e.slaLoading=!1}))},t.prototype.getWorkFlowVersionStates=function(){return this.$api.serviceDeskManage.getWorkFlowVersionStates({id:this.formData.processVersion})},t.prototype.getWorkFlowVersionTransition=function(){return this.$api.serviceDeskManage.getWorkFlowVersionTransition({id:this.formData.processVersion})},t.prototype.getWorkFlowVersionGroup=function(){return this.$api.serviceDeskManage.getWorkFlowVersionGroup({id:this.formData.processVersion})},t.prototype.getRootOrganization=function(e){var t=this;this.$api.serviceDeskManage.getRootOrganization(e).then((function(e){var n=e.result,i=e.data;if(!n)return!1;t.organizationList=i.organizations,t.isAdd||(t.serviceDetail.extra_info.display_info.forEach((function(e){t.addVisibleRange(e)})),t.$nextTick((function(){t.visibleRangeData.forEach((function(e){"ORGANIZATION"===e.type&&(e.value=i.organizations_routes)}))})))}))},t.prototype.getOrganizationChildren=function(e,t){!1===e.isLoading?t(e):(this.$set(e,"isLoading",!0),this.$api.serviceDeskManage.getOrganizationChildren({parent_id:e.id}).then((function(n){var i=n.result,o=n.data;if(!i)return!1;e.children=o,t(e)})))},t.prototype.getServiceCatalogsList=function(){var e=this;this.$api.serviceDeskManage.getServiceCatalogsList().then((function(t){var n=t.result,i=t.data;if(!n)return!1;if(e.directoryList=i,!e.isAdd){var o=[];e.serviceDetail.bounded_relations.forEach((function(t){var n=e.directoryList.find((function(e){return e.id===t.catalog_id}));n?o.push([String(n.id)]):e.directoryList.forEach((function(e){e.children.forEach((function(n){n.id===t.catalog_id&&o.push([String(e.id),String(n.id)])}))}))})),e.$nextTick((function(){e.formData.serviceCatalog=o}))}}))},t.prototype.getWorkFlowVersions=function(){var e=this;if(this.formData.processVersion="",!this.formData.serviceProcess)return!1;this.isAdd||(this.formData.processVersion=this.serviceDetail.workflow);var t=this.serviceProcessList.find((function(t){return t.id===e.formData.serviceProcess}));this.$api.serviceDeskManage.getAllVersions({name:t.name}).then((function(t){var n=t.result,i=t.data;if(!n)return!1;e.processVersionList=i}))},t.prototype.getAllWorkFlow=function(){var e=this;this.$api.serviceDeskManage.getAllWorkFlow().then((function(t){var n,i=t.result,o=t.data;if(!i)return!1;e.serviceProcessList=o,e.isAdd||(e.formData.serviceProcess=null===(n=e.serviceProcessList.find((function(t){return t.name===e.serviceDetail.workflow_name})))||void 0===n?void 0:n.id)}))},t.prototype.getServiceCategories=function(){var e=this;this.$api.serviceDeskManage.getServiceCategories().then((function(t){var n=t.result,i=t.data;if(!n)return!1;e.serviceTypeList=i}))},t.prototype.operateServiceAgreement=function(e,t,n){this.$refs.serviceAgreement.show(e,t,n)},t.prototype.addVisibleRange=function(e){if(["OPEN","API"].includes(this.visibleRangeData[0].type))return this.$error("可见范围已设置为”不限“或“权限中心”，无需再添加"),!1;if(this.visibleRangeData.find((function(e){return!e.type})))return this.$error("请先完善已添加的可见范围"),!1;this.visibleRangeData.push({type:e?e.type:"",value:e?e.value.split(",").map((function(t){return"PERSON"===e.type?t:Number(t)})):"",visibleRangeList:[{name:"组织架构",key:"ORGANIZATION",disabled:!1},{name:"通用角色",key:"GENERAL",disabled:!1},{name:"个人",key:"PERSON",disabled:!1}]}),this.setVisibleRangeStatus()},t.prototype.setVisibleRangeStatus=function(){var e=this;this.visibleRangeData.forEach((function(t){t.visibleRangeList.forEach((function(n){n.disabled=e.visibleRangeData.find((function(e){return e.type===n.key}))&&n.key!==t.type}))}))},t.prototype.delVisibleRange=function(e){if(0===e)return!1;this.visibleRangeData.splice(e,1)},t.prototype.changeVisibleRange=function(e){"OPEN"!==e.type&&(e.value=[]),["OPEN","API"].includes(e.type)&&(this.visibleRangeData=this.visibleRangeData.slice(0,1),this.visibleRangeData[0].type=e.type,this.visibleRangeData[0].value=e.type),this.setVisibleRangeStatus()},t.prototype.goBack=function(){var e=this;this.$bkInfo({type:"warning",title:"确认返回？",subTitle:"数据发生更改，确认后将不保存修改的数据！",confirmFn:function(){e.$emit("set-current-type","table")}})},W([Object(o.d)({type:String,default:function(){return"add"}})],t.prototype,"operateType",void 0),W([Object(o.d)({type:Object,default:function(){}})],t.prototype,"serviceDetail",void 0),t=W([Object(o.a)({name:"operateService",components:{serviceAgreement:h,secondFlow:U}})],t)}(o.e),G=q,K=Object(p.a)(G,(function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",{directives:[{name:"bkloading",rawName:"v-bkloading",value:{isLoading:e.pageLoading,zIndex:10},expression:"{ isLoading: pageLoading, zIndex: 10 }"}],staticClass:"operate-service"},[n("div",{staticClass:"box-header"},[n("bk-icon",{staticClass:"mr10",attrs:{type:"arrows-left-shape"},on:{click:e.goBack}}),e._v(" "),n("span",{staticStyle:{"font-size":"16px"}},[e._v(e._s(e.isAdd?"新建服务":"编辑服务"))])],1),e._v(" "),n("div",{staticClass:"main-box"},[n("bk-card",{attrs:{title:"基础信息","is-collapse":!0,"collapse-icons":e.icons}},[n("bk-form",{ref:"validateForm",attrs:{"label-width":95,model:e.formData,rules:e.rules}},[n("div",{staticClass:"form-box"},[n("div",{staticClass:"form-item"},[n("bk-form-item",{attrs:{label:"服务名称",required:!0,property:"serviceName"}},[n("bk-input",{attrs:{placeholder:"请输入服务名称"},model:{value:e.formData.serviceName,callback:function(t){e.$set(e.formData,"serviceName",t)},expression:"formData.serviceName"}})],1)],1),e._v(" "),n("div",{staticClass:"form-item"},[n("bk-form-item",{attrs:{label:"服务类型",required:!0,property:"serviceType"}},[n("bk-select",{attrs:{placeholder:"请选择服务类型",clearable:!1,searchable:""},model:{value:e.formData.serviceType,callback:function(t){e.$set(e.formData,"serviceType",t)},expression:"formData.serviceType"}},e._l(e.serviceTypeList,(function(e){return n("bk-option",{key:e.key,attrs:{id:e.key,disabled:!e.is_enabled,name:e.name}})})),1)],1)],1)]),e._v(" "),n("div",{staticClass:"form-box"},[n("div",{staticClass:"form-item"},[n("bk-form-item",{attrs:{label:"服务流程",required:!0,property:"serviceProcess"}},[n("bk-select",{attrs:{placeholder:"请选择服务流程",searchable:""},on:{change:e.getWorkFlowVersions},model:{value:e.formData.serviceProcess,callback:function(t){e.$set(e.formData,"serviceProcess",t)},expression:"formData.serviceProcess"}},e._l(e.serviceProcessList,(function(e){return n("bk-option",{key:e.id,attrs:{id:e.id,name:e.name}})})),1)],1)],1),e._v(" "),n("div",{staticClass:"form-item"},[n("bk-form-item",{attrs:{label:"流程版本",required:!0,property:"processVersion"}},[n("bk-select",{attrs:{placeholder:"请选择流程版本",searchable:""},on:{change:e.changeProcessVersion},model:{value:e.formData.processVersion,callback:function(t){e.$set(e.formData,"processVersion",t)},expression:"formData.processVersion"}},e._l(e.processVersionList,(function(e){return n("bk-option",{key:e.id,attrs:{id:e.id,name:e.version_number}})})),1)],1)],1)]),e._v(" "),n("bk-form-item",{attrs:{label:"可见范围",required:!0,property:"visibleRange"}},e._l(e.visibleRangeData,(function(t,i){return n("div",{key:t.type,staticClass:"select-range-box"},[n("bk-select",{style:{width:["OPEN","API"].includes(t.type)||!t.type?"100%":"200px"},attrs:{clearable:!1},on:{change:function(n){return e.changeVisibleRange(t)}},model:{value:t.type,callback:function(n){e.$set(t,"type",n)},expression:"item.type"}},e._l(t.visibleRangeList,(function(e){return n("bk-option",{key:e.key,attrs:{id:e.key,disabled:e.disabled,name:e.name}})})),1),e._v(" "),"ORGANIZATION"===t.type?n("bk-cascade",{staticStyle:{flex:"1"},attrs:{list:e.organizationList,clearable:"",multiple:"","limit-one-line":!0,"check-any-level":!0,"is-remote":!0,"remote-method":e.getOrganizationChildren,"ext-popover-cls":"custom-cls"},model:{value:t.value,callback:function(n){e.$set(t,"value",n)},expression:"item.value"}}):e._e(),e._v(" "),["GENERAL","PERSON"].includes(t.type)?n("bk-select",{staticStyle:{flex:"1"},attrs:{multiple:"","search-placeholder":"请输入","search-with-pinyin":!0,"ext-cls":"select-custom","ext-popover-cls":"select-popover-custom",searchable:"","enable-virtual-scroll":"",list:"GENERAL"===t.type?e.genericRoleList:e.serviceManagerList,"id-key":"GENERAL"===t.type?"id":"key","display-key":"GENERAL"===t.type?"name":"display"},model:{value:t.value,callback:function(n){e.$set(t,"value",n)},expression:"item.value"}}):e._e(),e._v(" "),n("div",{staticClass:"icon-box"},[n("bk-icon",{staticClass:"mr5",attrs:{type:"plus-circle"},on:{click:function(t){return e.addVisibleRange("")}}}),e._v(" "),n("bk-icon",{class:[0===i&&"not-allow"],attrs:{type:"minus-circle"},on:{click:function(t){return e.delVisibleRange(i)}}})],1)],1)})),0),e._v(" "),n("bk-form-item",{attrs:{label:"服务负责人",required:!0,property:"serviceManager"}},[n("bk-select",{attrs:{multiple:"","search-placeholder":"请输入","search-with-pinyin":!0,"ext-cls":"select-custom","ext-popover-cls":"select-popover-custom",searchable:"","enable-virtual-scroll":"",list:e.serviceManagerList,"id-key":"key","display-key":"display"},model:{value:e.formData.serviceManager,callback:function(t){e.$set(e.formData,"serviceManager",t)},expression:"formData.serviceManager"}})],1),e._v(" "),n("bk-form-item",{attrs:{label:"所属目录"}},[n("bk-cascade",{attrs:{list:e.directoryList,clearable:"",multiple:"","check-any-level":!0,"ext-popover-cls":"custom-cls"},model:{value:e.formData.serviceCatalog,callback:function(t){e.$set(e.formData,"serviceCatalog",t)},expression:"formData.serviceCatalog"}})],1),e._v(" "),n("bk-form-item",{attrs:{label:"服务说明"}},[n("bk-input",{attrs:{type:"textarea",rows:3,maxlength:100},model:{value:e.formData.desc,callback:function(t){e.$set(e.formData,"desc",t)},expression:"formData.desc"}})],1)],1)],1),e._v(" "),n("bk-card",{attrs:{title:"SLA协议","is-collapse":!0,"collapse-icons":e.icons}},[n("div",{staticClass:"bk-sla-content"},[n("span",[e._v("是否启用")]),e._v(" "),n("bk-switcher",{attrs:{theme:"primary"},model:{value:e.enableSla,callback:function(t){e.enableSla=t},expression:"enableSla"}}),e._v(" "),n("bk-icon",{attrs:{type:"info-circle"}}),e._v(" "),n("span",{staticStyle:{color:"#979BA5"}},[e._v("可以通过点击添加“+”或点击流程节点添加")])],1),e._v(" "),e.enableSla?n("div",[n("div",{staticClass:"bk-sla-content"},[n("span",[e._v("整体服务协议")]),e._v(" "),n("span",{staticClass:"bk-required-icon"},[e._v("*")]),e._v(" "),n("bk-button",{staticClass:"mr10",attrs:{theme:"default",icon:"plus"},on:{click:function(t){return e.operateServiceAgreement("all","add")}}},[e._v("添加")]),e._v(" "),e.allSla?n("div",{staticClass:"sla-tag",on:{click:function(t){return e.operateServiceAgreement("all","edit",e.allSla)}}},[n("div",{staticClass:"color-tag",style:{backgroundColor:e.allSla.color}}),e._v(" "),n("div",{directives:[{name:"bk-overflow-tips",rawName:"v-bk-overflow-tips"}],staticClass:"content hide-text"},[e._v("\n                            "+e._s(e.allSla.name)+"\n                        ")]),e._v(" "),n("bk-icon",{attrs:{type:"delete"},on:{click:function(t){return t.stopPropagation(),e.delAllSla.apply(null,arguments)}}})],1):e._e()],1),e._v(" "),n("div",{staticClass:"bk-sla-content"},[n("span",[e._v("节点服务协议")]),e._v(" "),n("span",{staticClass:"bk-required-icon"},[e._v("*")]),e._v(" "),n("bk-button",{staticClass:"mr10",attrs:{theme:"default",icon:"plus"},on:{click:function(t){return e.operateServiceAgreement("node","add")}}},[e._v("添加")]),e._v(" "),e.nodeSlaList.length?n("div",{staticStyle:{display:"flex"}},e._l(e.nodeSlaList,(function(t,i){return n("div",{key:t.id,staticClass:"sla-tag",on:{click:function(n){return e.operateServiceAgreement("node","edit",t)}}},[n("div",{staticClass:"color-tag",style:{backgroundColor:t.sla.color}}),e._v(" "),n("div",{directives:[{name:"bk-overflow-tips",rawName:"v-bk-overflow-tips"}],staticClass:"content hide-text"},[e._v("\n                                "+e._s(t.sla.name)+"\n                            ")]),e._v(" "),n("bk-icon",{attrs:{type:"delete"},on:{click:function(t){return t.stopPropagation(),e.delNodeSla(i)}}})],1)})),0):e._e()],1),e._v(" "),n("div",{directives:[{name:"bkloading",rawName:"v-bkloading",value:{isLoading:e.slaLoading},expression:"{ isLoading: slaLoading }"}],staticStyle:{height:"420px"}},[e.slaLoading?e._e():n("second-flow",{ref:"flowInfo",attrs:{"add-list":e.addList,"line-list":e.lineList,"flow-info":e.previewInfo,"service-agreement-list":e.flowSlaList}})],1)]):e._e()]),e._v(" "),n("div",{staticClass:"foot-box"},[n("bk-button",{attrs:{theme:"default",type:"submit"},on:{click:e.goBack}},[e._v("\n                取消\n            ")]),e._v(" "),n("bk-button",{staticClass:"mr10",attrs:{theme:"primary"},on:{click:e.confirm}},[e._v("\n                确认\n            ")])],1)],1),e._v(" "),n("service-agreement",{ref:"serviceAgreement",attrs:{"begin-node-list":e.beginNodeList,"process-version":e.formData.processVersion},on:{"set-service-agreement":e.setServiceAgreement}})],1)}),[],!1,null,"01859688",null),Z=K.exports,X=function(){var e=function(t,n){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},e(t,n)};return function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}(),Y=function(e,t,n,i){var o,a=arguments.length,s=a<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,n,i);else for(var r=e.length-1;r>=0;r--)(o=e[r])&&(s=(a<3?o(s):a>3?o(t,n,s):o(t,n))||s);return a>3&&s&&Object.defineProperty(t,n,s),s},J=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.batchUpdateVisible=!1,t.batchUpdateVersion="",t.batchUpdateLoading=!1,t}return X(t,e),t.prototype.show=function(){this.batchUpdateVisible=!0,this.batchUpdateVersion=""},t.prototype.confirmBatchUpdate=function(){var e=this;if(this.selectData.length-this.cannotUpdateList.length==0)return this.closeBatchUpdate(),!1;if(!this.batchUpdateVersion&&0!==this.batchUpdateVersion)return this.$warn("请选择流程版本"),!1;this.batchUpdateLoading=!0;var t={id:this.selectData.filter((function(e){return"service"===e.extra_info.type&&!e.is_builtin})).map((function(e){return e.id})).join(","),wv_id:this.batchUpdateVersion};this.$api.serviceDeskManage.batchUpdateService(t).then((function(t){var n=t.result,i=t.message;if(!n)return e.$error(i),!1;e.$emit("refresh-list",!0),e.$success("批量更新成功"),e.closeBatchUpdate()})).finally((function(){e.batchUpdateLoading=!1}))},t.prototype.closeBatchUpdate=function(){this.batchUpdateVisible=!1},Y([Object(o.d)({type:Array,default:function(){return[]}})],t.prototype,"selectData",void 0),Y([Object(o.d)({type:Array,default:function(){return[]}})],t.prototype,"cannotUpdateList",void 0),Y([Object(o.d)({type:Array,default:function(){return[]}})],t.prototype,"processVersionList",void 0),t=Y([Object(o.a)({name:"batch-update"})],t)}(o.e),Q=J,ee=Object(p.a)(Q,(function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("bk-dialog",{attrs:{"mask-close":!1,"header-position":"left",title:"请选择更新流程版本"},model:{value:e.batchUpdateVisible,callback:function(t){e.batchUpdateVisible=t},expression:"batchUpdateVisible"}},[n("div",[n("div",{staticClass:"mb20"},[e._v("\n            已勾选"+e._s(e.selectData.length)+" 条，其中 "+e._s(e.cannotUpdateList.length)+" 条为非流程服务或内置服务，\n            不可进行更新操作；可更新"+e._s(e.selectData.length-e.cannotUpdateList.length)+"条。\n        ")]),e._v(" "),n("bk-select",{attrs:{placeholder:"请选择流程版本",searchable:""},model:{value:e.batchUpdateVersion,callback:function(t){e.batchUpdateVersion=t},expression:"batchUpdateVersion"}},e._l(e.processVersionList,(function(e){return n("bk-option",{key:e.id,attrs:{id:e.id,name:e.name}})})),1)],1),e._v(" "),n("template",{slot:"footer"},[n("bk-button",{staticClass:"mr10",attrs:{loading:e.batchUpdateLoading,theme:"primary",title:"确认"},on:{click:e.confirmBatchUpdate}},[e._v("\n            确认\n        ")]),e._v(" "),n("bk-button",{attrs:{theme:"default",type:"submit",title:"取消"},on:{click:e.closeBatchUpdate}},[e._v("\n            取消\n        ")])],1)],2)}),[],!1,null,null,null).exports,te=function(){var e=function(t,n){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},e(t,n)};return function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}(),ne=function(e,t,n,i){var o,a=arguments.length,s=a<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,n,i);else for(var r=e.length-1;r>=0;r--)(o=e[r])&&(s=(a<3?o(s):a>3?o(t,n,s):o(t,n))||s);return a>3&&s&&Object.defineProperty(t,n,s),s},ie=function(e,t,n,i){return new(n||(n=Promise))((function(o,a){function s(e){try{c(i.next(e))}catch(e){a(e)}}function r(e){try{c(i.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))},oe=function(e,t){var n,i,o,a,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:r(0),throw:r(1),return:r(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function r(a){return function(r){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,i&&(o=2&a[0]?i.return:a[0]?i.throw||((o=i.return)&&o.call(i),0):i.next)&&!(o=o.call(i,a[1])).done)return o;switch(i=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return s.label++,{value:a[1],done:!1};case 5:s.label++,i=a[1],a=[0];continue;case 7:a=s.ops.pop(),s.trys.pop();continue;default:if(!(o=s.trys,(o=o.length>0&&o[o.length-1])||6!==a[0]&&2!==a[0])){s=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){s.label=a[1];break}if(6===a[0]&&s.label<o[1]){s.label=o[1],o=a;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(a);break}o[2]&&s.ops.pop(),s.trys.pop();continue}a=t.call(e,s)}catch(e){a=[6,e],i=0}finally{n=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,r])}}},ae=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.searchWord="",t.selectData=[],t.tableData=[],t.columns=[{type:"selection",width:"50px"},{label:"ID",key:"id",align:"left",width:"50px"},{label:"服务名称",key:"name",align:"left",minWidth:"150px"},{label:"关联信息",key:"relate_info",align:"left",minWidth:"230px",scopedSlots:"relate_info"},{label:"服务负责人",key:"owners_display",align:"left",minWidth:"110px"},{label:"关联目录",key:"bounded_catalogs",align:"left",minWidth:"110px",scopedSlots:"bounded_catalogs"},{label:"服务说明",key:"desc",align:"left",minWidth:"150px"},{label:"创建人",key:"creator",align:"left",minWidth:"80px"},{label:"更新人",key:"updated_by",align:"left",minWidth:"80px"},{label:"更新时间",key:"update_at",align:"left",minWidth:"150px"},{label:"状态",key:"is_valid",align:"left",minWidth:"80px",scopedSlots:"is_valid"},{label:"操作",key:"operation",align:"left",minWidth:"110px",fixed:"right",scopedSlots:"operation"}],t.pagination={current:1,count:1,limit:20},t.tableLoading=!1,t.showType={service:"表单服务",SELFSERVICE:"自助服务",SAAS:"第三方应用"},t.maxHeight="",t.currentType="table",t.operateType="add",t.processVersionList=[],t.cannotUpdateList=[],t.serviceDetail={},t}return te(t,e),t.prototype.mounted=function(){var e=this;this.maxHeight=window.innerHeight-237,window.onresize=function(){e.maxHeight=window.innerHeight-237},this.getServiceList(),this.getWorkFlowVersions()},t.prototype.handlePageChange=function(e){this.pagination.current=e,this.getServiceList()},t.prototype.limitChange=function(e){this.pagination.current=1,this.pagination.limit=e,this.getServiceList()},t.prototype.getWorkFlowVersions=function(){var e=this;this.$api.serviceDeskManage.getAllVersions().then((function(t){var n=t.result,i=t.message,o=t.data;if(!n)return e.$error(i),!1;e.processVersionList=o.map((function(e){return e.name=e.name+" - "+e.version_number,e}))}))},t.prototype.batchUpdateService=function(){this.$refs.batchUpdate.show()},t.prototype.batchDelService=function(){var e=this,t=this.$createElement,n=this.selectData.filter((function(e){return e.is_builtin||e.bounded_catalogs.length})).map((function(e){return e.name}));this.$bkInfo({type:"warning",title:"是否批量删除服务？",subHeader:t("div",{style:{"font-size":"14px","white-space":"normal"}},"已勾选".concat(this.selectData.length,"条，其中").concat(n.length,"条已绑定服务目录或为内置服务，不可删除；可删除 ").concat(this.selectData.length-n.length," 条。")),confirmFn:function(){e.confirmBatchDel(n)}})},t.prototype.confirmBatchDel=function(e){var t=this;if(this.selectData.length-e.length==0)return!0;var n=this.selectData.map((function(e){if(!e.is_builtin&&!e.bounded_catalogs.length)return e.id}));this.tableLoading=!0,this.$api.serviceDeskManage.batchDelService({ids:n.join(",")}).then((function(n){var i=n.result,o=n.message;if(!i)return t.$error(o),!1;t.$success("可删除"+(t.selectData.length-e.length)+"条，成功删除"+(t.selectData.length-e.length)+"条。"),t.selectData=[],t.getServiceList()})).finally((function(){t.tableLoading=!1}))},t.prototype.delService=function(e){var t=this,n=this.$createElement;this.$bkInfo({type:"warning",subHeader:n("div",{style:{"font-size":"14px"}},"是否删除服务：".concat(e.name,"?")),confirmFn:function(){return ie(t,void 0,void 0,(function(){return oe(this,(function(t){switch(t.label){case 0:return[4,this.confirmDelService(e)];case 1:return t.sent(),[2]}}))}))}})},t.prototype.confirmDelService=function(e){return ie(this,void 0,void 0,(function(){var t;return oe(this,(function(n){switch(n.label){case 0:return n.trys.push([0,2,,3]),[4,this.$api.serviceDeskManage.batchDelService({ids:e.id})];case 1:return(t=n.sent()).result?(this.$success("删除成功!"),this.pagination.current>1&&1===this.tableData.length&&this.pagination.current--,this.getServiceList()):this.$error(t.message),[2,!0];case 2:return n.sent(),[2,!1];case 3:return[2]}}))}))},t.prototype.setCurrentType=function(e){this.currentType=e,this.serviceDetail={},this.getServiceList()},t.prototype.operateService=function(e,t){this.currentType="operate",this.operateType=e,t&&(this.serviceDetail=t)},t.prototype.selectTable=function(e){this.selectData=e,this.cannotUpdateList=this.selectData.filter((function(e){return"service"!==e.extra_info.type||e.is_builtin})).map((function(e){return e.name}))},t.prototype.getServiceList=function(e){var t=this;e&&(this.selectData=[]),this.tableLoading=!0;var n={page:this.pagination.current,page_size:this.pagination.limit,name:this.searchWord.trim()};this.$api.serviceDeskManage.getServiceList(n).then((function(e){var n=e.result,i=e.message,o=e.data;if(!n)return t.$error(i),!1;t.tableData=o.items,t.pagination.count=o.count})).finally((function(){t.tableLoading=!1}))},t=ne([Object(o.a)({name:"service-list",components:{comTable:c.a,operateService:Z,batchUpdate:ee}})],t)}(o.e),se=ae,re=Object(p.a)(se,(function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",{directives:[{name:"bkloading",rawName:"v-bkloading",value:{isLoading:e.tableLoading,zIndex:10},expression:"{ isLoading: tableLoading, zIndex: 10 }"}],staticClass:"service-list"},["table"===e.currentType?n("div",{staticClass:"service-table"},[n("div",{staticClass:"action-bar"},[n("div",[n("bk-button",{staticClass:"mr10",attrs:{theme:"primary"},on:{click:function(t){return e.operateService("add")}}},[e._v("\n                    新增\n                ")]),e._v(" "),n("bk-button",{staticClass:"mr10",attrs:{theme:"default",disabled:!e.selectData.length},on:{click:e.batchDelService}},[e._v("\n                    批量删除\n                ")]),e._v(" "),n("bk-button",{attrs:{theme:"default",disabled:!e.selectData.length},on:{click:e.batchUpdateService}},[e._v("\n                    批量更新流程版本\n                ")])],1),e._v(" "),n("bk-input",{staticStyle:{width:"250px"},attrs:{clearable:"",placeholder:"请输入服务名","right-icon":"bk-icon icon-search"},on:{enter:e.getServiceList,clear:e.getServiceList,"right-icon-click":e.getServiceList},model:{value:e.searchWord,callback:function(t){e.searchWord=t},expression:"searchWord"}})],1),e._v(" "),n("com-table",{ref:"sourceTable",attrs:{id:"center_table",data:e.tableData,"max-height":e.maxHeight,pagination:e.pagination,columns:e.columns},on:{"select-all":e.selectTable,select:e.selectTable,"page-change":e.handlePageChange,"page-limit-change":e.limitChange},scopedSlots:e._u([{key:"relate_info",fn:function(t){var i=t.row;return["service"===i.extra_info.type?n("span",[e._v("\n                    "+e._s(i.workflow_name)+" ("+e._s(i.version_number)+" )\n                ")]):n("span",[e._v("\n                    "+e._s(i.outer_info)+"\n                ")])]}},{key:"bounded_catalogs",fn:function(t){var i=t.row;return[n("span",[e._v(e._s(i.bounded_catalogs.join(",")||"--"))])]}},{key:"is_valid",fn:function(t){var i=t.row;return[n("span",{staticClass:"bk-status-color",class:{"bk-status-gray":!i.is_valid}}),e._v(" "),n("span",{staticStyle:{"margin-left":"5px"}},[e._v("\n                    "+e._s(i.is_valid?"":"关闭")+"\n                ")]),e._v("启用\n            ")]}},{key:"operation",fn:function(t){var i=t.row;return[n("bk-button",{staticClass:"mr10",attrs:{theme:"primary",text:""},on:{click:function(t){return e.operateService("edit",i)}}},[e._v("\n                    修改\n                ")]),e._v(" "),n("bk-button",{staticClass:"mr10",attrs:{disabled:!!i.bounded_catalogs.length||i.is_builtin,theme:"primary",text:""},on:{click:function(t){return e.delService(i)}}},[e._v("\n                    删除\n                ")])]}}],null,!1,2884768181)})],1):n("operate-service",{attrs:{"operate-type":e.operateType,"service-detail":e.serviceDetail},on:{"set-current-type":e.setCurrentType}}),e._v(" "),n("batch-update",{ref:"batchUpdate",attrs:{"select-data":e.selectData,"cannot-update-list":e.cannotUpdateList,"process-version-list":e.processVersionList},on:{"refresh-list":e.getServiceList}})],1)}),[],!1,null,"05b286d0",null).exports,ce=(n("Oyvg"),n("KKXr"),n("ynI1")),le=n("5WJX"),de=n.n(le),ue=(n("RsPH"),n("Aw8l"),n("CQIl"),n("hOyB"),n("Qjfq"),n("Tqh3"),n("w9f+"),n("Kwdf"),n("0tw5"),n("66wf"),n("iGOs"),n("YuVX"),n("DvpE"),n("Nl51"),n("ZNhe"),n("5FW9"),n("S9Dz"),n("7anz"),n("aVf9"),n("B9FH"),n("hVuo"),n("vFQT"),n("eOTG"),n("B9f7"),n("A0Is"),n("Oy60"),n("iexR"),n("g4hL"),n("jQwD"),{name:"rich-text",components:{Editor:ce.a},props:{tinyValue:{type:String,default:""}},data:function(){var e=this;return{tinymceHtml:"",tinymceId:"vue-tinymce-"+ +new Date+(1e3*Math.random()).toFixed(0),editor:{},accept:"image/jpeg, image/png,image/jpg",maxSize:2097152,setting:{branding:!1,resize:!1,height:450,language_url:window.STATIC_URL+"tinymce/static/langs/zh_CN.js",language:"zh_CN",menubar:"edit insert format table",external_plugins:{codesample:window.STATIC_URL+"tinymce/static/codesample/plugin.min.js",powerpaste:window.STATIC_URL+"tinymce/static/powerpaste/plugin.min.js"},skin_url:window.STATIC_URL+"tinymce/skins/ui/oxide",content_css:window.STATIC_URL+"tinymce/skins/content/default/content.min.css",plugins:["advlist lists link image charmap hr anchor pagebreak imagetools","searchreplace visualblocks visualchars code fullpage","insertdatetime nonbreaking save table directionality","powerpaste textpattern formatpainter codesample  nonbreaking"],toolbar:[" newnote | undo redo | insert | styleselect | fontselect | formatselect | fontsizeselect | forecolor backcolor formatpainter bold italic | alignleft aligncenter alignright alignjustify  bullist numlist outdent indent | link image |   codesample | table "],forced_root_block:"p",importcss_append:!0,content_style:"\n                    html, body                { height:100%; }\n                    html                      { overflow-y: auto; }\n                    html::-webkit-scrollbar   { display: none; }\n                    iframe                    { width: 100%; }\n                    p                         { margin: 0px; padding: 0px; }\n                ",insert_button_items:"image link | inserttable",paste_retain_style_properties:"all",paste_word_valid_elements:"*[*]",paste_data_images:!0,paste_convert_word_fake_lists:!1,paste_webkit_styles:"all",paste_merge_formats:!0,paste_auto_cleanup_on_paste:!1,style_formats:[{title:"首行缩进",block:"p",styles:{"text-indent":"2em"}},{title:"行高",items:[{title:"1",styles:{"line-height":"1"},inline:"span"},{title:"1.5",styles:{"line-height":"1.5"},inline:"span"},{title:"2",styles:{"line-height":"2"},inline:"span"},{title:"2.5",styles:{"line-height":"2.5"},inline:"span"},{title:"3",styles:{"line-height":"3"},inline:"span"}]},{title:"段落间距",items:[{title:"0",styles:{margin:"0"},block:"p"},{title:"10px",styles:{margin:"10px"},block:"p"}]}],fontsize_formats:"12px 14px 16px 18px 24px 36px 48px 56px 72px",font_formats:"\n                    微软雅黑=微软雅黑;\n                    宋体=宋体;\n                    黑体=黑体;\n                    仿宋=仿宋;\n                    楷体=楷体;\n                    隶书=隶书;\n                    幼圆=幼圆;\n                    Andale Mono=andale mono,times;\n                    Arial=arial, helvetica,\n                    sans-serif;\n                    Arial Black=arial black, avant garde;\n                    Book Antiqua=book antiqua,palatino;\n                    Comic Sans MS=comic sans ms,sans-serif;\n                    Courier New=courier new,courier;\n                    Georgia=georgia,palatino;\n                    Helvetica=helvetica;\n                    Impact=impact,chicago;\n                    Symbol=symbol;\n                    Tahoma=tahoma,arial,helvetica,sans-serif;\n                    Terminal=terminal,monaco;\n                    Times New Roman=times new roman,times;\n                    Trebuchet MS=trebuchet ms,geneva;\n                    Verdana=verdana,geneva;\n                    Webdings=webdings;\n                    Wingdings=wingdings,zapf dingbats",tabfocus_elements:":prev,:next",object_resizing:!0,textpattern_patterns:[{start:"*",end:"*",format:"italic"},{start:"**",end:"**",format:"bold"},{start:"#",format:"h1"},{start:"##",format:"h2"},{start:"###",format:"h3"},{start:"####",format:"h4"},{start:"#####",format:"h5"},{start:"######",format:"h6"},{start:"1.",cmd:"InsertOrderedList"},{start:"* ",cmd:"InsertUnorderedList"},{start:"- ",cmd:"InsertUnorderedList"}],nonbreaking_force_tab:!0,images_upload_handler:function(t,n,i){function o(){return(o=v()(y.a.mark((function e(){var i,o,a,s;return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:i=window.siteUrl+"/itsm/v2/import_picture/",o=new FormData,a=new XMLHttpRequest,o.append("file",t.blob()),a.onreadystatechange=function(){if(4===a.readyState)try{var e=JSON.parse(a.responseText);"success"===e.message?n("itsm/v2/download_rich_file/?file_path="+e.data.succeed_files.path+"&file_name="+e.data.succeed_files.name):console.log(e.message)}catch(e){console.log(e)}},s=function(){var e="NOTPROVIDED",t=document.cookie;if(t&&"string"==typeof t){var n=window.CSRF_COOKIE_NAME||"csrftoken",i=new RegExp("^".concat(n,"=[S]*"),"g"),o=t.split(";").find((function(e){return i.test(e.trim())}));return o?decodeURIComponent(o.split("=")[1]||e):e}return e},a.withCredentials=!0,a.open("post",i,!0),a.setRequestHeader("X-Requested-With","XMLHttpRequest"),a.setRequestHeader("X-csrfToken",s()),a.send(o);case 11:case"end":return e.stop()}}),e)})))).apply(this,arguments)}t.blob().size>e.maxSize&&i("文件体积过大"),e.accept.indexOf(t.blob().type)>=0?function(){o.apply(this,arguments)}():i("图片格式错误")}}}},watch:{tinyValue:function(e){this.tinymceHtml=e},tinymceHtml:function(e){this.$emit("tinymceinput",e)}},mounted:function(){this.tinymceHtml=this.tinyValue,de.a.init({})},beforeDestroy:function(){window.tinymce.get(this.tinymceId)&&window.tinymce.get(this.tinymceId).destroy()},methods:{}}),fe=ue,pe=Object(p.a)(fe,(function(){var e=this,t=e.$createElement;return(e._self._c||t)("Editor",{attrs:{id:"tinymceId",init:e.setting},model:{value:e.tinymceHtml,callback:function(t){e.tinymceHtml=t},expression:"tinymceHtml"}})}),[],!1,null,"517e62ba",null).exports,he=function(){var e=function(t,n){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},e(t,n)};return function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}(),me=function(){return me=Object.assign||function(e){for(var t,n=1,i=arguments.length;n<i;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e},me.apply(this,arguments)},ve=function(e,t,n,i){var o,a=arguments.length,s=a<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,n,i);else for(var r=e.length-1;r>=0;r--)(o=e[r])&&(s=(a<3?o(s):a>3?o(t,n,s):o(t,n))||s);return a>3&&s&&Object.defineProperty(t,n,s),s},ge=function(e,t,n,i){return new(n||(n=Promise))((function(o,a){function s(e){try{c(i.next(e))}catch(e){a(e)}}function r(e){try{c(i.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))},ye=function(e,t){var n,i,o,a,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:r(0),throw:r(1),return:r(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function r(a){return function(r){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,i&&(o=2&a[0]?i.return:a[0]?i.throw||((o=i.return)&&o.call(i),0):i.next)&&!(o=o.call(i,a[1])).done)return o;switch(i=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return s.label++,{value:a[1],done:!1};case 5:s.label++,i=a[1],a=[0];continue;case 7:a=s.ops.pop(),s.trys.pop();continue;default:if(!(o=s.trys,(o=o.length>0&&o[o.length-1])||6!==a[0]&&2!==a[0])){s=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){s.label=a[1];break}if(6===a[0]&&s.label<o[1]){s.label=o[1],o=a;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(a);break}o[2]&&s.ops.pop(),s.trys.pop();continue}a=t.call(e,s)}catch(e){a=[6,e],i=0}finally{n=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,r])}}},be=function(e,t,n){if(n||2===arguments.length)for(var i,o=0,a=t.length;o<a;o++)!i&&o in t||(i||(i=Array.prototype.slice.call(t,0,o)),i[o]=t[o]);return e.concat(i||Array.prototype.slice.call(t))},we=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.isShow=!1,t.fileVal="",t.formData={title:"",time:[],files:[],content:""},t.rules={title:[{required:!0,message:"必填项",trigger:"blur"}],time:[{validator:t.dateRangeValidator,message:"请选择日期",trigger:"blur"}],content:[{required:!0,message:"必填项",trigger:"blur"}]},t.loading=!1,t.currentType="add",t.announcementDetail="",t.formDataV2={},t}return he(t,e),Object.defineProperty(t.prototype,"isAdd",{get:function(){return"add"===this.currentType},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"acceptFile",{get:function(){var e=".zip,.jpg,.png,.pdf,.doc,.ppt,.xls,.docx,.pptx,.xlsx,.md,.txt,.json";return(e+","+e.toUpperCase()).split(",")},enumerable:!1,configurable:!0}),t.prototype.show=function(e,t){return ge(this,void 0,void 0,(function(){return ye(this,(function(n){return this.currentType=e,this.isShow=!0,this.formData={title:"",time:[],files:[],content:""},this.isAdd||(this.announcementDetail=t,this.formData={title:t.name,time:[t.startTime,t.endTime],files:t.files,content:t.content}),this.formDataV2=JSON.parse(JSON.stringify(this.formData)),[2]}))}))},t.prototype.dateRangeValidator=function(){var e=this.formData.time,t=e[0],n=e[1];return t&&n},t.prototype.getTinymceInput=function(e){this.formData.content=e},t.prototype.handleFile=function(e){for(var t=this,n=e.target.files[0],i=2e5,o=n.size/1024,a=n.name,s=0;s<this.formData.files.length;s++)if(a===this.formData.files[s].name)return void this.$error("此文件已经上传");if(this.acceptFile.some((function(e){return a.endsWith(e)})))if(o<=i){var r=new FormData;r.append("file",n),this.$api.announcement.importEnclosure(r).then((function(e){var n=e.data,i=e.result,o=e.message;if(!i)return t.$error(o),!1;var a=[];for(var s in n.succeed_files)a.push(me(me({},n.succeed_files[s]),{key:s}));t.formData.files=be(be([],t.formData.files,!0),a,!0),t.fileVal="",t.$success("上传成功")}))}else this.fileVal="",this.$error("该文件大小超过".concat(200,"MB！"));else this.$error("附件类型错误/不符")},t.prototype.deleteFile=function(e){this.formData.files.splice(e,1)},t.prototype.confirm=function(){var e=this;this.$refs.validateForm.validate().then((function(t){var n={id:"",name:e.formData.title,files:e.formData.files,state:"1",content:e.formData.content,type:"公告",startTime:new Date(e.formData.time[0]).getTime(),endTime:new Date(e.formData.time[1]).getTime()},i={};e.isAdd||(i={id:e.announcementDetail.id,body:n}),e.operateCredential(e.isAdd?n:i)}))},t.prototype.operateCredential=function(e){var t=this;this.loading=!0,this.$api.announcement[this.isAdd?"createNotify":"updateNotify"](e).then((function(e){if(!e.result)return t.$error(e.message),!1;t.$success("".concat(t.isAdd?"新增":"编辑","公告成功!")),t.isShow=!1,t.$emit("refreshList")})).finally((function(){t.loading=!1}))},t.prototype.cancel=function(){var e=this;this.$compareFormData(this.formData,this.formDataV2)?this.isShow=!1:this.$bkInfo({title:"是否放弃本次操作？",subTitle:"放弃将导致未保存信息丢失",theme:"primary",confirmFn:function(){e.isShow=!1}})},t=ve([Object(o.a)({name:"operateAnnouncement",components:{RichText:pe}})],t)}(o.e),ke=we,_e=Object(p.a)(ke,(function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("bk-sideslider",{attrs:{width:800,"is-show":e.isShow,"before-close":e.cancel,"quick-close":!0},on:{"update:isShow":function(t){e.isShow=t},"update:is-show":function(t){e.isShow=t}}},[n("div",{attrs:{slot:"header"},slot:"header"},[e._v(e._s((e.isAdd?"新建":"编辑")+"公告"))]),e._v(" "),n("div",{staticClass:"content-box",attrs:{slot:"content"},slot:"content"},[n("div",{staticClass:"form-box"},[n("bk-form",{ref:"validateForm",staticStyle:{flex:"1","padding-bottom":"20px"},attrs:{"label-width":70,model:e.formData,rules:e.rules}},[n("bk-form-item",{attrs:{label:"标题",required:"",property:"title","error-display-type":"normal"}},[n("bk-input",{attrs:{placeholder:"请输入标题"},model:{value:e.formData.title,callback:function(t){e.$set(e.formData,"title",t)},expression:"formData.title"}})],1),e._v(" "),n("bk-form-item",{attrs:{label:"有效期",required:"",property:"time","error-display-type":"normal"}},[n("bk-date-picker",{staticStyle:{width:"100%"},attrs:{placeholder:"选择日期时间范围",type:"datetimerange"},model:{value:e.formData.time,callback:function(t){e.$set(e.formData,"time",t)},expression:"formData.time"}})],1),e._v(" "),n("bk-form-item",{attrs:{label:"附件"}},[n("bk-button",{staticClass:"bk-upload",attrs:{theme:"default",title:"点击上传"}},[e._v("\n                        点击上传\n                        "),n("input",{attrs:{type:"file"},domProps:{value:e.fileVal},on:{change:function(t){return e.handleFile(t)}}})]),e._v(" "),n("span",[e._v("支持zip，jpg，png，ppt，doc，pdf，xlsx等格式，每个文件不超过200MB")]),e._v(" "),n("ul",{directives:[{name:"show",rawName:"v-show",value:e.formData.files.length,expression:"formData.files.length"}],staticClass:"bk-file-list"},e._l(e.formData.files,(function(t,i){return n("li",{key:i},[n("span",{staticClass:"bk-file-success"},[n("i",{staticClass:"bk-icon icon-check-1"})]),e._v(" "),n("span",[e._v(e._s(t.name))]),e._v(" "),n("span",{staticClass:"bk-file-delete",on:{click:function(t){return e.deleteFile(i)}}},[e._v("×")])])})),0)],1),e._v(" "),n("bk-form-item",{attrs:{label:"内容",required:"",property:"content","error-display-type":"normal"}},[n("rich-text",{ref:"richText",attrs:{"tiny-value":e.formData.content},on:{tinymceinput:e.getTinymceInput}})],1)],1)],1),e._v(" "),n("div",{staticClass:"foot-box"},[n("bk-button",{attrs:{theme:"default",type:"submit"},on:{click:e.cancel}},[e._v("\n                取消\n            ")]),e._v(" "),n("bk-button",{staticClass:"mr10",attrs:{loading:e.loading,disabled:e.loading,theme:"primary"},on:{click:e.confirm}},[e._v("\n                确认\n            ")])],1)])])}),[],!1,null,"4ffeb874",null).exports,Se=function(){var e=function(t,n){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},e(t,n)};return function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}(),xe=function(e,t,n,i){var o,a=arguments.length,s=a<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,n,i);else for(var r=e.length-1;r>=0;r--)(o=e[r])&&(s=(a<3?o(s):a>3?o(t,n,s):o(t,n))||s);return a>3&&s&&Object.defineProperty(t,n,s),s},De=function(e,t,n,i){return new(n||(n=Promise))((function(o,a){function s(e){try{c(i.next(e))}catch(e){a(e)}}function r(e){try{c(i.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))},Ce=function(e,t){var n,i,o,a,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:r(0),throw:r(1),return:r(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function r(a){return function(r){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,i&&(o=2&a[0]?i.return:a[0]?i.throw||((o=i.return)&&o.call(i),0):i.next)&&!(o=o.call(i,a[1])).done)return o;switch(i=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return s.label++,{value:a[1],done:!1};case 5:s.label++,i=a[1],a=[0];continue;case 7:a=s.ops.pop(),s.trys.pop();continue;default:if(!(o=s.trys,(o=o.length>0&&o[o.length-1])||6!==a[0]&&2!==a[0])){s=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){s.label=a[1];break}if(6===a[0]&&s.label<o[1]){s.label=o[1],o=a;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(a);break}o[2]&&s.ops.pop(),s.trys.pop();continue}a=t.call(e,s)}catch(e){a=[6,e],i=0}finally{n=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,r])}}},Le=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.searchWord="",t.tableLoading=!1,t.tableData=[],t.columns=[{label:"标题",key:"name",align:"left",minWidth:"150px"},{label:"创建人",key:"creator",align:"left",minWidth:"230px"},{label:"生效时间",key:"startTime",align:"left",minWidth:"150px"},{label:"失效时间",key:"endTime",align:"left",minWidth:"150px"},{label:"操作",key:"operation",align:"left",minWidth:"110px",fixed:"right",scopedSlots:"operation"}],t.pagination={current:1,count:1,limit:20},t.maxHeight="",t}return Se(t,e),t.prototype.mounted=function(){var e=this;this.maxHeight=window.innerHeight-237,window.onresize=function(){e.maxHeight=window.innerHeight-237},this.getList()},t.prototype.getList=function(){var e=this;this.tableLoading=!0,this.$api.announcement.getNotify({page:this.pagination.current,page_size:this.pagination.limit,portal:"1",state:"true",name__icontains:this.searchWord,type:"公告"}).then((function(t){var n=t.data;if(!t.result)return!1;e.tableData=n.items,e.pagination.count=n.count})).finally((function(){e.tableLoading=!1}))},t.prototype.delAnnouncement=function(e){var t=this;this.$bkInfo({title:"确认要删除该公告？",confirmLoading:!0,confirmFn:function(){return De(t,void 0,void 0,(function(){return Ce(this,(function(t){switch(t.label){case 0:return[4,this.confirmDelete(e)];case 1:return t.sent(),[2]}}))}))}})},t.prototype.confirmDelete=function(e){return De(this,void 0,void 0,(function(){var t;return Ce(this,(function(n){switch(n.label){case 0:return n.trys.push([0,2,,3]),[4,this.$api.announcement.deleteNotify({id:[e.id]})];case 1:return(t=n.sent()).result?(this.$success("删除成功!"),this.pagination.current>1&&1===this.tableData.length&&this.pagination.current--,this.getList()):this.$error(t.message),[2,!0];case 2:return n.sent(),[2,!1];case 3:return[2]}}))}))},t.prototype.operateAnnouncement=function(e,t){this.$refs.operateAnnouncement.show(e,t)},t.prototype.handlePageChange=function(e){this.pagination.current=e,this.getList()},t.prototype.limitChange=function(e){this.pagination.current=1,this.pagination.limit=e,this.getList()},t=xe([Object(o.a)({name:"index",components:{comTable:c.a,OperateAnnouncement:_e}})],t)}(o.e),Ne=Le,Oe=Object(p.a)(Ne,(function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",{directives:[{name:"bkloading",rawName:"v-bkloading",value:{isLoading:e.tableLoading,zIndex:10},expression:"{ isLoading: tableLoading, zIndex: 10 }"}],staticClass:"announcement"},[n("div",{staticClass:"action-bar"},[n("bk-button",{staticClass:"mr50",attrs:{theme:"primary"},on:{click:function(t){return e.operateAnnouncement("add")}}},[e._v("\n            新增\n        ")]),e._v(" "),n("bk-input",{staticStyle:{flex:"1"},attrs:{clearable:"",placeholder:"请输入搜索关键字","right-icon":"bk-icon icon-search"},on:{enter:e.getList,clear:e.getList,"right-icon-click":e.getList},model:{value:e.searchWord,callback:function(t){e.searchWord=t},expression:"searchWord"}})],1),e._v(" "),n("com-table",{ref:"sourceTable",attrs:{id:"center_table",data:e.tableData,"max-height":e.maxHeight,pagination:e.pagination,columns:e.columns},on:{"page-change":e.handlePageChange,"page-limit-change":e.limitChange},scopedSlots:e._u([{key:"operation",fn:function(t){var i=t.row;return[n("bk-button",{staticClass:"mr10",attrs:{theme:"primary",text:""},on:{click:function(t){return e.operateAnnouncement("edit",i)}}},[e._v("\n                修改\n            ")]),e._v(" "),n("bk-button",{staticClass:"mr10",attrs:{theme:"primary",text:""},on:{click:function(t){return e.delAnnouncement(i)}}},[e._v("\n                删除\n            ")])]}}])}),e._v(" "),n("operate-announcement",{ref:"operateAnnouncement",on:{refreshList:e.getList}})],1)}),[],!1,null,"7ec88b1c",null).exports,Re=function(){var e=function(t,n){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},e(t,n)};return function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}(),$e=function(e,t,n,i){var o,a=arguments.length,s=a<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,n,i);else for(var r=e.length-1;r>=0;r--)(o=e[r])&&(s=(a<3?o(s):a>3?o(t,n,s):o(t,n))||s);return a>3&&s&&Object.defineProperty(t,n,s),s},Ie=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.menuList=[{label:"流程",name:"process",subTabList:[{label:"流程设计",name:"processDesign",url:"".concat(window.HOST,"bk_itsm/#/processDesign")},{label:"流程版本",name:"processVersion",url:"".concat(window.HOST,"bk_itsm/#/releaseFlow")}]},{label:"服务",name:"service"},{label:"服务目录",name:"serviceCatalog",url:"".concat(window.HOST,"bk_itsm/#/directory")},{label:"SLA",name:"SLA",subTabList:[{label:"服务协议",name:"serviceAgreement",url:"".concat(window.HOST,"bk_itsm/#/agreement")},{label:"服务模式",name:"serviceMode",url:"".concat(window.HOST,"bk_itsm/#/slaManager")}]},{label:"值班管理",name:"watchManage",subTabList:[{label:"排班日历",name:"watchCalendar",url:"".concat(window.HOST,"bk_itsm/#/dutyManage/dutyCalendar")},{label:"值班记录",name:"watchRecord",url:"".concat(window.HOST,"bk_itsm/#/dutyManage/dutyRecord")},{label:"值班组",name:"watchGroup",url:"".concat(window.HOST,"bk_itsm/#/dutyManage/dutyGroup")},{label:"值班模式",name:"watchMode",url:"".concat(window.HOST,"bk_itsm/#/dutyManage/dutyMode")},{label:"供应商管理",name:"providerManage",url:"".concat(window.HOST,"bk_itsm/#/dutyManage/providerManage")},{label:"值班复核",name:"watchConfirm",url:"".concat(window.HOST,"bk_itsm/#/dutyManage/confirm")}]},{label:"公告",name:"announcement"},{label:"运营分析",name:"operationalAnalysis",url:"".concat(window.HOST,"bk_itsm/#/operationalData")},{label:"例行工作",name:"routineWork",url:"".concat(window.HOST,"bk_itsm/#/routineWork")}],t.active="process",t.url="",t.subUrl="",t.subActive="",t.subMenuList=[],t}return Re(t,e),t.prototype.mounted=function(){this.menuList[0].subTabList&&(this.subMenuList=this.menuList[0].subTabList,this.subUrl=this.subMenuList[0].url,this.subActive=this.subMenuList[0].name)},t.prototype.toTabMenu=function(e){this.active=e.name,this.url=e.url,e.subTabList&&(this.subMenuList=e.subTabList,this.subUrl=e.subTabList[0].url,this.subActive=e.subTabList[0].name)},t.prototype.toSubMenu=function(e){this.subActive=e.name,this.subUrl=e.url},t=$e([Object(o.a)({components:{menuTab:a.a,WikiIframe:r.a,HeaderSub:s.a,serviceList:re,announcement:Oe}})],t)}(o.e),Ae=Ie,Ee=Object(p.a)(Ae,(function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",{staticClass:"service-desk"},[n("header-sub",{staticClass:"service-desk-header"},[n("template",{slot:"title"},[n("menu-tab",{attrs:{panels:e.menuList,type:"line","active-panel":e.active},on:{click:e.toTabMenu}})],1)],2),e._v(" "),n("div",{staticClass:"show-box"},["service"===e.active?n("service-list"):"announcement"===e.active?n("announcement"):n("div",{staticStyle:{width:"100%",height:"100%"}},[e.url?n("wiki-iframe",{attrs:{url:e.url,name:"service",link:"service"}}):n("div",{staticClass:"sla-page"},[n("menu-tab",{attrs:{panels:e.subMenuList,type:"text","active-panel":e.subActive},on:{click:e.toSubMenu}}),e._v(" "),n("div",{staticClass:"sla-iframe"},[e.subUrl?n("wiki-iframe",{attrs:{url:e.subUrl,name:"service",link:"watchManage"===e.active?"watch":"service"}}):e._e()],1)],1)],1)],1)],1)}),[],!1,null,"07d0e67a",null);t.default=Ee.exports}}]);