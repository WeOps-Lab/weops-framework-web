(window.webpackJsonp=window.webpackJsonp||[]).push([[18],{Pr0v:function(e,t,n){"use strict";n.r(t);var i=n("lSNA"),s=n.n(i),a=n("yXPU"),o=n.n(a),r=(n("f3/d"),n("RW0V"),n("o0o1")),c=n.n(r),l=(n("xfY5"),n("bWfx"),n("91GP"),{name:"table-collapse",props:{host:{type:Object,default:function(){return{bk_cloud:"",bk_host_id:"",bk_host_innerip:""}}},template:{type:Object,default:function(){return{bk_host_id:null,final_modules:[],host_apply_plan:{},to_add_to_modules:[],to_remove_from_modules:[]}}},cloneConfig:{type:Object,default:function(){return{isCloned:!1,processes:[]}}}},data:function(){return{isShow:!0,isEdit:!1,editName:"",processData:[],templateData:{},service_instance_name:"",hasTemplate:!1,protocolMap:{0:"UDP",1:"TCP"}}},mounted:function(){this.cloneConfig.isCloned?this.processData=this.$copy(this.cloneConfig.processes):this.setTemplate(),this.service_instance_name=this.host.bk_host_innerip},methods:{setTemplate:function(){var e=this,t={};if(this.template.to_add_to_modules.length&&this.template.to_add_to_modules[0].service_template&&(this.hasTemplate=!0,t=this.template.to_add_to_modules[0].service_template.process_templates.map((function(e){return e.property}))),this.templateData=t,t.length){var n=[];t.forEach((function(t){var i={};Object.keys(t).forEach((function(e){if("bind_info"===e){var n=[];t.bind_info.value.forEach((function(e){var t={};Object.keys(e).forEach((function(n){t[n]=e[n].value})),n.push(t)})),i.bind_info=n}else i[e]=t[e].value})),n.push(i),e.processData.length?n.forEach((function(t,n){Object.assign(e.processData[n],t)})):e.processData=n}))}},edit:function(e){this.$emit("edit-process",e)},del:function(e){this.processData.splice(e,1)},add:function(){var e=this;this.$emit("edit-process",{},(function(t){e.processData.push(t)}))},handleClickTitle:function(){this.isShow=!this.isShow},editInstName:function(){this.editName=this.service_instance_name,this.isEdit=!0},confirmEditName:function(){this.service_instance_name=this.editName,this.isEdit=!1},deleteInst:function(){this.$emit("del-inst",this.host.bk_host_id)},setBindInfo:function(e){var t=this;if(!e||!e.length)return"--";var n=[];return e.forEach((function(e){n.push("".concat(null===e.protocol?"--":t.protocolMap[e.protocol]," ").concat(e.ip?e.ip:"--",":").concat(e.port?e.port:"--"))})),n.join(", ")}}}),u=n("KHd+"),d=Object(u.a)(l,(function(){var e=this,t=e.$createElement,n=e._self._c||t;return e.template.to_add_to_modules?n("div",{staticClass:"table-collapse mt10 mb10"},[n("div",{staticClass:"collapse-title",on:{click:e.handleClickTitle}},[n("div",{staticClass:"title-left"},[n("bk-icon",{staticClass:"left-icon",attrs:{type:e.isShow?"down-shape":"right-shape"}}),e._v(" "),e.isEdit?n("span",{staticClass:"input-row",on:{click:function(e){e.stopPropagation()}}},[n("bk-input",{staticStyle:{width:"200px"},attrs:{size:"small"},model:{value:e.editName,callback:function(t){e.editName=t},expression:"editName"}}),e._v(" "),n("bk-button",{attrs:{theme:"primary",text:"",disabled:e.service_instance_name===e.editName},on:{click:function(t){return t.stopPropagation(),e.confirmEditName.apply(null,arguments)}}},[e._v("确定\n                ")]),e._v(" "),n("bk-divider",{attrs:{direction:"vertical"}}),e._v(" "),n("bk-button",{attrs:{theme:"primary",text:""},on:{click:function(t){t.stopPropagation(),e.isEdit=!1}}},[e._v("取消")])],1):n("span",{staticStyle:{"font-size":"14px"}},[e._v(e._s(e.service_instance_name))]),e._v(" "),e.isEdit?e._e():n("bk-icon",{staticClass:"edit-icon",staticStyle:{"font-size":"24px",color:"#3a84ff"},attrs:{type:"edit2"},on:{click:function(t){return t.stopPropagation(),e.editInstName.apply(null,arguments)}}})],1),e._v(" "),n("div",{staticClass:"title-right"},[n("bk-icon",{staticStyle:{"font-size":"24px"},attrs:{type:"close"},on:{click:e.deleteInst}})],1)]),e._v(" "),n("div",{directives:[{name:"show",rawName:"v-show",value:e.isShow,expression:"isShow"}],staticClass:"collapse-content"},[n("bk-table",{attrs:{data:e.processData}},[n("template",{slot:"empty"},[n("bk-link",{attrs:{theme:"primary",icon:"bk-icon left-icon icon-plus"},on:{click:e.add}},[e._v("添加进程")])],1),e._v(" "),n("template",{slot:"append"},[!e.processData.length||e.hasTemplate||e.cloneConfig.isCloned?e._e():n("div",{staticClass:"append-row"},[n("bk-link",{staticStyle:{"min-height":"42px"},attrs:{theme:"primary",icon:"bk-icon left-icon icon-plus"},on:{click:e.add}},[e._v("添加进程\n                    ")])],1)]),e._v(" "),n("bk-table-column",{attrs:{label:"进程名称"},scopedSlots:e._u([{key:"default",fn:function(t){return[e._v("\n                    "+e._s(t.row.bk_func_name||"--")+"\n                ")]}}],null,!1,2543893869)}),e._v(" "),n("bk-table-column",{attrs:{label:"进程别名"},scopedSlots:e._u([{key:"default",fn:function(t){return[e._v("\n                    "+e._s(t.row.bk_process_name||"--")+"\n                ")]}}],null,!1,2887159544)}),e._v(" "),n("bk-table-column",{attrs:{label:"进程启动参数"},scopedSlots:e._u([{key:"default",fn:function(t){return[e._v("\n                    "+e._s(t.row.bk_start_param_regex||"--")+"\n                ")]}}],null,!1,2169202793)}),e._v(" "),n("bk-table-column",{attrs:{label:"绑定信息"},scopedSlots:e._u([{key:"default",fn:function(t){return[e._v("\n                    "+e._s(e.setBindInfo(t.row.bind_info))+"\n                ")]}}],null,!1,1137129633)}),e._v(" "),n("bk-table-column",{attrs:{label:"操作"},scopedSlots:e._u([{key:"default",fn:function(t){return[n("bk-button",{staticClass:"mr10",attrs:{theme:"primary",text:""},on:{click:function(n){return e.edit(t.row)}}},[e._v("编辑")]),e._v(" "),e.cloneConfig.isCloned||e.hasTemplate?e._e():n("bk-button",{staticClass:"mr10",attrs:{theme:"primary",text:""},on:{click:function(n){return e.del(t.row.index)}}},[e._v("删除")])]}}],null,!1,2713422809)})],2)],1)]):e._e()}),[],!1,null,"0b256dd2",null),p=d.exports,f={name:"process-edit",props:{instanceDetailsConfig:{type:Object,default:function(){return{}}}},methods:{refresh:function(){this.$emit("refresh")}}},h=Object(u.a)(f,(function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",[e.instanceDetailsConfig.isShow?n("cmdb-instance-details-sideslider",{attrs:{config:e.instanceDetailsConfig},on:{refresh:e.refresh}}):e._e()],1)}),[],!1,null,"6032953e",null).exports,b=n("7lsU"),m={name:"instance-process",props:{bizId:{type:Number},moduleId:{type:Number},hostList:{type:Array,default:function(){return[]}},cloneConfig:{type:Object,default:function(){return{isCloned:!1,processes:[]}}}},components:{tableCollapse:p,ProcessEdit:h},data:function(){return{loading:!1,refresh:!0,previewData:[],processConfig:{}}},created:function(){this.processInstancePreview()},watch:{hostList:function(){this.processInstancePreview()}},methods:{getAllInstData:function(){var e=[];return this.$refs.inst.forEach((function(t){var n=t.processData.map((function(e){var t={};return t.process_info=e,t}));e.push({bk_host_id:t.host.bk_host_id,processes:n,service_instance_name:t.service_instance_name})})),e},processInstancePreview:function(){var e=this;return o()(c.a.mark((function t(){return c.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!e.cloneConfig.isCloned){t.next=2;break}return t.abrupt("return");case 2:return e.loading=!0,t.next=5,e.$api.cc.business_service.create_service_instance_preview({bk_biz_id:e.bizId,bk_host_ids:e.hostList.map((function(e){return e.bk_host_id})),bk_module_id:e.moduleId}).then((function(t){e.loading=!1,t.result&&(e.refresh=!1,e.previewData=t.data,e.$nextTick((function(){e.refresh=!0})))}));case 5:case"end":return t.stop()}}),t)})))()},editName:function(e){this.$emit("edit-name",e)},delInst:function(e){this.$emit("del-inst",e)},editProcess:function(e,t){this.processConfig={isShow:!0,currInfo:e,currNode:{bk_obj_id:"process",bk_biz_id:this.bizId,bk_process_id:9999999},parts:[b.a.attribute],partsConfig:s()({},b.a.attribute.name,{opStatus:"scripting",successFn:function(n){t?t(n):e=n}})}}}},_=Object(u.a)(m,(function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",{directives:[{name:"bkloading",rawName:"v-bkloading",value:{isLoading:e.loading},expression:"{isLoading: loading}"}],staticClass:"instance-process"},[e.refresh?n("div",e._l(e.hostList,(function(t){return n("table-collapse",{key:t.bk_host_id,ref:"inst",refInFor:!0,attrs:{host:t,template:e.previewData.find((function(e){return e.bk_host_id===t.bk_host_id})),cloneConfig:e.cloneConfig},on:{"edit-process":e.editProcess,"edit-name":e.editName,"del-inst":e.delInst}})})),1):e._e(),e._v(" "),n("process-edit",{attrs:{instanceDetailsConfig:e.processConfig}})],1)}),[],!1,null,"41df1d32",null).exports;n("ioFf"),n("mYba"),n("jm62"),n("0l/t"),n("dRSK"),n("KKXr");function g(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}var v={name:"instance-process",props:{instance:{type:Object,default:function(){return{}}},bizId:{type:Number,default:function(){return 0}},hasTemp:{type:Boolean,default:function(){return!1}}},created:function(){this.searchProcessInstance()},data:function(){return{protocolMap:{0:"UDP",1:"TCP"},processData:[],columns:[],loading:!1,showOp:!1}},methods:{searchProcessInstance:function(){var e=this,t={service_instance_id:this.instance.id,bk_biz_id:this.bizId};this.loading=!0,this.$api.cc.business_service.search_proc_instance(t).then((function(t){e.loading=!1,t.result?e.makeProcessData(t.data):e.$message.error(t.message)}))},makeProcessData:function(e){this.processData=e.map((function(e){var t=function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?g(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):g(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({},e.property);return t.bk_process_id=e.relation.bk_process_id,t}))},setBindInfo:function(e){var t=this;if(!e||!e.length)return"--";var n=[];return e.forEach((function(e){n.push("".concat(null===e.protocol?"--":t.protocolMap[e.protocol]," ").concat(e.ip?e.ip:"--",":").concat(e.port?e.port:"--"))})),n.join(", ")},delProcess:function(e){var t=this;console.log(e),this.$bkInfo({title:"确认删除该进程？",confirmFn:function(){var n={bk_biz_id:e.bk_biz_id,process_instance_ids:[e.bk_process_id]};t.$api.cc.business_service.delete_process_instance(n).then((function(e){e.result?t.searchProcessInstance():t.$message.error(e.message)}))}})},processReading:function(e){this.$emit("process",{currNode:{bk_obj_id:"process",bk_inst_name:e.bk_inst_name,bk_inst_id:e.bk_process_id},currInfo:e,opStatus:"reading",successFn:null})},processEditing:function(e){this.$emit("process",{currNode:{bk_obj_id:"process",bk_biz_id:this.bizId,bk_process_id:e.bk_process_id},currInfo:e,opStatus:"editing",successFn:this.searchProcessInstance})}}},k=v,y=Object(u.a)(k,(function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",{directives:[{name:"bkloading",rawName:"v-bkloading",value:{isLoading:e.loading},expression:"{isLoading: loading}"}],staticClass:"progress-table"},[n("bk-table",{attrs:{data:e.processData,"outer-border":!1,"header-cell-style":{background:"#fff",borderRight:"none"}},on:{"row-mouse-enter":function(t){e.showOp=!0},"row-mouse-leave":function(t){e.showOp=!1}}},[n("bk-table-column",{attrs:{label:"进程名称"},scopedSlots:e._u([{key:"default",fn:function(t){return[n("span",{staticClass:"primary-value",on:{click:function(n){return e.processReading(t.row)}}},[e._v(e._s(t.row.bk_process_name))])]}}])}),e._v(" "),n("bk-table-column",{attrs:{prop:"bk_func_name",label:"进程别名"}}),e._v(" "),n("bk-table-column",{attrs:{label:"进程启动参数"},scopedSlots:e._u([{key:"default",fn:function(t){return[e._v("\n                "+e._s(t.row.bk_start_param_regex||"--")+"\n            ")]}}])}),e._v(" "),n("bk-table-column",{attrs:{label:"绑定信息","show-overflow-tooltip":!0},scopedSlots:e._u([{key:"default",fn:function(t){return[e._v("\n                "+e._s(e.setBindInfo(t.row.bind_info))+"\n            ")]}}])}),e._v(" "),n("bk-table-column",{scopedSlots:e._u([{key:"default",fn:function(t){return[n("div",{directives:[{name:"show",rawName:"v-show",value:e.showOp,expression:"showOp"}]},[n("bk-button",{staticClass:"mr10",attrs:{theme:"primary",text:""},on:{click:function(n){return e.processEditing(t.row)}}},[e._v("编辑")]),e._v(" "),e.hasTemp?e._e():n("bk-button",{staticClass:"mr10",attrs:{theme:"primary",text:""},on:{click:function(n){return e.delProcess(t.row)}}},[e._v("删除")])],1)]}}])})],1)],1)}),[],!1,null,"642c73aa",null).exports,I={name:"service-instance-label-tag",props:{labels:{type:Object,default:function(){return{}}},isHover:{type:Boolean,default:function(){return!1}}},data:function(){return{}},methods:{editTag:function(){this.$emit("tag-edit")}}},w=Object(u.a)(I,(function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",[Object.keys(e.labels).length?n("div",[e._l(Object.keys(e.labels).slice(0,1),(function(t){return n("div",{key:t,staticClass:"tag-box tag-list",attrs:{title:t+" : "+e.labels[t],tag:t}},[n("span",{staticClass:"tag-item",attrs:{title:t+":"+e.labels[t]}},[e._v(e._s(t+":"+e.labels[t]))])])})),e._v(" "),Object.keys(e.labels).length>1?n("div",{staticClass:"tag-box tag-more"},[n("Tooltip",{attrs:{placement:"bottom",theme:"light",offset:5,"max-width":"200"}},[n("span",{staticClass:"tag-more"},[e._v("...")]),e._v(" "),n("div",{staticClass:"tooltip-bottom",attrs:{slot:"content"},slot:"content"},e._l(Object.keys(e.labels).slice(1),(function(t){return n("div",{key:t,staticClass:"tag-box tag-collapse",attrs:{title:t+":"+e.labels[t],tag:t}},[n("span",{staticClass:"tag-item"},[e._v(e._s(t+":"+e.labels[t]))])])})),0)])],1):e._e()],2):n("div",[n("span",{staticClass:"no-label"},[e._v("--")])]),e._v(" "),n("div",[e.isHover?n("i",{staticClass:"icon-cc-edit pri-icon ml5",on:{click:e.editTag}}):e._e()])])}),[],!1,null,"ad48b722",null);function C(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}var x={name:"service-instance-view",components:{InstanceProcess:y,InstanceTag:w.exports},props:{config:{type:Object,default:function(){return{}}},filter:{type:Object,default:function(){return{}}}},computed:{bizId:function(){return this.config.bizId},moduleId:function(){return this.config.currNode.bk_inst_id},pageTransfer:function(){return{start:(this.pagination.current-1)*this.pagination.limit,limit:this.pagination.limit}}},data:function(){return{loading:!1,hasTemp:!1,condition:{bk_biz_id:null,bk_module_id:null,page:{start:0,limit:20}},serviceInstanceData:[],pagination:{current:1,count:500,limit:20},RowHoverId:null,editId:null,editName:""}},created:function(){this.$store.dispatch("obj/searchObjectAttribute",{bk_obj_id:"process"}),this.$store.dispatch("obj/searchObjectGroup",{bk_obj_id:"process"})},mounted:function(){this.searchServiceInstance()},methods:{searchServiceInstance:function(){var e=this;this.loading=!0,this.condition=function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?C(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):C(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({bk_biz_id:this.bizId,bk_module_Id:this.moduleId,page:this.pageTransfer},this.filter),this.$api.cc.business_service.search_service_instance(this.condition).then((function(t){e.loading=!1,t.result?(e.pagination.count=t.data.count,e.serviceInstanceData=t.data.info):(e.pagination.count=0,e.serviceInstanceData=[],e.$message.error(t.message)),e.checkHasTemplate()}))},checkHasTemplate:function(){this.serviceInstanceData.find((function(e){return 0!==e.service_template_id}))&&(this.hasTemp=!0,this.$emit("hasTemplate",!0))},handlePageChange:function(e){this.pagination.current=e,this.searchServiceInstance()},handlePageLimitChange:function(e){this.pagination.limit=e,this.searchServiceInstance()},handleRowEnter:function(e,t,n){this.RowHoverId=n.id},handleRowLeave:function(){this.RowHoverId=null},editInstName:function(e){this.editId=e.id,this.editName=e.name},confirmEditName:function(e){var t=this,n={bk_biz_id:this.bizId,data:[{service_instance_id:e.id,update:{name:this.editName}}]};this.loading=!0,this.$api.cc.business_service.update_service_instance(n).then((function(n){t.loading=!1,n.result?(t.serviceInstanceData.find((function(t){return t.id===e.id})).name=t.editName,t.editId=null):t.$message.error(n.message)}))},cancelEdit:function(){this.editId=null},editTag:function(e){this.$emit("label-edit",{isBatch:!1,isShow:!0,bizId:this.bizId,instanceIds:[e.id],labels:e.labels})},removeInst:function(e){this.$router.push({name:"cmdb/service/delete-service-instance",params:{bizId:this.bizId,inst:[e]}})},cloneInst:function(e){this.$router.push({name:"cmdb/service/clone-service-instance",params:{bizId:this.bizId,inst:e,moduleId:this.moduleId,hostId:e.bk_host_id}})},editProcess:function(e){this.$emit("process",e)},addProcess:function(e){this.$emit("process",{currNode:{bk_obj_id:"process",bk_biz_id:this.bizId,service_instance_id:e.id},currInfo:e,opStatus:"creating",successFn:this.searchServiceInstance})},handleSelectChange:function(e){this.$emit("selectChange",e.map((function(e){return e.id})))},expandAllRow:function(e){var t=this;return o()(c.a.mark((function n(){return c.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,t.serviceInstanceData.forEach((function(n){t.$refs.instTable.toggleRowExpansion(n,e)}));case 2:case"end":return n.stop()}}),n)})))()},copyIps:function(e){var t=document.createElement("input");document.body.appendChild(t),t.value=this.makeCopyIps(e),t.focus(),t.select(),document.execCommand("copy")&&document.execCommand("copy"),t.blur(),this.$message.success("复制成功"),document.body.removeChild(t)},makeCopyIps:function(e){return this.serviceInstanceData.map((function(e){return e.name.split("_")[0]})).join(",")}}},$=x,D=Object(u.a)($,(function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",{directives:[{name:"bkloading",rawName:"v-bkloading",value:{isLoading:e.loading},expression:"{isLoading: loading}"}]},[n("bk-table",{ref:"instTable",attrs:{data:e.serviceInstanceData,pagination:e.pagination},on:{"row-mouse-enter":e.handleRowEnter,"row-mouse-leave":e.handleRowLeave,"page-limit-change":e.handlePageLimitChange,"selection-change":e.handleSelectChange,"page-change":e.handlePageChange}},[n("bk-table-column",{attrs:{type:"selection",width:"50"}}),e._v(" "),n("bk-table-column",{attrs:{type:"expand",width:"30"},scopedSlots:e._u([{key:"default",fn:function(t){return[t.row.process_count?n("Instance-process",{attrs:{instance:t.row,hasTemp:e.hasTemp,bizId:e.bizId},on:{process:e.editProcess}}):e._e()]}}])}),e._v(" "),n("bk-table-column",{attrs:{label:"实例名称","min-width":"150"},scopedSlots:e._u([{key:"default",fn:function(t){return[e.editId===t.row.id?n("div",{staticClass:"input-row"},[n("bk-input",{staticStyle:{width:"200px"},attrs:{size:"small"},model:{value:e.editName,callback:function(t){e.editName=t},expression:"editName"}}),e._v(" "),n("bk-button",{attrs:{theme:"primary",text:"",disabled:t.row.name===e.editName},on:{click:function(n){return e.confirmEditName(t.row)}}},[e._v("确定\n                    ")]),e._v(" "),n("bk-divider",{attrs:{direction:"vertical"}}),e._v(" "),n("bk-button",{attrs:{theme:"primary",text:""},on:{click:function(n){return e.cancelEdit(t.row)}}},[e._v("取消")])],1):n("div",{staticClass:"inst-name"},[n("div",{staticClass:"name-text",class:{"disable-text":!t.row.process_count}},[e._v("\n                        "+e._s(t.row.name)+"\n                    ")]),e._v(" "),t.row.process_count?n("bk-icon",{staticClass:"pri-icon",class:{"show-icon":e.RowHoverId===t.row.id},staticStyle:{"font-size":"20px"},attrs:{type:"edit2"},on:{click:function(n){return e.editInstName(t.row)}}}):e._e()],1)]}}])}),e._v(" "),n("bk-table-column",{attrs:{label:"进程数量",prop:"process_count",width:"300"},scopedSlots:e._u([{key:"default",fn:function(t){return[t.row.process_count||t.row.service_template_id?n("span",[e._v(e._s(t.row.process_count))]):n("span",[n("bk-icon",{staticStyle:{color:"#ff9c01"},attrs:{type:"exclamation-circle"}}),e._v(" "),n("span",{staticStyle:{color:"#c4c6cc",padding:"0 4px"}},[e._v("未添加进程，")]),e._v(" "),n("span",{staticStyle:{color:"#3a84ff",cursor:"pointer"},on:{click:function(n){return e.addProcess(t.row)}}},[e._v("立即添加")])],1)]}}])}),e._v(" "),n("bk-table-column",{attrs:{label:"标签",width:"200"},scopedSlots:e._u([{key:"default",fn:function(t){return[n("div",{staticClass:"inst-name"},[n("div",{staticClass:"name-text"},[n("InstanceTag",{staticStyle:{overflow:"visible!important"},attrs:{labels:t.row.labels?t.row.labels:{},isHover:e.RowHoverId===t.row.id},on:{"tag-edit":function(n){return e.editTag(t.row)}}})],1)])]}}])}),e._v(" "),n("bk-table-column",{attrs:{label:"操作",width:"150"},scopedSlots:e._u([{key:"default",fn:function(t){return[t.row.service_template_id?e._e():n("bk-button",{staticClass:"mr10",attrs:{theme:"primary",text:""},on:{click:function(n){return e.addProcess(t.row)}}},[e._v("添加进程\n                ")]),e._v(" "),t.row.service_template_id?e._e():n("bk-button",{staticClass:"mr10",attrs:{theme:"primary",text:""},on:{click:function(n){return e.cloneInst(t.row)}}},[e._v("克隆\n                ")]),e._v(" "),n("bk-button",{staticClass:"mr10",attrs:{theme:"primary",text:""},on:{click:function(n){return e.removeInst(t.row)}}},[e._v("删除")])]}}])})],1)],1)}),[],!1,null,"97b49fe4",null).exports,O={name:"process-inst",props:{ids:{type:Array,default:function(){return[]}},bizId:{type:Number,default:function(){return 0}},hasTemp:{type:Boolean,default:function(){return!1}}},created:function(){this.search_proc_instance_by_ids()},data:function(){return{processData:{},loading:!1,protocolMap:{0:"UDP",1:"TCP"}}},methods:{search_proc_instance_by_ids:function(){var e=this,t={bk_biz_id:this.bizId,page:{limit:999999999},process_ids:this.ids};this.loading=!0,this.$api.cc.business_service.search_proc_instance_by_ids(t).then((function(t){e.loading=!1,t.result&&(e.processData=t.data)}))},setBindInfo:function(e){var t=this;if(!e||!e.length)return"--";var n=[];return e.forEach((function(e){n.push("".concat(null===e.protocol?"--":t.protocolMap[e.protocol]," ").concat(e.ip?e.ip:"--",":").concat(e.port?e.port:"--"))})),n.join(", ")},processReading:function(e){this.$emit("process",{currNode:{bk_obj_id:"process",bk_inst_name:e.service_instance_name,bk_inst_id:e.process_id},currInfo:e.property,opStatus:"reading",successFn:null})},processEditing:function(e){this.$emit("process",{currNode:{bk_obj_id:"process",bk_biz_id:this.bizId,bk_process_id:e.process_id},currInfo:e.property,opStatus:"editing",successFn:this.search_proc_instance_by_ids})},delProcess:function(e){var t=this;this.$bkInfo({title:"确认删除该进程？",confirmFn:function(){var n={bk_biz_id:t.bizId,process_instance_ids:[e.process_id]};t.$api.cc.business_service.delete_process_instance(n).then((function(n){n.result?t.$emit("reCount",e):t.$message.error(n.message)}))}})},handleSelectChange:function(e){this.$emit("selectChange",e.map((function(e){return e.process_id})))}}},S={name:"process-table",components:{processInst:Object(u.a)(O,(function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",{directives:[{name:"bkloading",rawName:"v-bkloading",value:{isLoading:e.loading},expression:"{isLoading: loading}"}],staticClass:"progress-table"},[n("bk-table",{attrs:{data:e.processData.info,"outer-border":!1,"header-cell-style":{background:"#fff",borderRight:"none"}},on:{"selection-change":e.handleSelectChange}},[n("bk-table-column",{attrs:{type:"selection",width:"50"}}),e._v(" "),n("bk-table-column",{attrs:{label:"所属实例"},scopedSlots:e._u([{key:"default",fn:function(t){return[n("span",{staticClass:"primary-value",on:{click:function(n){return e.processReading(t.row)}}},[e._v(e._s(t.row.service_instance_name))])]}}])}),e._v(" "),n("bk-table-column",{attrs:{label:"进程名称"},scopedSlots:e._u([{key:"default",fn:function(t){return[e._v("\n                "+e._s(t.row.property.bk_func_name||"--")+"\n            ")]}}])}),e._v(" "),n("bk-table-column",{attrs:{label:"进程启动参数"},scopedSlots:e._u([{key:"default",fn:function(t){return[e._v("\n                "+e._s(t.row.property.bk_start_param_regex||"--")+"\n            ")]}}])}),e._v(" "),n("bk-table-column",{attrs:{label:"绑定信息"},scopedSlots:e._u([{key:"default",fn:function(t){return[e._v("\n                "+e._s(e.setBindInfo(t.row.property.bind_info))+"\n            ")]}}])}),e._v(" "),n("bk-table-column",{attrs:{label:"操作"},scopedSlots:e._u([{key:"default",fn:function(t){return[n("bk-button",{staticClass:"mr10",attrs:{theme:"primary",text:""},on:{click:function(n){return e.processEditing(t.row)}}},[e._v("编辑")]),e._v(" "),e.hasTemp?e._e():n("bk-button",{staticClass:"mr10",attrs:{theme:"primary",text:""},on:{click:function(n){return e.delProcess(t.row)}}},[e._v("删除")])]}}])})],1)],1)}),[],!1,null,"4e8ac8dc",null).exports},props:{config:{type:Object,default:function(){return{}}},hasTemp:{type:Boolean,default:function(){return!1}},filter:{type:String,default:function(){return""}}},computed:{bizId:function(){return this.config.bizId},moduleId:function(){return this.config.currNode.bk_inst_id},pageTransfer:function(){return{start:(this.pagination.current-1)*this.pagination.limit,limit:this.pagination.limit}}},data:function(){return{loading:!1,condition:{bk_biz_id:null,bk_module_id:null,page:{start:0,limit:20}},procInstanceData:[],pagination:{current:1,count:500,limit:20}}},created:function(){this.$store.dispatch("obj/searchObjectAttribute",{bk_obj_id:"process"}),this.$store.dispatch("obj/searchObjectGroup",{bk_obj_id:"process"})},mounted:function(){this.searchProcInstance()},methods:{searchProcInstance:function(){var e=this;this.loading=!0,this.condition={bk_biz_id:this.bizId,bk_module_Id:this.moduleId,page:this.pageTransfer,process_name:this.filter},this.$api.cc.business_service.search_proc_instance_ids(this.condition).then((function(t){e.loading=!1,t.result?(e.procInstanceData=t.data.info,e.pagination.count=t.data.count):e.$message.error(t.message)}))},handlePageChange:function(e){this.pagination.current=e,this.searchProcInstance()},handlePageLimitChange:function(e){this.pagination.limit=e,this.searchProcInstance()},selectChange:function(e){this.$emit("selectChange",e)},openProcessDetail:function(e){this.$emit("process",e)},expandAllRow:function(e){var t=this;return o()(c.a.mark((function n(){return c.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,t.procInstanceData.forEach((function(n){t.$refs.procTable.toggleRowExpansion(n,e)}));case 2:case"end":return n.stop()}}),n)})))()}}},j={name:"service-instance-view",components:{instTable:D,processTable:Object(u.a)(S,(function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",{directives:[{name:"bkloading",rawName:"v-bkloading",value:{isLoading:e.loading},expression:"{isLoading: loading}"}]},[n("bk-table",{ref:"procTable",attrs:{data:e.procInstanceData,pagination:e.pagination},on:{"page-change":e.handlePageChange,"page-limit-change":e.handlePageLimitChange}},[n("bk-table-column",{attrs:{type:"expand",width:"30"},scopedSlots:e._u([{key:"default",fn:function(t){return[n("process-inst",{attrs:{ids:t.row.process_ids,bizId:e.bizId,hasTemp:e.hasTemp},on:{selectChange:e.selectChange,process:e.openProcessDetail,reCount:e.searchProcInstance}})]}}])}),e._v(" "),n("bk-table-column",{attrs:{label:"进程别名","min-width":"60"},scopedSlots:e._u([{key:"default",fn:function(t){return[n("strong",[e._v(e._s(t.row.bk_process_name))])]}}])}),e._v(" "),n("bk-table-column",{attrs:{label:"实例数量"},scopedSlots:e._u([{key:"default",fn:function(t){return[n("span",[e._v(e._s(t.row.process_ids.length))])]}}])})],1)],1)}),[],!1,null,"778e49bf",null).exports},props:{isInst:{type:Boolean,default:function(){return!0}},config:{type:Object,default:function(){return{}}}},computed:{bizId:function(){return this.config.bizId},moduleId:function(){return this.config.currNode.bk_inst_id},pageTransfer:function(){return{start:(this.pagination.current-1)*this.pagination.limit,limit:this.pagination.limit}}},data:function(){return{loading:!1,instFilter:{},procFilter:"",checklist:[],selectedProcessConfig:{},instSelectedIds:[],hasTemp:!1}},created:function(){this.$store.dispatch("obj/searchObjectAttribute",{bk_obj_id:"process"}),this.$store.dispatch("obj/searchObjectGroup",{bk_obj_id:"process"})},methods:{refresh:function(){this.isInst?this.$refs.instTable.searchServiceInstance():this.$refs.procTable.searchProcInstance()},expandAll:function(e){var t=this;return o()(c.a.mark((function n(){return c.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(!t.isInst){n.next=5;break}return n.next=3,t.$refs.instTable.expandAllRow(e);case 3:n.next=7;break;case 5:return n.next=7,t.$refs.procTable.expandAllRow(e);case 7:case"end":return n.stop()}}),n)})))()},getInstAllData:function(){return this.$refs.instTable.serviceInstanceData},editProcess:function(e){this.$emit("process",e)},labelEdit:function(e){this.$emit("label-edit",e)},selectChange:function(e){this.$emit("instSelectChange",e)},hasTemplate:function(e){this.hasTemp=e,this.$emit("hasTemplate",e)},copyIps:function(e){this.$refs.instTable.copyIps()}}},P=Object(u.a)(j,(function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",{directives:[{name:"bkloading",rawName:"v-bkloading",value:{isLoading:e.loading},expression:"{isLoading: loading}"}]},[e.isInst?n("inst-table",{ref:"instTable",attrs:{config:e.config,filter:e.instFilter},on:{process:e.editProcess,selectChange:e.selectChange,"label-edit":e.labelEdit,hasTemplate:e.hasTemplate}}):n("process-table",{ref:"procTable",attrs:{config:e.config,hasTemp:e.hasTemp,filter:e.procFilter},on:{process:e.editProcess,selectChange:e.selectChange}})],1)}),[],!1,null,"388c9e8a",null).exports,z={name:"service-instance-label-edit",props:{config:{type:Object,default:function(){return{isBatch:!1,isShow:!1,bizId:null,instanceIds:[],existingLabels:[],labels:{}}}}},data:function(){return{loading:!1,formData:{keyValue:[]},labelsSet:[],batchDelLabels:[],deltype:!1,rules:{key:[{required:!0,message:"该字段为必填项",trigger:"blur"},{validator:this.checkDuplicate,message:"标签键不能重复",trigger:"blur"},{regex:/^[a-zA-Z]{1,}[a-zA-Z0-9]{0,}$/,message:"请输入英文/数字，以英文开头",trigger:"blur"}],value:[{required:!0,message:"该字段为必填项",trigger:"blur"},{regex:/^[a-zA-Z0-9]{0,}$/,message:"请输入英文/数字",trigger:"blur"}]}}},computed:{updateData:function(){var e={};return this.formData.keyValue.forEach((function(t){e[t.key]=t.value})),this.deltype=!1,e}},watch:{"config.labels":function(e){this.deltype=!1,this.makeFormData(e)},"config.existingLabels":function(e){this.deltype=!1,this.labelsSet=this.$copy(e)}},methods:{makeFormData:function(e){var t=this;this.formData.keyValue=[],e&&Object.keys(e).length?Object.keys(e).forEach((function(n){t.formData.keyValue.push({key:n,value:e[n]})})):this.formData.keyValue.push({key:void 0,value:void 0})},validate:function(){var e=this;this._getLabelsOp().del;1!==this.formData.keyValue.length||this.formData.keyValue[0].key||this.formData.keyValue[0].value?this.$refs.form.validate().then((function(t){t?e.updateInstLabel(e._getLabelsOp().del.length):e.$message.error("验证失败！")})):this.updateInstLabel(this._getLabelsOp().del.length)},cancel:function(){this.$refs.form.clearError()},updateInstLabel:function(e){var t=this,n=this._getLabelsOp(),i={bk_biz_id:this.config.bizId,instance_ids:this.config.instanceIds,labels:n.add},s={bk_biz_id:this.config.bizId,instance_ids:this.config.instanceIds,keys:n.del};e>0?this.$api.cc.business_service.delete_service_instance_labels(s).then((function(e){e.result?t.addservice(i):t.$message.error("更新标签失败: ".concat(e.message))})):this.addservice(i)},addservice:function(e){var t=this;this.$api.cc.business_service.add_service_instance_labels(e).then((function(e){e.result?(t.config.isShow=!1,t.$emit("refresh"),t.batchDelLabels=[]):t.$message.error("更新标签失败: ".concat(e.message))}))},_getLabelsOp:function(){var e=[],t={};if(this.formData.keyValue.forEach((function(e){e.key&&e.value&&(t[e.key]=e.value)})),this.config.isBatch)e=this.batchDelLabels;else{var n=this.$copy(this.config.labels);Object.keys(n).forEach((function(i){t.hasOwnProperty(i)?t[i]!==n[i]&&e.push(i):e.push(i)}))}return{add:t,del:e}},addLabel:function(){this.formData.keyValue.find((function(e){return!e.key||!e.value}))?this.$message.warning("请填写完整标签键/值"):this.formData.keyValue.push({key:void 0,value:void 0})},checkDuplicate:function(e){var t=0;return this.config.isBatch&&this.labelsSet.forEach((function(n){n.key===e&&t++})),this.formData.keyValue.forEach((function(n){n.key===e&&t++})),t<=1},delLabel:function(e){if(1===this.formData.keyValue.length)return e.key="",void(e.value="");var t=this.formData.keyValue.indexOf(e);this.formData.keyValue.splice(t,1),this.deltype=!0},batchDelLabel:function(e){this.batchDelLabels.push(this.labelsSet.splice(e,1)[0].key)}}},E={name:"cmdb-service-instance",components:{instanceProcess:_,instanceTableView:P,LabelsEdit:Object(u.a)(z,(function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("bk-dialog",{attrs:{width:580,"header-position":"left",title:e.config.isBatch?"批量编辑（已选择"+e.config.instanceIds.length+"个实例）":"编辑标签","confirm-fn":e.validate},on:{cancel:e.cancel},model:{value:e.config.isShow,callback:function(t){e.$set(e.config,"isShow",t)},expression:"config.isShow"}},[e.config.isBatch?n("div",{staticClass:"exisiting-label"},[n("div",{staticClass:"title"},[e._v("已有标签\n            "),n("span",{staticClass:"tips"},[e._v("（列表为所选实例标签的集合）")])]),e._v(" "),n("div",{staticClass:"label-set"},e._l(e.labelsSet,(function(t,i){return n("span",{key:i,staticClass:"label-item"},[e._v(e._s(t.key+":"+t.value)+"\n            "),n("i",{staticClass:"bk-icon icon-close-circle-shape",on:{click:function(t){return e.batchDelLabel(i)}}})])})),0)]):e._e(),e._v(" "),n("bk-form",{ref:"form",staticClass:"mt10",attrs:{"label-width":0,model:e.formData,rules:e.rules}},[e.config.isBatch?n("div",{staticClass:"batch-title"},[e._v("批量添加标签")]):e._e(),e._v(" "),e._l(e.formData.keyValue,(function(t,i){return n("div",{key:i},[n("div",[n("bk-form-item",{attrs:{"form-type":"inline",rules:e.rules.key,property:"keyValue."+i+".key","error-display-type":"normal"}},[n("bk-input",{staticClass:"input-item item-key",attrs:{placeholder:"Key:请输入英文/数字，以英文开头"},model:{value:t.key,callback:function(n){e.$set(t,"key",n)},expression:"item.key"}})],1),e._v(" "),n("span",{staticClass:"symbol"},[e._v(":")]),e._v(" "),n("bk-form-item",{attrs:{"form-type":"inline",rules:e.rules.value,property:"keyValue."+i+".value","error-display-type":"normal"}},[n("bk-input",{staticClass:"input-item item-value",attrs:{placeholder:"Value:请输入英文/数字"},model:{value:t.value,callback:function(n){e.$set(t,"value",n)},expression:"item.value"}})],1),e._v(" "),n("div",{staticClass:"ml10",staticStyle:{display:"inline-block"}},[n("i",{staticClass:"bk-icon icon-plus-circle-shape icon-btn",class:i===e.formData.keyValue.length-1?"op-icon":"no-label",on:{click:e.addLabel}}),e._v(" "),n("i",{staticClass:"bk-icon icon-minus-circle-shape icon-btn",class:1!==e.formData.keyValue.length||t.key||t.value?"op-icon":"icon-disable",on:{click:function(n){(1!==e.formData.keyValue.length||t.key||t.value)&&e.delLabel(t)}}})])],1)])}))],2)],1)}),[],!1,null,"56bd6bc7",null).exports,ProcessEdit:h},props:{config:{type:Object,default:function(){return{}}}},computed:{bizId:function(){return this.config.bizId},moduleId:function(){return this.config.currNode.bk_inst_id},operations:function(){return this.setOperations()},disabled:function(){return!this.selection.length}},data:function(){return{changStatus:!0,loading:!1,isLeft:!0,labelConfig:{isShow:!1,instanceIds:[],labels:{}},selection:[],condition:"",instanceDetailsConfig:{},isTemp:!1}},methods:{instSelectChange:function(e){this.selection=e},hasTemplate:function(e){this.isTemp=e},checkoutMode:function(){var e=this;this.changStatus=!1,this.isLeft=!this.isLeft,this.$nextTick((function(){e.changStatus=!0}))},setOperations:function(){if(this.isLeft)return{left:[{"bk-button":{title:"新增",theme:"primary",operation:this.openCreateInstPage,marginLeft:0}},{"cmdb-more-op":{labelTitle:"实例操作",width:"90px",datas:[{operation:this.batchDeleteInst,title:this.$t("批量删除")},{operation:this.copyClip,title:this.$t("复制IP")},{operation:this.batchEditLabels,title:this.$t("编辑标签")}],nameKey:"name",value:""}}],right:[{"service-instance-expand-all":{title:"全部展开",operation:this.expandAll,marginLeft:"10px",marginRight:"10px"}},{"service-instance-search":{operation:this.filterInst,marginLeft:"10px",marginRight:"0px",width:"200px"}},{"service-instance-checkout":{operation:this.checkoutMode,marginLeft:"10px",marginRight:"0px"}}]};var e={left:[{"bk-button":{title:"编辑",theme:"primary",operation:this.batchEditProcessByIds,marginLeft:0,disabled:this.disabled}}],right:[{"service-instance-expand-all":{title:"全部展开",operation:this.expandAll,marginLeft:"10px",marginRight:"10px"}},{"process-search":{operation:this.filterProcess,placeholder:"进程别名",marginLeft:"10px",marginRight:"0px",width:"300px",leftIcon:"bk-icon icon-search",iconClick:this.refresh}},{"service-instance-checkout":{operation:this.checkoutMode,isLeft:this.isLeft,marginLeft:"10px",marginRight:"0px"}}]};return this.isTemp||e.left.push({"bk-button":{title:"删除",theme:"default",operation:this.batchDeleteProcess,marginLeft:0,disabled:this.disabled}}),e},expandAll:function(e){var t=this;return o()(c.a.mark((function n(){return c.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,t.$refs.table.expandAll(e);case 2:case"end":return n.stop()}}),n)})))()},filterInst:function(e){var t=this;this.$refs.table.instFilter=e,this.$nextTick((function(){t.$refs.table.refresh()}))},filterProcess:function(e){this.$refs.table.procFilter=e},checkAllInst:function(e){var t=this;this.$refs.process.forEach((function(t){t.checked=e})),this.checklist=[],e&&this.serviceInstanceData.info.forEach((function(e){t.checklist.push(e.id)}))},openCreateInstPage:function(){this.$router.push({name:"cmdb/service/create-service-instance",params:{bizId:this.bizId,moduleId:this.moduleId}})},openProcessDialog:function(e){this.instanceDetailsConfig={isShow:!0,bizId:this.bizId,moduleId:this.moduleId,currInfo:e.currInfo,currNode:e.currNode,isBatch:e.isBatch||!1,parts:[b.a.attribute],partsConfig:s()({},b.a.attribute.name,{opStatus:e.opStatus,successFn:function(t){e.successFn()}})}},refresh:function(){this.$refs.table.refresh()},batchEditProcessByIds:function(){var e={currNode:{bk_obj_id:"process",isBatch:!0,process_ids:this.selection},currInfo:{},opStatus:"editing",successFn:this.refresh};this.openProcessDialog(e)},batchDeleteProcess:function(){var e=this;this.$bkInfo({title:"确认删除选择的".concat(this.selection.length,"个进程？"),confirmFn:function(){var t={bk_biz_id:e.bizId,process_instance_ids:e.selection};e.$api.cc.business_service.delete_process_instance(t).then((function(t){t.result?e.refresh():e.$message.error(t.message)}))}})},labelEdit:function(e){this.labelConfig=e},batchDeleteInst:function(){var e=this,t=[];this.$refs.table.getInstAllData().forEach((function(n){-1!==e.selection.indexOf(n.id)&&t.push(n)})),this.$router.push({name:"cmdb/service/delete-service-instance",params:{bizId:this.bizId,inst:t}})},batchEditLabels:function(){var e=this,t=[],n=[];this.$refs.table.getInstAllData().forEach((function(i){-1!==e.selection.indexOf(i.id)&&(t.push(i.id),i.labels&&Object.keys(i.labels).forEach((function(e){-1===JSON.stringify(n).indexOf(JSON.stringify({key:e,value:i.labels[e]}))&&n.push({key:e,value:i.labels[e]})})))})),this.labelConfig={isBatch:!0,isShow:!0,bizId:this.bizId,existingLabels:n,instanceIds:t,labels:{}}},copyClip:function(){this.$refs.table.copyIps(this.selection)}}},T=Object(u.a)(E,(function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",{directives:[{name:"bkloading",rawName:"v-bkloading",value:{isLoading:e.loading},expression:"{isLoading: loading}"}],staticClass:"cmdb-service-instance"},["module"!==e.config.currNode.bk_obj_id||0!==e.config.currNode.default?n("div",{staticClass:"empty-content"},[n("div",{staticStyle:{"font-size":"14px"}},[n("bk-icon",{attrs:{type:"info"}}),e._v("\n            非业务模块，无服务实例，请选择业务模块查看\n        ")],1)]):n("div",[n("div",[e.changStatus?n("cmdb-operation",{staticClass:"mb15",attrs:{operations:e.operations,disabled:e.disabled}}):e._e(),e._v(" "),n("instance-table-view",{ref:"table",attrs:{config:e.config,isInst:e.isLeft},on:{"label-edit":e.labelEdit,instSelectChange:e.instSelectChange,process:e.openProcessDialog,hasTemplate:e.hasTemplate}})],1),e._v(" "),n("labels-edit",{attrs:{config:e.labelConfig},on:{refresh:e.refresh}}),e._v(" "),n("process-edit",{attrs:{instanceDetailsConfig:e.instanceDetailsConfig}})],1)])}),[],!1,null,"25295066",null);t.default=T.exports}}]);