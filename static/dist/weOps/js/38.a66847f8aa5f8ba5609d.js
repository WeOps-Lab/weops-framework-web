(window.webpackJsonp=window.webpackJsonp||[]).push([[38],{W9gr:function(e,t,n){"use strict";n.r(t);var r,a=n("G0B5"),o=n("ac6i"),i=n("JnIg"),s=n("uMZD"),c=(r=function(e,t){return r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},r(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),l=function(e,t,n,r){var a,o=arguments.length,i=o<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,n,r);else for(var s=e.length-1;s>=0;s--)(a=e[s])&&(i=(o<3?a(i):o>3?a(t,n,i):a(t,n))||i);return o>3&&i&&Object.defineProperty(t,n,i),i},u=function(e,t,n,r){return new(n||(n=Promise))((function(a,o){function i(e){try{c(r.next(e))}catch(e){o(e)}}function s(e){try{c(r.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,s)}c((r=r.apply(e,t||[])).next())}))},p=function(e,t){var n,r,a,o,i={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return o={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(o){return function(s){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;i;)try{if(n=1,r&&(a=2&o[0]?r.return:o[0]?r.throw||((a=r.return)&&a.call(r),0):r.next)&&!(a=a.call(r,o[1])).done)return a;switch(r=0,a&&(o=[2&o[0],a.value]),o[0]){case 0:case 1:a=o;break;case 4:return i.label++,{value:o[1],done:!1};case 5:i.label++,r=o[1],o=[0];continue;case 7:o=i.ops.pop(),i.trys.pop();continue;default:if(!(a=i.trys,(a=a.length>0&&a[a.length-1])||6!==o[0]&&2!==o[0])){i=0;continue}if(3===o[0]&&(!a||o[1]>a[0]&&o[1]<a[3])){i.label=o[1];break}if(6===o[0]&&i.label<a[1]){i.label=a[1],a=o;break}if(a&&i.label<a[2]){i.label=a[2],i.ops.push(o);break}a[2]&&i.ops.pop(),i.trys.pop();continue}o=t.call(e,i)}catch(e){o=[6,e],r=0}finally{n=a=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,s])}}},f=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.tableLoading=!1,t.maxHeight="",t.dataList=[],t.columns=[],t.processColumns=[{label:"流程名称",key:"name",align:"left",minWidth:"100px",scopedSlots:"processName"},{label:"更新时间",key:"edit_time",align:"left",minWidth:"100px"},{label:"创建人",key:"creator_name",align:"left",minWidth:"100px"},{label:"设为告警自愈流程",key:"set",align:"left",minWidth:"100px",scopedSlots:"set"},{label:"操作",key:"operation",align:"left",width:"150px",scopedSlots:"operation"}],t.recordColumns=[{label:"任务名称",key:"template_name",align:"left",minWidth:"100px",scopedSlots:"taskName"},{label:"执行类型",key:"template_source",align:"left",minWidth:"100px"},{label:"执行开始",key:"start_time",align:"left",minWidth:"100px"},{label:"执行结束",key:"finish_time",align:"left",minWidth:"100px"},{label:"状态",key:"status",align:"left",width:"150px",scopedSlots:"status"}],t.pagination={current:1,count:1,limit:20,showTotalCount:!0},t.searchValue="",t.templateId="",t.statusMap={EXPIRED:{color:"#b2b5bd",text:"过期"},FINISHED:{color:"#2dcb56",text:"完成"},REVOKED:{color:"#b2b5bd",text:"撤销"},RUNNING:{color:"#b2b5bd",text:"执行中"},BLOCKED:{color:"#b2b5bd",text:"执行中"},READY:{color:"#b2b5bd",text:"排队中"},SUSPENDED:{color:"#b2b5bd",text:"暂停"},NODE_SUSPENDED:{color:"#b2b5bd",text:"节点暂停"},FAILED:{color:"#ea3636",text:"失败"},CREATED:{color:"#b2b5bd",text:"未执行"}},t}return c(t,e),Object.defineProperty(t.prototype,"isProcess",{get:function(){return"process"===this.type},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"powerParams",{get:function(){return{id:this.$route.name,type:"operateAuth"}},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"userInfo",{get:function(){return this.$store.state.permission.user},enumerable:!1,configurable:!0}),t.prototype.created=function(){this.updateColumns()},t.prototype.mounted=function(){var e=this;this.maxHeight=window.innerHeight-206,window.onresize=function(){e.maxHeight=window.innerHeight-206},this.getTableData()},t.prototype.enableChange=function(e){return!this.$BtnPermission(this.powerParams)||!!e.is_uac_flow&&!e.uac_id},t.prototype.updateColumns=function(){"process"===this.type&&(this.templateId=""),this.columns=this.isProcess?this.processColumns:this.recordColumns,this.pagination={current:1,count:1,limit:20,showTotalCount:!0},this.searchValue="";var e=this.$refs.sourceTable;e&&e.updateColumns(this.columns)},t.prototype.checkRecord=function(e){this.$emit("changeTab",{name:"executionRecord"}),this.templateId=e.template_id},t.prototype.requestHandler=function(e){var t=this;return function(){return new Promise((function(n,r){var a=e.is_uac_flow?"deleteExecute":"addExecute",o={};o=e.is_uac_flow?{id:e.uac_id,name:e.name}:{name:e.name,execute_type:"sops",bk_biz_id:2,template_id:e.template_id,exec_user:t.userInfo.username,template_source:"common",is_enable:!0},t.$api.selfCureProcess[a](o).then((function(e){var a=e.result,o=e.message;if(!a)return t.$error(o),r(),!1;t.$success("设置成功!"),t.getTableData(),n()}))}))}},t.prototype.checkRecordDetail=function(e){this.$router.push({name:"RecordDetails",query:{id:e.project.id,instance_id:e.instance_id}})},t.prototype.deleteTemplate=function(e){var t=this;if(!this.$BtnPermission(this.powerParams))return!1;a.e.prototype.$bkInfo({title:"确认要删除该流程？",confirmLoading:!0,confirmFn:function(){return u(t,void 0,void 0,(function(){return p(this,(function(t){switch(t.label){case 0:return[4,this.confirmDelete(e)];case 1:return t.sent(),[2]}}))}))}})},t.prototype.confirmDelete=function(e){return u(this,void 0,void 0,(function(){var t;return p(this,(function(n){switch(n.label){case 0:return n.trys.push([0,2,,3]),[4,this.$api.autoProcess.deleteTemplate({id:e.id})];case 1:return(t=n.sent()).result?(this.$success("删除成功!"),this.pagination.current>1&&1===this.dataList.length&&this.pagination.current--,this.getTableData()):this.$error(t.message),[2,!0];case 2:return n.sent(),[2,!1];case 3:return[2]}}))}))},t.prototype.getTableData=function(){var e=this,t=this.isProcess?"getCommonTemplate":"getTaskFlow",n={page:this.pagination.current,page_size:this.pagination.limit};this.isProcess?n.template_name=this.searchValue:(n.template_id=this.templateId,n.task_name=this.searchValue),this.tableLoading=!0,this.$api.autoProcess[t](n).then((function(t){var n=t.data;if(!t.result)return!1;e.dataList=n.objects,e.pagination.count=n.meta.total_count})).finally((function(){e.tableLoading=!1}))},t.prototype.handleProcess=function(e,t){if(!this.$BtnPermission(this.powerParams))return!1;var n={type:e};"edit"===e&&(n.id=t.id),this.$router.push({name:"Process",query:n})},t.prototype.handlePageChange=function(e){this.pagination.current=e,this.getTableData()},t.prototype.limitChange=function(e){this.pagination.limit=e,this.pagination.current=1,this.getTableData()},l([Object(a.d)({type:String,default:function(){return""}})],t.prototype,"type",void 0),t=l([Object(a.a)({components:{ComTable:i.a}})],t)}(a.e),h=f,m=n("KHd+"),d=Object(m.a)(h,(function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",{staticClass:"show-box"},[n("div",{staticClass:"search-bar"},[n("bk-input",{attrs:{clearable:"",placeholder:"请输入搜索关键字","right-icon":"bk-icon icon-search"},on:{"right-icon-click":e.getTableData,clear:e.getTableData,enter:e.getTableData},model:{value:e.searchValue,callback:function(t){e.searchValue=t},expression:"searchValue"}}),e._v(" "),e.isProcess?n("bk-button",{directives:[{name:"permission",rawName:"v-permission",value:e.powerParams,expression:"powerParams"}],staticClass:"ml20",attrs:{theme:"primary"},on:{click:function(t){return e.handleProcess("add")}}},[e._v("\n            新建流程\n        ")]):e._e()],1),e._v(" "),n("com-table",{directives:[{name:"bkloading",rawName:"v-bkloading",value:{isLoading:e.tableLoading,zIndex:10},expression:"{ isLoading: tableLoading, zIndex: 10 }"}],ref:"sourceTable",staticClass:"com-table",attrs:{id:"center_table",data:e.dataList,columns:e.columns,"max-height":e.maxHeight,pagination:e.pagination},on:{"page-change":e.handlePageChange,"page-limit-change":e.limitChange},scopedSlots:e._u([{key:"processName",fn:function(t){var r=t.row;return[n("span",{directives:[{name:"permission",rawName:"v-permission",value:e.powerParams,expression:"powerParams"}],staticStyle:{color:"#1272FF",cursor:"pointer"},on:{click:function(t){return e.handleProcess("edit",r)}}},[e._v(e._s(r.name))])]}},{key:"taskName",fn:function(t){var r=t.row;return[n("span",{staticStyle:{color:"#1272FF",cursor:"pointer"},on:{click:function(t){return e.checkRecordDetail(r)}}},[e._v(e._s(r.template_name))])]}},{key:"status",fn:function(t){var r=t.row;return[n("div",[n("span",{staticClass:"record-status",style:{backgroundColor:e.statusMap[r.status]&&e.statusMap[r.status].color}}),e._v(" "),n("span",[e._v(e._s(e.statusMap[r.status]&&e.statusMap[r.status].text||"未知"))])])]}},{key:"set",fn:function(t){var r=t.row;return[n("bk-switcher",{directives:[{name:"permission",rawName:"v-permission",value:e.powerParams,expression:"powerParams"}],attrs:{disabled:e.enableChange(r),"pre-check":e.requestHandler(r),theme:"primary"},model:{value:r.is_uac_flow,callback:function(t){e.$set(r,"is_uac_flow",t)},expression:"row.is_uac_flow"}})]}},{key:"operation",fn:function(t){var r=t.row;return[n("bk-button",{staticClass:"mr10",attrs:{theme:"primary",text:""},on:{click:function(t){return e.checkRecord(r)}}},[e._v("执行记录")]),e._v(" "),n("bk-button",{directives:[{name:"permission",rawName:"v-permission",value:e.powerParams,expression:"powerParams"}],staticClass:"mr10",attrs:{theme:"primary",text:""},on:{click:function(t){return e.deleteTemplate(r)}}},[e._v("删除")])]}}])})],1)}),[],!1,null,"1caf11b7",null).exports,b=function(){var e=function(t,n){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},e(t,n)};return function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),y=function(e,t,n,r){var a,o=arguments.length,i=o<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,n,r);else for(var s=e.length-1;s>=0;s--)(a=e[s])&&(i=(o<3?a(i):o>3?a(t,n,i):a(t,n))||i);return o>3&&i&&Object.defineProperty(t,n,i),i},g=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.menuList=[{label:"流程",name:"process"},{label:"执行记录",name:"executionRecord"}],t.active="process",t}return b(t,e),t.prototype.toTabMenu=function(e){var t=this;this.active=e.name,this.$nextTick((function(){t.$refs.process.updateColumns(),t.$refs.process.getTableData()}))},t=y([Object(a.a)({components:{menuTab:o.a,ComTable:i.a,HeaderSub:s.a,process:d}})],t)}(a.e),v=g,_=Object(m.a)(v,(function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",{staticClass:"auto-process"},[n("menu-tab",{attrs:{panels:e.menuList,type:"text","active-panel":e.active},on:{click:e.toTabMenu}}),e._v(" "),n("div",{staticClass:"table-box"},[n("process",{ref:"process",attrs:{type:e.active},on:{changeTab:e.toTabMenu}})],1)],1)}),[],!1,null,"32f75e69",null);t.default=_.exports}}]);