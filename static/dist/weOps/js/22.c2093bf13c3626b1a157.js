(window.webpackJsonp=window.webpackJsonp||[]).push([[22],{p9Aj:function(t,e,i){"use strict";i.r(e);var a,n=i("JnIg"),s=i("G0B5"),o=(a=function(t,e){return a=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])},a(t,e)},function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function i(){this.constructor=t}a(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}),r=function(t,e,i,a){var n,s=arguments.length,o=s<3?e:null===a?a=Object.getOwnPropertyDescriptor(e,i):a;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(t,e,i,a);else for(var r=t.length-1;r>=0;r--)(n=t[r])&&(o=(s<3?n(o):s>3?n(e,i,o):n(e,i))||o);return s>3&&o&&Object.defineProperty(e,i,o),o},l=function(t,e,i,a){return new(i||(i=Promise))((function(n,s){function o(t){try{l(a.next(t))}catch(t){s(t)}}function r(t){try{l(a.throw(t))}catch(t){s(t)}}function l(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(o,r)}l((a=a.apply(t,e||[])).next())}))},c=function(t,e){var i,a,n,s,o={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]};return s={next:r(0),throw:r(1),return:r(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function r(s){return function(r){return function(s){if(i)throw new TypeError("Generator is already executing.");for(;o;)try{if(i=1,a&&(n=2&s[0]?a.return:s[0]?a.throw||((n=a.return)&&n.call(a),0):a.next)&&!(n=n.call(a,s[1])).done)return n;switch(a=0,n&&(s=[2&s[0],n.value]),s[0]){case 0:case 1:n=s;break;case 4:return o.label++,{value:s[1],done:!1};case 5:o.label++,a=s[1],s=[0];continue;case 7:s=o.ops.pop(),o.trys.pop();continue;default:if(!(n=o.trys,(n=n.length>0&&n[n.length-1])||6!==s[0]&&2!==s[0])){o=0;continue}if(3===s[0]&&(!n||s[1]>n[0]&&s[1]<n[3])){o.label=s[1];break}if(6===s[0]&&o.label<n[1]){o.label=n[1],n=s;break}if(n&&o.label<n[2]){o.label=n[2],o.ops.push(s);break}n[2]&&o.ops.pop(),o.trys.pop();continue}s=e.call(t,o)}catch(t){s=[6,t],a=0}finally{i=n=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,r])}}},p=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.loading=!1,e.visible=!1,e.dataList=[],e.columns=[{label:"服务器IP",key:"ip",align:"left",minWidth:"150px"},{label:"主机名称",key:"host_name",align:"left",minWidth:"150px"},{label:"操作系统名称",key:"os",align:"left",minWidth:"150px"},{label:"所属业务",key:"bk_biz_name",align:"left",minWidth:"100px"},{label:"补丁名称",key:"patch_file_name",align:"left",minWidth:"150px"},{label:"分发状态",key:"file_push_status",align:"left",minWidth:"100px",scopedSlots:"distributionStatus",filterable:!0,filterMultiple:!1,filterRemote:!0,filters:[{text:"未分发",value:"no_start"},{text:"分发中",value:"running"},{text:"已分发",value:"success"},{text:"分发失败",value:"failed"},{text:"异常",value:"error"}]},{label:"安装状态",key:"install_status",align:"left",minWidth:"100px",scopedSlots:"installStatus",filterable:!0,filterMultiple:!1,filterRemote:!0,filters:[{text:"未安装",value:"no_start"},{text:"进行中",value:"running"},{text:"成功",value:"success"},{text:"失败",value:"failed"},{text:"异常",value:"error"}]}],e.installStatusColor={"成功":"#2DCB56","失败":"#EA3636","进行中":"#3A84FF","未安装":"#C4C6CC","异常":"#FF9C01"},e.pushStatusColor={"已分发":"#2DCB56","分发失败":"#EA3636","分发中":"#3A84FF","未分发":"#C4C6CC","异常":"#FF9C01"},e.filterCondition={file_push_status:"",install_status:""},e.pagination={current:1,count:1,limit:10},e.patchTaskId=0,e.taskName="",e.timer=null,e.summaryInfo={list:[{label:"未安装",key:"no_start",count:0,color:"#C4C6CC"},{label:"安装中",key:"running",count:0,color:"#3A84FF"},{label:"安装成功",key:"success",count:0,color:"#2DCB56"},{label:"安装失败",key:"failed",count:0,color:"#EA3636"},{label:"异常",key:"error",count:0,color:"#FF9C01"}],total:0},e.taskInfo="",e.isAllowNext=!0,e.tableShow=!0,e}return o(e,t),Object.defineProperty(e.prototype,"tableList",{get:function(){var t=this;return this.dataList.filter((function(e,i){return i<t.pagination.current*t.pagination.limit&&i>=t.pagination.limit*(t.pagination.current-1)}))},enumerable:!1,configurable:!0}),e.prototype.onVisibleChanged=function(t){!t&&this.timer&&clearInterval(this.timer)},e.prototype.afterLeave=function(){var t=this;Object.assign(this.$data,this.$options.data.call(this)),this.timer&&clearInterval(this.timer),this.tableShow=!1,this.$nextTick((function(){t.tableShow=!0}))},e.prototype.filterChange=function(t){t.file_push_status&&(t.file_push_status.length>0?this.filterCondition.file_push_status=t.file_push_status[0]:this.filterCondition.file_push_status=""),t.install_status&&(t.install_status.length>0?this.filterCondition.install_status=t.install_status[0]:this.filterCondition.install_status=""),this.getDetail()},e.prototype.show=function(t){var e=this;this.taskInfo=t,this.loading=!0,this.visible=!0,t&&(this.patchTaskId=t.id,this.taskName=t.name),this.getDetail(),["install","running"].includes(t.progress)&&(this.timer=setInterval((function(){e.getDetail()}),6e4))},e.prototype.getDetail=function(){return l(this,void 0,void 0,(function(){var t,e,i=this;return c(this,(function(a){switch(a.label){case 0:return this.isAllowNext&&this.patchTaskId?(t={patch_task_id:this.patchTaskId},this.filterCondition.file_push_status&&(t.file_push_status=this.filterCondition.file_push_status),this.filterCondition.install_status&&(t.install_status=this.filterCondition.install_status),this.summaryInfo.total=0,this.isAllowNext=!1,this.pagination.current=1,this.dataList=[],this.loading=!0,[4,this.$api.patchInstall.getTaskDetail(t)]):[2,!1];case 1:return e=a.sent(),this.isAllowNext=!0,this.loading=!1,e.result?(this.dataList=e.data.list,this.summaryInfo.list.forEach((function(t){t.count=e.data.summary[t.key],i.summaryInfo.total+=t.count})),this.pagination.count=this.dataList.length,[2]):[2,this.$error(e.message)]}}))}))},e.prototype.handlePageChange=function(t){this.pagination.current=t},e.prototype.limitChange=function(t){this.pagination.limit=t,this.pagination.current=1},r([Object(s.f)("visible",{immediate:!0,deep:!0})],e.prototype,"onVisibleChanged",null),e=r([Object(s.a)({name:"patch-detail",components:{comTable:n.a}})],e)}(s.e),u=p,d=i("KHd+"),h=Object(d.a)(u,(function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("bk-sideslider",{attrs:{"is-show":t.visible,"quick-close":!0,title:"补丁安装详情 - "+t.taskName,width:950,"before-close":t.afterLeave},on:{"update:isShow":function(e){t.visible=e},"update:is-show":function(e){t.visible=e}}},[i("div",{staticClass:"content-box",attrs:{slot:"content"},slot:"content"},[i("div",{staticClass:"main-box"},[i("div",{directives:[{name:"bkloading",rawName:"v-bkloading",value:{isLoading:t.loading,zIndex:10},expression:"{ isLoading: loading, zIndex: 10 }"}]},[i("div",{staticClass:"summary-box"},[i("div",{staticClass:"total"},[i("span",{staticClass:"tag"}),t._v(" "),i("span",{staticStyle:{"font-size":"14px"}},[t._v("服务器总数量:")]),t._v(" "),i("span",{staticStyle:{"font-size":"14px"}},[t._v(t._s(t.summaryInfo.total)+"台")])]),t._v(" "),i("div",{staticClass:"detail-info"},t._l(t.summaryInfo.list,(function(e){return i("div",{key:e.key,staticClass:"detail-info-item"},[i("span",{staticClass:"tag",style:{backgroundColor:e.color}}),t._v(" "),i("span",{staticClass:"label"},[t._v(t._s(e.label)+":")]),t._v(" "),i("span",[t._v(t._s(e.count))])])})),0),t._v(" "),i("bk-button",{staticClass:"btn-refresh",attrs:{title:"刷新"},on:{click:function(e){return t.getDetail()}}},[i("bk-icon",{staticStyle:{"font-size":"18px"},attrs:{type:"refresh"}})],1)],1),t._v(" "),t.tableShow?i("com-table",{ref:"targetTable",attrs:{"max-height":"312",data:t.tableList,columns:t.columns,pagination:t.pagination},on:{"filter-change":t.filterChange,"page-change":t.handlePageChange,"page-limit-change":t.limitChange},scopedSlots:t._u([{key:"distributionStatus",fn:function(e){var a=e.row;return[i("div",{style:{color:t.pushStatusColor[a.file_push_status]}},[t._v(t._s(a.file_push_status))])]}},{key:"installStatus",fn:function(e){var a=e.row;return[i("div",{style:{color:t.installStatusColor[a.install_status]}},[t._v(t._s(a.install_status))])]}}],null,!1,3688011757)}):t._e()],1)])])])}),[],!1,null,"21b39ed5",null).exports,f=i("wd/R"),m=i.n(f),v=function(){var t=function(e,i){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])},t(e,i)};return function(e,i){if("function"!=typeof i&&null!==i)throw new TypeError("Class extends value "+String(i)+" is not a constructor or null");function a(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(a.prototype=i.prototype,new a)}}(),b=function(t,e,i,a){var n,s=arguments.length,o=s<3?e:null===a?a=Object.getOwnPropertyDescriptor(e,i):a;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(t,e,i,a);else for(var r=t.length-1;r>=0;r--)(n=t[r])&&(o=(s<3?n(o):s>3?n(e,i,o):n(e,i))||o);return s>3&&o&&Object.defineProperty(e,i,o),o},g=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.visible=!1,e.isConfirm=!1,e.initDateTime="",e.switcher=!0,e.taskName="",e.pkId=0,e.formData={run_type:0,run_time:"",is_open:!0},e.options=[{id:0,name:"立即执行"},{id:1,name:"定时执行"}],e.summaryExpand=!1,e.taskSummaryInfo=[{key:"os_type",value:"",label:"操作系统类型"},{key:"server_count",value:"",label:"服务器总数量"},{key:"biz_names",value:"",label:"覆盖业务名称"},{key:"patch_file_name",value:"",label:"补丁文件名称"},{key:"mail_notify",value:"",label:"邮件通知设置"},{key:"speed_limit",value:"",label:"传输限速"}],e}return v(e,t),e.prototype.onVisibleChanged=function(t){t||(this.$emit("search"),this.isConfirm=!1)},e.prototype.changeType=function(t){1===t&&(this.formData.is_open=!0)},e.prototype.showDialog=function(t){this.visible=!0,this.summaryExpand=!1,this.pkId=t.id,this.taskName=t.name,this.formData=this.$deepClone(t.schedule_obj),this.taskSummaryInfo.forEach((function(e){if("mail_notify"===e.key)e.value=t[e.key]?"开启":"关闭";else if("biz_names"===e.key){var i=t[e.key]||[];i.length>3?e.value=i.slice(0,3).join("、")+"等".concat(i.length,"个系统"):e.value=i.join("、")}else e.value=t[e.key]}))},e.prototype.confirm=function(){var t=this;if(this.formData.run_type&&this.formData.is_open&&!this.formData.run_time)this.$error("请选择开始时间");else{this.isConfirm=!0;var e={};this.formData.run_type?this.formData.is_open?(this.formData.run_time=m()(this.formData.run_time).format("YYYY-MM-DD HH:mm:ss"),e={run_type:this.formData.run_type,run_time:this.formData.run_time,is_open:this.formData.is_open}):e={run_type:this.formData.run_type,is_open:this.formData.is_open}:e={run_type:this.formData.run_type},this.$api.patchInstall.executePatchTask(this.pkId,e).then((function(e){t.isConfirm=!1,e.result?(t.visible=!1,t.$emit("search"),t.$success("设置执行类型成功，请稍候")):t.$error(e.message)}))}},b([Object(s.f)("visible",{immediate:!0,deep:!0})],e.prototype,"onVisibleChanged",null),e=b([Object(s.a)({name:"exec-task"})],e)}(s.e),y=g,_=Object(d.a)(y,(function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("bk-sideslider",{attrs:{"is-show":t.visible,"quick-close":!0,title:"执行设置",width:500},on:{"update:isShow":function(e){t.visible=e},"update:is-show":function(e){t.visible=e}}},[i("div",{staticClass:"content-box",attrs:{slot:"content"},slot:"content"},[i("div",{staticClass:"main-box"},[i("bk-form",{staticClass:"execute-wrapper"},[i("bk-form-item",{attrs:{property:"run_type","error-display-type":"normal"}},[i("div",{staticClass:"execute-type-wrapper"},[i("bk-radio-group",{on:{change:t.changeType},model:{value:t.formData.run_type,callback:function(e){t.$set(t.formData,"run_type",e)},expression:"formData.run_type"}},t._l(t.options,(function(e){return i("bk-radio",{key:e.id,attrs:{value:e.id}},[t._v("\n                                "+t._s(e.name)+"\n                            ")])})),1),t._v(" "),1===t.formData.run_type?[i("div",{staticClass:"exec-time-setting mt10"},[i("div",{staticClass:"date-wrapper"},[i("span",{staticClass:"time-text"},[t._v("开始时间")]),t._v(" "),i("bk-date-picker",{staticStyle:{width:"300px"},attrs:{placeholder:"选择日期时间",type:"datetime",disabled:!t.formData.is_open},model:{value:t.formData.run_time,callback:function(e){t.$set(t.formData,"run_time",e)},expression:"formData.run_time"}})],1),t._v(" "),i("div",{staticClass:"switcher-wrapper"},[i("span",{staticClass:"switcher-text"},[t._v("定时开关")]),t._v(" "),i("bk-switcher",{attrs:{theme:"primary"},model:{value:t.formData.is_open,callback:function(e){t.$set(t.formData,"is_open",e)},expression:"formData.is_open"}})],1)])]:t._e()],2)]),t._v(" "),i("bk-form-item",[i("div",{staticClass:"task-summary"},[i("div",{staticClass:"summary-header",on:{click:function(e){t.summaryExpand=!t.summaryExpand}}},[i("bk-icon",{staticClass:"icon",attrs:{type:t.summaryExpand?"down-shape":"right-shape"}}),t._v(" "),i("span",[t._v("任务摘要")])],1),t._v(" "),t.summaryExpand?i("div",{staticClass:"summary-body"},t._l(t.taskSummaryInfo,(function(e){return i("div",{key:e.key,staticClass:"summary-list"},[i("div",{staticClass:"label"},[t._v(t._s(e.label)+":")]),t._v(" "),i("div",{directives:[{name:"bk-overflow-tips",rawName:"v-bk-overflow-tips"}],class:["content","biz_names"!==e.key&&"hideText"]},[i("span",[t._v(t._s(e.value||"--"))]),t._v(" "),"server_count"===e.key?i("span",[t._v("台")]):t._e(),t._v(" "),"speed_limit"===e.key?i("span",[t._v("MB/s")]):t._e()])])})),0):t._e()])]),t._v(" "),i("bk-form-item",[i("bk-icon",{attrs:{type:"info-circle"}}),t._v(" "),i("span",{staticStyle:{"font-size":"10px",color:"#979BA5"}},[t._v("执行设置成功后，将会自动执行补丁任务，建议确认重要信息是否备份")])],1)],1)],1),t._v(" "),i("div",{staticClass:"footer-box"},[i("bk-button",{attrs:{theme:"default"},on:{click:function(e){t.visible=!1}}},[t._v("取消")]),t._v(" "),i("bk-button",{staticStyle:{"margin-right":"20px"},attrs:{loading:t.isConfirm,theme:"primary"},on:{click:t.confirm}},[t._v("\n                确定\n            ")])],1)])])}),[],!1,null,"360fabda",null).exports,k=function(){var t=function(e,i){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])},t(e,i)};return function(e,i){if("function"!=typeof i&&null!==i)throw new TypeError("Class extends value "+String(i)+" is not a constructor or null");function a(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(a.prototype=i.prototype,new a)}}(),w=function(){return w=Object.assign||function(t){for(var e,i=1,a=arguments.length;i<a;i++)for(var n in e=arguments[i])Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t},w.apply(this,arguments)},x=function(t,e,i,a){var n,s=arguments.length,o=s<3?e:null===a?a=Object.getOwnPropertyDescriptor(e,i):a;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(t,e,i,a);else for(var r=t.length-1;r>=0;r--)(n=t[r])&&(o=(s<3?n(o):s>3?n(e,i,o):n(e,i))||o);return s>3&&o&&Object.defineProperty(e,i,o),o},C=function(t,e,i,a){return new(i||(i=Promise))((function(n,s){function o(t){try{l(a.next(t))}catch(t){s(t)}}function r(t){try{l(a.throw(t))}catch(t){s(t)}}function l(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(o,r)}l((a=a.apply(t,e||[])).next())}))},S=function(t,e){var i,a,n,s,o={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]};return s={next:r(0),throw:r(1),return:r(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function r(s){return function(r){return function(s){if(i)throw new TypeError("Generator is already executing.");for(;o;)try{if(i=1,a&&(n=2&s[0]?a.return:s[0]?a.throw||((n=a.return)&&n.call(a),0):a.next)&&!(n=n.call(a,s[1])).done)return n;switch(a=0,n&&(s=[2&s[0],n.value]),s[0]){case 0:case 1:n=s;break;case 4:return o.label++,{value:s[1],done:!1};case 5:o.label++,a=s[1],s=[0];continue;case 7:s=o.ops.pop(),o.trys.pop();continue;default:if(!(n=o.trys,(n=n.length>0&&n[n.length-1])||6!==s[0]&&2!==s[0])){o=0;continue}if(3===s[0]&&(!n||s[1]>n[0]&&s[1]<n[3])){o.label=s[1];break}if(6===s[0]&&o.label<n[1]){o.label=n[1],n=s;break}if(n&&o.label<n[2]){o.label=n[2],o.ops.push(s);break}n[2]&&o.ops.pop(),o.trys.pop();continue}s=e.call(t,o)}catch(t){s=[6,t],a=0}finally{i=n=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,r])}}},D=function(t,e,i){if(i||2===arguments.length)for(var a,n=0,s=e.length;n<s;n++)!a&&n in e||(a||(a=Array.prototype.slice.call(e,0,n)),a[n]=e[n]);return t.concat(a||Array.prototype.slice.call(e))},T=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.currentTab="list",e.addServerVisible=!1,e.isConfirm=!1,e.selectLoading=!1,e.businessType=[],e.businessTypeList=[],e.isTopoShow=!0,e.cascadeLoading=!1,e.businessTopo=[],e.businessTopoList=[],e.searchValue="",e.serverList=[],e.loading=!1,e.pagination={current:1,count:1,limit:10},e.statusFilters=[{text:"正常",value:"RUNNING"},{text:"异常",value:"TERMINATED"},{text:"未安装",value:"NOT_INSTALLED"}],e.statusColorInter={"正常":"#3FC06D","异常":"#EA3636","未安装":"#C4C6CC"},e.statusColorOuter={"正常":"#E5F6EA","异常":"#FFE6E6","未安装":"#F0F1F5"},e.selectedServer=[],e.osType=1,e.formData={},e.dataList=[],e.filterParams=[],e.currentMode="multiple",e.manualAddIp="",e.errorIp="",e.manualLoading=!1,e.conditions=[],e}return k(e,t),e.prototype.onSearchValueChanged=function(t){var e=this;t.trim().length>0?this.currentMode="radio":(this.currentMode="multiple",this.businessTypeList.forEach((function(t){e.$set(t,"disabled",!1)})))},e.prototype.onManualAddIpChanged=function(t){0===t.trim().length&&(this.errorIp="")},e.prototype.onCurrentTabChanged=function(t){var e=this,i=this.selectedServer.map((function(t){return t.inner_ip}));this.$nextTick((function(){e.serverList.forEach((function(t){var a=e.$refs.targetTable;a&&a.toggleRowSelection(t,i.includes(t.inner_ip))}))}))},e.prototype.changeTab=function(){this.errorIp="",this.manualAddIp=""},e.prototype.addIpSelected=function(){var t=this;if(0===this.manualAddIp.trim().length)return this.$warn("请在输入框输入IP地址"),!1;this.manualLoading=!0,this.$api.patchInstall.manualMatchIp({os_type:"Windows"===this.formData.osType?"2":"1",ip_query:this.manualAddIp}).then((function(e){e.result?(t.$success("添加成功!"),t.manualAddIp=""):(t.$error(e.message),e.error_ip&&(t.errorIp=e.error_ip,t.manualAddIp=e.error_ip)),(e.success_ip||[]).forEach((function(e){t.selectedServer.find((function(t){return t.inner_ip===e.inner_ip}))||t.selectedServer.push(e)}))})).finally((function(){t.manualLoading=!1}))},e.prototype.show=function(t,e){return void 0===e&&(e=[]),C(this,void 0,void 0,(function(){return S(this,(function(i){switch(i.label){case 0:return this.dataList=JSON.parse(JSON.stringify(e)),this.currentTab="list",this.errorIp="",this.currentMode="multiple",this.addServerVisible=!0,this.formData=JSON.parse(JSON.stringify(t)),this.selectedServer=[],this.serverList=[],this.businessType=[],this.manualAddIp="",this.businessTopo=[],this.searchValue="",this.selectedServer=this.dataList,this.osType="Linux"===this.formData.osType?1:2,this.pagination.current=1,[4,this.getBusinessTypeList()];case 1:return i.sent(),[4,this.getBusinessTopoList()];case 2:return i.sent(),[2]}}))}))},e.prototype.getBusinessTopoList=function(){return C(this,void 0,void 0,(function(){var t,e=this;return S(this,(function(i){switch(i.label){case 0:return"radio"===this.currentMode&&1===this.businessType.length?this.businessTypeList.forEach((function(t){t.bk_biz_id!==e.businessType[0]&&e.$set(t,"disabled",!0)})):this.businessTypeList.forEach((function(t){e.$set(t,"disabled",!1)})),this.pagination.current=1,this.businessTopo=[],this.isTopoShow=!1,this.$nextTick((function(){e.isTopoShow=!0})),[4,this.getServerList()];case 1:return i.sent(),t={},1!==this.businessType.length?[3,3]:(this.cascadeLoading=!0,[4,this.$api.patchInstall.getBusinessTopoList({bk_biz_id:this.businessType[0]})]);case 2:if(t=i.sent(),this.cascadeLoading=!1,this.selectLoading=!1,!t.result)return[2,this.$error("获取业务拓扑列表失败"+t.message)];this.businessTopoList=this.recursionArr(t.data[0].child),i.label=3;case 3:return[2]}}))}))},e.prototype.recursionArr=function(t){var e=this;return t.map((function(t){return t.child.length?{id:t.bk_inst_id,name:t.bk_inst_name,type:t.bk_obj_id,children:e.recursionArr(t.child)}:{id:t.bk_inst_id,name:t.bk_inst_name,type:t.bk_obj_id}}))},e.prototype.getBusinessTypeList=function(){return C(this,void 0,void 0,(function(){var t,e=this;return S(this,(function(i){switch(i.label){case 0:return this.selectLoading=!0,[4,this.$api.patchInstall.getBusinessList()];case 1:return t=i.sent(),this.selectLoading=!1,t.result?(this.businessTypeList=t.data,this.businessTypeList.forEach((function(t){e.$set(t,"disabled",!1)})),[2]):[2,this.$error(t.message)]}}))}))},e.prototype.recursion=function(t,e){var i=t.filter((function(t){return t.id===e[0]}));return e.length>1?this.recursion(i[0].children,e.slice(1)):i[0].type},e.prototype.recursionObj=function(t,e){var i=t.filter((function(t){return t.id===e[0]}));return e.length>1?this.recursionObj(i[0].children,e.slice(1)):i[0]},e.prototype.recursionSet=function(t){var e=this,i=[];return t.forEach((function(t){"set"===t.type?i.push(t.id):i=e.recursionSet(t.children)})),i},e.prototype.getServerList=function(){return C(this,void 0,void 0,(function(){var t,e,i,a,n,s,o,r,l,c,p,u,d,h=this;return S(this,(function(f){switch(f.label){case 0:return t=[],e=[],i=[],this.businessTopo.length&&(a=this.recursion(this.businessTopoList,this.businessTopo),n=this.businessTopo.length,"module"===a?(t=[this.businessTopo[n-2]],e=[this.businessTopo[n-1]]):"set"===a?t=[this.businessTopo[n-1]]:(s=this.recursionObj(this.businessTopoList,this.businessTopo),t=s.children?this.recursionSet(s.children):[]),o={},e.length&&(o={bk_module_ids:e}),r={},t.length&&(r={bk_set_ids:t}),i=[{key:"topology",value:w(w({bk_biz_id:this.businessType[0]},r),o)}]),this.loading=!0,l=[],this.searchValue&&(l=[{key:"query",value:this.searchValue}]),this.conditions=D(D(D([{key:"os_type",value:"Windows"===this.formData.osType?"2":"1"}],this.filterParams,!0),l,!0),i,!0),c={},this.conditions.forEach((function(t){c[t.key]=t.value})),p={},this.businessType.length&&(p={bk_biz_id:this.businessType}),[4,this.$api.patchInstall.getServerList(w(w({page:this.pagination.current,page_size:this.pagination.limit},p),c))];case 1:return u=f.sent(),this.loading=!1,u.result?(d=this.selectedServer.map((function(t){return t.inner_ip})),this.serverList=u.data.items,this.pagination.count=u.data.count,this.$nextTick((function(){h.serverList.forEach((function(t){var e=h.$refs.targetTable;e&&e.toggleRowSelection(t,d.includes(t.inner_ip))}))})),[2]):[2,this.$error("获取服务器列表失败!")]}}))}))},e.prototype.filterChange=function(t){this.filterParams=[];var e=Object.keys(t)[0],i={key:e,value:t[e]};t[e].length&&this.filterParams.push(i),this.pagination.current=1,this.getServerList()},e.prototype.handlePageLimitChange=function(t){this.pagination.current=1,this.pagination.limit=t,this.getServerList()},e.prototype.handlePageChange=function(t){this.pagination.current=t,this.getServerList()},e.prototype.selectionChange=function(t,e){var i=(this.selectedServer.map((function(t){return t.inner_ip}))||[]).indexOf(e.inner_ip);i>-1?this.selectedServer.splice(i,1):this.selectedServer.push(e)},e.prototype.selectTargetAll=function(t){var e=this.serverList.map((function(t){return t.inner_ip})),i=this.selectedServer.filter((function(t){return!e.includes(t.inner_ip)}));this.selectedServer=D(D([],i,!0),t,!0)},e.prototype.conditionSearch=function(){this.pagination.current=1,this.getServerList()},e.prototype.deleteSelected=function(t){var e=this;"all"===t?this.selectedServer=[]:this.selectedServer.splice(t,1);var i=this.selectedServer.map((function(t){return t.inner_ip}));this.$nextTick((function(){e.serverList.forEach((function(t){var a=e.$refs.targetTable;a&&a.toggleRowSelection(t,i.includes(t.inner_ip))}))}))},e.prototype.addServer=function(){var t=this;this.dataList=this.selectedServer,this.dataList.forEach((function(e){e.os_type=t.formData.osType})),this.addServerVisible=!1,this.$emit("sendServerList",this.dataList)},e.prototype.cancelAdd=function(){this.addServerVisible=!1},x([Object(s.f)("searchValue",{immediate:!0,deep:!0})],e.prototype,"onSearchValueChanged",null),x([Object(s.f)("manualAddIp",{immediate:!0,deep:!0})],e.prototype,"onManualAddIpChanged",null),x([Object(s.f)("currentTab",{immediate:!0,deep:!0})],e.prototype,"onCurrentTabChanged",null),e=x([Object(s.a)({name:"add-server"})],e)}(s.e),L=T,P=Object(d.a)(L,(function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",[i("bk-dialog",{attrs:{width:1e3,title:"添加服务器","ext-cls":"add-server-dialog","mask-close":!1,"show-mask":!0,draggable:!0,"auto-close":!1,"header-position":"left",loading:t.isConfirm},model:{value:t.addServerVisible,callback:function(e){t.addServerVisible=e},expression:"addServerVisible"}},[i("div",{staticClass:"content-wrapper"},[i("bk-radio-group",{staticStyle:{"margin-bottom":"20px"},on:{change:t.changeTab},model:{value:t.currentTab,callback:function(e){t.currentTab=e},expression:"currentTab"}},[i("bk-radio-button",{attrs:{value:"list"}},[t._v("\n                    列表选择\n                ")]),t._v(" "),i("bk-radio-button",{attrs:{value:"manual"}},[t._v("\n                    手动输入\n                ")])],1),t._v(" "),"list"===t.currentTab?i("div",{staticClass:"list-tip"},[i("bk-icon",{staticStyle:{"font-size":"14px"},attrs:{type:"exclamation-circle"}}),t._v(" "),i("span",[t._v("暂不支持指定多业务搜索，请进行全量搜索或单业务搜索")])],1):t._e(),t._v(" "),i("div",{staticClass:"content-box"},[i("div",{staticClass:"left-box"},[i("div",{directives:[{name:"show",rawName:"v-show",value:"list"===t.currentTab,expression:"currentTab === 'list'"},{name:"bkloading",rawName:"v-bkloading",value:{isLoading:t.loading||t.selectLoading,zIndex:10},expression:"{ isLoading: loading || selectLoading, zIndex: 10 }"}],staticStyle:{height:"100%"}},[i("div",{staticClass:"left-box-header"},[i("div",[i("bk-select",{staticStyle:{width:"220px","margin-bottom":"20px",color:"#C4C6CC"},attrs:{disabled:!1,loading:t.selectLoading,multiple:"",searchable:"",clearable:"","display-tag":"","ext-cls":"select-custom",placeholder:"全部业务","ext-popover-cls":"select-popover-custom"},on:{clear:t.getBusinessTopoList,change:t.getBusinessTopoList},model:{value:t.businessType,callback:function(e){t.businessType=e},expression:"businessType"}},t._l(t.businessTypeList,(function(t){return i("bk-option",{key:t.bk_biz_id,attrs:{id:t.bk_biz_id,disabled:t.disabled,name:t.bk_biz_name}})})),1)],1),t._v(" "),i("div",[t.isTopoShow?i("bk-cascade",{staticStyle:{width:"220px",color:"#C4C6CC"},attrs:{loading:t.cascadeLoading,disabled:1!==t.businessType.length,list:t.businessTopoList,placeholder:"业务拓扑","check-any-level":!0,clearable:""},on:{change:t.conditionSearch},model:{value:t.businessTopo,callback:function(e){t.businessTopo=e},expression:"businessTopo"}}):t._e()],1),t._v(" "),i("div",[i("bk-input",{staticStyle:{width:"236px","margin-bottom":"20px","font-size":"12px",color:"#C4C6CC"},attrs:{disabled:t.businessType.length>1,placeholder:"请输入内网IP/操作系统名称",clearable:"","show-word-limit":!0,"right-icon":"bk-icon icon-search"},on:{"right-icon-click":t.conditionSearch,enter:t.conditionSearch,clear:t.conditionSearch},model:{value:t.searchValue,callback:function(e){t.searchValue=e},expression:"searchValue"}})],1)]),t._v(" "),i("div",{staticClass:"table-box"},[i("bk-table",{ref:"targetTable",staticClass:"add-server-table",attrs:{"max-height":"358",data:t.serverList,pagination:t.pagination},on:{"filter-change":t.filterChange,select:t.selectionChange,"select-all":t.selectTargetAll,"page-change":t.handlePageChange,"page-limit-change":t.handlePageLimitChange}},[i("template",{slot:"empty"},[i("bk-exception",{staticClass:"exception-wrap-item exception-part",class:{"exception-gray":!1},attrs:{type:"empty",scene:"part"}},[i("span",{staticStyle:{"font-size":"12px",color:"#63656E"}},[t._v("暂无数据")])])],1),t._v(" "),i("bk-table-column",{attrs:{type:"selection",width:"40",selectable:function(t){return"正常"===t.status_display}}}),t._v(" "),i("bk-table-column",{attrs:{label:"内网IP",prop:"inner_ip","min-width":"140px","show-overflow-tooltip":{interactive:!1}}}),t._v(" "),i("bk-table-column",{attrs:{label:"主机名称",prop:"bk_host_name","min-width":"140px","show-overflow-tooltip":{interactive:!1}},scopedSlots:t._u([{key:"default",fn:function(e){return[t._v("\n                                        "+t._s(e.row.bk_host_name||"--")+"\n                                    ")]}}])}),t._v("R\n                                "),i("bk-table-column",{attrs:{label:"业务名称",prop:"bk_biz_name","min-width":"95px","show-overflow-tooltip":{interactive:!1}}}),t._v(" "),i("bk-table-column",{attrs:{"show-overflow-tooltip":{interactive:!1},label:"操作系统名称",prop:"os_type_name","min-width":"200px"}}),t._v(" "),i("bk-table-column",{attrs:{label:"代理状态",width:"100",prop:"status"},scopedSlots:t._u([{key:"default",fn:function(e){return[i("div",{staticClass:"health-value-circle"},[i("div",{staticClass:"circle-inter",style:{backgroundColor:t.statusColorInter[e.row.status_display]}}),t._v(" "),i("div",{staticClass:"circle-outer",style:{backgroundColor:t.statusColorOuter[e.row.status_display]}})]),t._v("\n                                        "+t._s(e.row.status_display)+"\n                                    ")]}}])})],2)],1)]),t._v(" "),i("div",{directives:[{name:"show",rawName:"v-show",value:"manual"===t.currentTab,expression:"currentTab === 'manual'"},{name:"bkloading",rawName:"v-bkloading",value:{isLoading:t.manualLoading,zIndex:10},expression:"{ isLoading: manualLoading, zIndex: 10 }"}],class:["manual-add",t.errorIp&&"manual-add-error"]},[i("bk-input",{staticStyle:{flex:"1"},attrs:{placeholder:"请输入IP地址，请带云区域并用冒号分隔，如“0:192.168.1.101”，若不加云区域，则默认为直连区域【0】，多IP可采用换行进行分隔",type:"textarea",clearable:""},model:{value:t.manualAddIp,callback:function(e){t.manualAddIp=e},expression:"manualAddIp"}}),t._v(" "),i("div",{staticClass:"add-selected",on:{click:t.addIpSelected}},[t._v("\n                            添加到已选择\n                        ")])],1)]),t._v(" "),i("div",{staticClass:"right-box"},[i("div",{staticClass:"title"},[t._v("结果预览")]),t._v(" "),i("div",{staticClass:"info-box"},[i("div",[i("span",[t._v("已选")]),t._v(" "),i("span",{staticStyle:{color:"#3A84FF","font-weight":"bold"}},[t._v(t._s(t.selectedServer.length))]),t._v(" "),i("span",[t._v("台服务器")])]),t._v(" "),i("span",{staticClass:"clear",on:{click:function(e){return t.deleteSelected("all")}}},[t._v("清空")])]),t._v(" "),i("div",{staticClass:"list"},t._l(t.selectedServer,(function(e,a){return i("div",{key:a},[i("div",{class:["list-item",a!==t.selectedServer.length-1&&"list-item-border-bottom"]},[i("span",{staticStyle:{"font-size":"12px"}},[t._v(t._s(e.inner_ip))]),t._v(" "),i("bk-icon",{staticStyle:{"font-size":"16px",color:"#63656E",cursor:"pointer"},attrs:{type:"close"},on:{click:function(e){return t.deleteSelected(a)}}})],1)])})),0)])])],1),t._v(" "),i("template",{slot:"footer"},[i("bk-button",{attrs:{theme:"primary"},on:{click:t.addServer}},[t._v("确定")]),t._v(" "),i("bk-button",{attrs:{theme:"default"},on:{click:t.cancelAdd}},[t._v("取消")])],1)],2)],1)}),[],!1,null,"9b869714",null).exports,F=i("aaBP"),I=i.n(F),$=function(){var t=function(e,i){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])},t(e,i)};return function(e,i){if("function"!=typeof i&&null!==i)throw new TypeError("Class extends value "+String(i)+" is not a constructor or null");function a(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(a.prototype=i.prototype,new a)}}(),O=function(t,e,i,a){var n,s=arguments.length,o=s<3?e:null===a?a=Object.getOwnPropertyDescriptor(e,i):a;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(t,e,i,a);else for(var r=t.length-1;r>=0;r--)(n=t[r])&&(o=(s<3?n(o):s>3?n(e,i,o):n(e,i))||o);return s>3&&o&&Object.defineProperty(e,i,o),o},E=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.columns=[{label:"",key:"radio",align:"left",width:"48px",scopedSlots:"radio"},{label:"文件名称",key:"name",align:"left",minWidth:"250px"},{label:"上传时间",key:"created_at",align:"left",width:"150px",minWidth:"120px"},{label:"过期时间",key:"expired_at",align:"left",width:"150px",minWidth:"120px"},{label:"文件大小",key:"file_size",align:"left",width:"95px"},{label:"操作",key:"operation",width:"65px",scopedSlots:"operation"}],e.addPatchVisible=!1,e.tableLoading=!1,e.tableLoadingText="",e.patchList=[],e.pagination={current:1,count:1,limit:10},e.patchName="",e.statusTextMap={success:"上传成功",error:"上传出错了",uploading:"上传中...",paused:"暂停",waiting:"等待中...",cmd5:"正在计算文件大小，请稍候"},e.fileStatusText=function(t,i){return e.statusTextMap[t]},e.relTaskVisible=!1,e.fileSummaryLoading=!1,e.relTask=[],e.deleteRow={},e.summaryInfo={expired_set:"0天",one_set:0,all_size:0,used_size:0},e.uploadFileList=[],e.selectPatch="",e.contentLoading=!1,e.errorUploadFlag=!1,e.file={},e.uploadFile="",e.process=0,e.isPauseCmd5=!0,e.disabledUpload=!1,e.fileEventValue="",e.checkChunkError=!1,e.isNeedUploadTip=!0,e.options={target:window.siteUrl+"/patch_mgmt/upload_temp/",chunkSize:10485760,simultaneousUploads:5,headers:{},maxChunkRetries:2,parseTimeRemaining:function(t,e){return e.replace(/\syears?/,"年").replace(/\days?/,"天").replace(/\shours?/,"小时").replace(/\sminutes?/,"分钟").replace(/\sseconds?/,"秒")},testChunks:!0,checkChunkUploadedByResponse:function(t,i){var a=JSON.parse(i);return a.result?e.errorUploadFlag=!1:e.errorUploadFlag||(e.errorUploadFlag=!0,e.checkChunkError=!0,e.$warn(a.message),e.file.cancel(),e.fileEventValue="",e.$api.patchInstall.cancelUploadFile({md5:e.file.uniqueIdentifier})),a.isExist?(e.statusTextMap.success="秒传文件",!0):(a.uploaded||[]).indexOf(t.offset+1)>=0}},e}return $(e,t),e.prototype.getPatchFile=function(){var t=this;this.tableLoading=!0;var e={name:this.patchName,page:this.pagination.current,page_size:this.pagination.limit};this.$api.patchInstall.getPatchFile(e).then((function(e){if(!e.result)return!1;t.patchList=e.data.items,t.pagination.count=e.data.count})).finally((function(){t.tableLoading=!1}))},e.prototype.getFileSummary=function(){var t=this;this.disabledUpload=!0,this.$api.patchInstall.getFileSummary().then((function(e){if(!e.result)return!1;t.summaryInfo=e.data,t.summaryInfo.used_size>t.summaryInfo.all_size?(t.$warn("服务器文件列表超过10G，无法上传，请手动删除后再次上传!"),t.disabledUpload=!0):t.disabledUpload=!1})).finally((function(){t.disabledUpload=!1}))},e.prototype.disabledRadio=function(t){return"Windows"===this.osType?!t.toLowerCase().endsWith(".msu"):!t.toLowerCase().endsWith(".tar.gz")},e.prototype.changeFile=function(t){this.errorUploadFlag=!1,this.checkChunkError=!1,this.isPauseCmd5=!0,t.target.value===this.fileEventValue&&this.onFileAdded(this.file)},e.prototype.onFileAdded=function(t){var e=this.$refs.uploader;return this.fileEventValue=e.$el.children[0].children[0].children[0].value,this.file=t,this.uploadFile=t,/^[0-9a-zA-Z_().-]{1,}$/.test(t.name)?"Windows"!==this.osType||t.name.toLowerCase().endsWith(".msu")?"Linux"!==this.osType||t.name.toLowerCase().endsWith(".tar.gz")?t.size>1073741824*Number(this.summaryInfo.one_set.toFixed(2))?(this.$warn("当前上传文件大小超出单文件限制大小，请重新选择文件上传!"),!1):t.size>1073741824*Number((this.summaryInfo.all_size-this.summaryInfo.used_size).toFixed(2))?(this.$warn("服务器文件列表超过10G，无法上传，请手动删除后再次上传!"),!1):void this.computeMD5(this.file):(this.$warn("当前只支持上传tar.gz格式文件，请重新选择文件上传!"),!1):(this.$warn("当前只支持上传.msu格式文件，请重新选择文件上传!"),!1):(this.$warn("补丁文件名只支持数字字母下划线短横线小括号!"),!1)},e.prototype.computeMD5=function(t){var e=this;this.contentLoading=!0,this.tableLoadingText=this.statusTextMap.cmd5;var i=File.prototype.slice||File.prototype.mozSlice||File.prototype.webkitSlice,a=5242880,n=Math.ceil(t.size/a),s=0,o=new I.a.ArrayBuffer,r=new FileReader,l=(new Date).getTime();t.cmd5=!0,r.onload=function(i){if(o.append(i.target.result),++s<n){var a=Math.floor(s/n*100);t.cmd5progress=a,c()}else{var r=o.end();console.log("MD5计算完成：".concat(t.name," \nMD5：").concat(r," \n分片：").concat(n," 大小:").concat(t.size," 用时：").concat((new Date).getTime()-l," ms")),e.contentLoading=!1,e.tableLoadingText="",o.destroy(),t.uniqueIdentifier=r,t.cmd5=!1,e.isPauseCmd5&&t.resume()}},r.onerror=function(){console.warn("oops, something went wrong."),t.cancel(),e.fileEventValue="",e.$api.patchInstall.cancelUploadFile({md5:t.uniqueIdentifier}),e.$error("上传失败!"),e.$emit("uploadPatchFile",{errorUploadFlag:!0})};var c=function(){var e=s*a,n=e+a>=t.size?t.size:e+a;r.readAsArrayBuffer(i.call(t.file,e,n))};c()},e.prototype.onFileProgress=function(t,e,i){this.file&&(this.process=Number(this.file.progress().toFixed(2)),0===this.process||this.errorUploadFlag||(this.addPatchVisible=!1),1===this.process&&(this.process=.99),this.$emit("uploadPatchFile",{file:this.file,process:this.process,errorUploadFlag:this.errorUploadFlag}),this.checkChunkError||(this.addPatchVisible=!1))},e.prototype.setNeedUploadTip=function(){this.isNeedUploadTip=!1},e.prototype.cancelUpload=function(){this.errorUploadFlag=!0},e.prototype.onFileSuccess=function(t,e,i,a){var n=this,s=JSON.parse(i);if(0===s.code&&!0===s.merge){var o={filename:e.name,identifier:e.uniqueIdentifier};this.$api.patchInstall.mergeFiles(o).then((function(t){n.isNeedUploadTip&&(t.result?(n.$success("上传成功!"),n.process=1,n.fileEventValue=""):n.$error("上传失败!"),n.$emit("uploadPatchFile",{file:n.file,fileId:t.file_id,process:n.process,errorUploadFlag:!t.result}))})).finally((function(){n.errorUploadFlag=!1,n.isNeedUploadTip=!0}))}},e.prototype.onFileError=function(t,e,i,a){console.log("Error:",i)},e.prototype.show=function(t){this.errorUploadFlag=!1,this.checkChunkError=!1,this.addPatchVisible=!0,this.isPauseCmd5=!0,this.selectPatch=t,this.pagination={current:1,count:1,limit:10},this.getPatchFile(),this.getFileSummary()},e.prototype.addServer=function(){var t=this;if(!this.selectPatch)return this.$warn("请选择想要关联的补丁文件或选择本地上传!"),!1;var e=this.patchList.find((function(e){return e.id===t.selectPatch}));this.$emit("sendPatchFile",e||""),this.isPauseCmd5=!1,this.addPatchVisible=!1},e.prototype.cancelAdd=function(){this.isPauseCmd5=!1,this.addPatchVisible=!1},e.prototype.handlePageChange=function(t){this.pagination.current=t,this.getPatchFile()},e.prototype.handlePageLimitChange=function(t){this.pagination.current=1,this.pagination.limit=t,this.getPatchFile()},e.prototype.searchPatch=function(){this.pagination.current=1,this.getPatchFile()},e.prototype.toDelete=function(t){var e=this;this.relTaskVisible=!0,this.deleteRow=t,this.contentLoading=!0,this.$api.patchInstall.getPatchFileRelTask({id:t.id}).then((function(t){if(!t.result)return!1;e.relTask=t.data})).finally((function(){e.contentLoading=!1}))},e.prototype.confirmDelete=function(){var t=this;this.$api.patchInstall.deletePatchFile({id:this.deleteRow.id}).then((function(e){if(!e.result)return t.$error(e.message),!1;t.$emit("deletePatchFile",t.deleteRow),t.$success("成功删除补丁文件!"),1!==t.pagination.current&&1===t.patchList.length&&(t.pagination.current=t.pagination.current-1),t.getPatchFile(),t.getFileSummary()})).finally((function(){t.relTaskVisible=!1}))},O([Object(s.d)({type:String,default:""})],e.prototype,"osType",void 0),O([Object(s.d)({type:String,default:""})],e.prototype,"patchFileId",void 0),e=O([Object(s.a)({name:"add-patch",components:{comTable:n.a}})],e)}(s.e),j=E,N=Object(d.a)(j,(function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",[i("bk-dialog",{attrs:{"ext-cls":"add-patch-dialog",width:1e3,title:"添加补丁文件","mask-close":!1,"show-mask":!0,draggable:!0,"auto-close":!1,"header-position":"left"},model:{value:t.addPatchVisible,callback:function(e){t.addPatchVisible=e},expression:"addPatchVisible"}},[i("div",{directives:[{name:"bkloading",rawName:"v-bkloading",value:{isLoading:t.contentLoading,zIndex:10,title:t.tableLoadingText},expression:"{ isLoading: contentLoading, zIndex: 10, title: tableLoadingText }"}],staticClass:"content-wrapper"},[i("div",{staticClass:"box-header"},[i("div",{staticStyle:{position:"relative"}},[t.fileSummaryLoading||t.disabledUpload?i("div",{staticClass:"disabled-btn"}):t._e(),t._v(" "),i("uploader",{ref:"uploader",staticClass:"uploader-custom",attrs:{options:t.options,"file-status-text":t.fileStatusText,"auto-start":!1},on:{change:t.changeFile,"file-added":t.onFileAdded,"file-progress":t.onFileProgress,"file-success":t.onFileSuccess,"file-error":t.onFileError}},[i("uploader-drop",[i("uploader-btn",{staticClass:"upfile"},[t._v("本地上传")])],1)],1)],1),t._v(" "),i("bk-input",{staticStyle:{width:"240px"},attrs:{placeholder:"请输入文件名称",clearable:!0,"right-icon":"bk-icon icon-search"},on:{enter:t.searchPatch,"right-icon-click":t.searchPatch,clear:t.searchPatch},model:{value:t.patchName,callback:function(e){t.patchName=e},expression:"patchName"}})],1),t._v(" "),i("div",[i("bk-radio-group",{model:{value:t.selectPatch,callback:function(e){t.selectPatch=e},expression:"selectPatch"}},[i("com-table",{directives:[{name:"bkloading",rawName:"v-bkloading",value:{isLoading:t.tableLoading,zIndex:10},expression:"{ isLoading: tableLoading, zIndex: 10 }"}],ref:"targetTable",staticClass:"add-server-table",attrs:{data:t.patchList,columns:t.columns,"max-height":"300",pagination:t.pagination},on:{"page-change":t.handlePageChange,"page-limit-change":t.handlePageLimitChange},scopedSlots:t._u([{key:"radio",fn:function(e){var a=e.row;return[i("bk-radio",{attrs:{value:a.id,disabled:t.disabledRadio(a.name)}})]}},{key:"operation",fn:function(e){var a=e.row;return[i("bk-button",{staticClass:"mr10",attrs:{theme:"primary",text:""},on:{click:function(e){return t.toDelete(a)}}},[t._v("删除")])]}}])})],1),t._v(" "),i("div",{staticClass:"summary-info"},[i("div",[i("span",[t._v("单文件限制:")]),t._v(" "),i("span",[t._v(t._s(t.summaryInfo.one_set.toFixed(2)+"G"))])]),t._v(" "),i("div",[i("span",[t._v("存放期:")]),t._v(" "),i("span",[t._v(t._s(t.summaryInfo.expired_set))])]),t._v(" "),i("div",[i("span",[t._v("使用量:")]),t._v(" "),i("span",[t._v(t._s(t.summaryInfo.used_size.toFixed(2)+"G/"+t.summaryInfo.all_size.toFixed(2)+"G"))])])])],1)]),t._v(" "),i("template",{slot:"footer"},[i("bk-button",{attrs:{disabled:t.contentLoading,theme:"primary"},on:{click:t.addServer}},[t._v("确定")]),t._v(" "),i("bk-button",{attrs:{theme:"default"},on:{click:t.cancelAdd}},[t._v("取消")])],1)],2),t._v(" "),i("bk-dialog",{attrs:{theme:"primary",width:"480","mask-close":!1,"header-position":"left","show-mask":!0,draggable:!0,"auto-close":!1,title:"删除提示"},on:{confirm:t.confirmDelete},model:{value:t.relTaskVisible,callback:function(e){t.relTaskVisible=e},expression:"relTaskVisible"}},[i("div",{staticClass:"rel-task-box"},[i("bk-alert",{attrs:{type:"warning",title:"删除补丁文件将导致关联任务失效，请谨慎删除。"}}),t._v(" "),t.relTask&&t.relTask.length>0?i("div",{staticClass:"title",staticStyle:{"margin-top":"20px"}},[t._v("该补丁文关联任务如下：")]):t._e(),t._v(" "),t._l(t.relTask,(function(e,a){return i("div",{key:a,staticClass:"content-item"},[i("div",{staticClass:"content-box"},[e.is_set?i("bk-icon",{directives:[{name:"bk-tooltips",rawName:"v-bk-tooltips.top",value:"已设置定时执行",expression:"'已设置定时执行'",modifiers:{top:!0}}],staticClass:"icon top-middle",attrs:{type:"exclamation-circle"}}):t._e(),t._v(" "),i("div",{directives:[{name:"bk-overflow-tips",rawName:"v-bk-overflow-tips"}],staticClass:"value hideText"},[t._v(t._s(e.name))])],1)])}))],2)])],1)}),[],!1,null,"5145603c",null).exports,A=function(){var t=function(e,i){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])},t(e,i)};return function(e,i){if("function"!=typeof i&&null!==i)throw new TypeError("Class extends value "+String(i)+" is not a constructor or null");function a(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(a.prototype=i.prototype,new a)}}(),z=function(t,e,i,a){var n,s=arguments.length,o=s<3?e:null===a?a=Object.getOwnPropertyDescriptor(e,i):a;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(t,e,i,a);else for(var r=t.length-1;r>=0;r--)(n=t[r])&&(o=(s<3?n(o):s>3?n(e,i,o):n(e,i))||o);return s>3&&o&&Object.defineProperty(e,i,o),o},V=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.columns=[{label:"内网IP",key:"inner_ip",align:"left",minWidth:"140px"},{label:"主机名称",key:"bk_host_name",align:"left",minWidth:"140px"},{label:"业务名称",key:"bk_biz_name",align:"left",minWidth:"95px"},{label:"操作系统名称",key:"os_type_name",align:"left",minWidth:"195px"},{label:"代理状态",key:"status",align:"left",width:"100px",scopedSlots:"status"},{label:"操作",key:"operation",width:"65px",fixed:"right",scopedSlots:"operation"}],e.statusColorInter={"正常":"#3FC06D","异常":"#EA3636","未安装":"#C4C6CC"},e.statusColorOuter={"正常":"#E5F6EA","异常":"#FFE6E6","未安装":"#F0F1F5"},e}return A(e,t),e.prototype.pageChange=function(t){this.$emit("pageChange",t)},e.prototype.limitChange=function(t){this.$emit("limitChange",t)},e.prototype.toDelete=function(t){this.$emit("toDelete",t)},z([Object(s.d)({type:Array,default:function(){return[]}})],e.prototype,"serverList",void 0),z([Object(s.d)({type:Object,default:{current:1,count:1,limit:10}})],e.prototype,"selectedPagination",void 0),e=z([Object(s.a)({name:"server-list-table",components:{comTable:n.a}})],e)}(s.e),R=V,U=Object(d.a)(R,(function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",[i("com-table",{staticClass:"show-server-table",attrs:{"max-height":"528",data:t.serverList.slice((t.selectedPagination.current-1)*t.selectedPagination.limit,t.selectedPagination.current*t.selectedPagination.limit),columns:t.columns,pagination:t.selectedPagination},on:{"page-change":t.pageChange,"page-limit-change":t.limitChange},scopedSlots:t._u([{key:"status",fn:function(e){var a=e.row;return[i("div",{staticClass:"health-value-circle"},[i("div",{staticClass:"circleInter",style:{backgroundColor:t.statusColorInter[a.status_display]}}),t._v(" "),i("div",{staticClass:"circleOuter",style:{backgroundColor:t.statusColorOuter[a.status_display]}})]),t._v("\n            "+t._s(a.status_display)+"\n        ")]}},{key:"operation",fn:function(e){var a=e.index;return[i("bk-button",{staticClass:"mr10",attrs:{theme:"primary",text:""},on:{click:function(e){return t.toDelete(a)}}},[t._v("删除")])]}}])})],1)}),[],!1,null,null,null).exports,W=function(){var t=function(e,i){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])},t(e,i)};return function(e,i){if("function"!=typeof i&&null!==i)throw new TypeError("Class extends value "+String(i)+" is not a constructor or null");function a(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(a.prototype=i.prototype,new a)}}(),M=function(t,e,i,a){var n,s=arguments.length,o=s<3?e:null===a?a=Object.getOwnPropertyDescriptor(e,i):a;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(t,e,i,a);else for(var r=t.length-1;r>=0;r--)(n=t[r])&&(o=(s<3?n(o):s>3?n(e,i,o):n(e,i))||o);return s>3&&o&&Object.defineProperty(e,i,o),o},B=function(t,e,i,a){return new(i||(i=Promise))((function(n,s){function o(t){try{l(a.next(t))}catch(t){s(t)}}function r(t){try{l(a.throw(t))}catch(t){s(t)}}function l(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(o,r)}l((a=a.apply(t,e||[])).next())}))},q=function(t,e){var i,a,n,s,o={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]};return s={next:r(0),throw:r(1),return:r(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function r(s){return function(r){return function(s){if(i)throw new TypeError("Generator is already executing.");for(;o;)try{if(i=1,a&&(n=2&s[0]?a.return:s[0]?a.throw||((n=a.return)&&n.call(a),0):a.next)&&!(n=n.call(a,s[1])).done)return n;switch(a=0,n&&(s=[2&s[0],n.value]),s[0]){case 0:case 1:n=s;break;case 4:return o.label++,{value:s[1],done:!1};case 5:o.label++,a=s[1],s=[0];continue;case 7:s=o.ops.pop(),o.trys.pop();continue;default:if(!(n=o.trys,(n=n.length>0&&n[n.length-1])||6!==s[0]&&2!==s[0])){o=0;continue}if(3===s[0]&&(!n||s[1]>n[0]&&s[1]<n[3])){o.label=s[1];break}if(6===s[0]&&o.label<n[1]){o.label=n[1],n=s;break}if(n&&o.label<n[2]){o.label=n[2],o.ops.push(s);break}n[2]&&o.ops.pop(),o.trys.pop();continue}s=e.call(t,o)}catch(t){s=[6,t],a=0}finally{i=n=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,r])}}},G=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.formData={id:"",taskName:"",osType:"Windows",serverList:[],patchFile:"",patchFileId:"",filePath:"C:\\tmp",isNotice:!1,noticeName:[],email:[],speedLimit:10,isOpenSpeedLimit:!1},e.htmlConfig={allowHtml:!0,width:400,trigger:"mouseenter",theme:"light",extCls:"speed-limit-cls",content:"#speed-limit-tip",placement:"bottom-end"},e.rules={taskName:[{required:!0,message:"请输入任务名称",trigger:"blur"}],filePath:[{required:!0,message:"请输入目标路径",trigger:"blur"}],noticeName:[{validator:function(t){return!(this.formData.email.length>0)&&0!==t.length},message:"请选择用户",trigger:"blur"}],email:[{validator:function(t){return!(this.formData.noticeName.length>0)&&0!==t.length},message:"请输入邮箱",trigger:"blur"}],serverList:[{validator:function(t){return 0!==t.length},message:"请添加服务器",trigger:"blur"}],patchFile:[{validator:function(t){return t},message:"请添加补丁文件",trigger:"blur"}]},e.hasYScroll=!1,e.selectedPagination={current:1,count:1,limit:10},e.isShow=!0,e.uploadFile="",e.process=0,e.maintainerList=[],e.selectLoading=!1,e.isAddTag=!1,e.emailTag="",e.isSuccessEmail=!0,e.pageLoading=!1,e.taskInfo="",e.visible=!1,e.titleMap={add:"新建任务",edit:"编辑任务",clone:"克隆任务"},e.type="",e.formDataV2={},e}return W(e,t),Object.defineProperty(e.prototype,"disabledOsType",{get:function(){return!(!this.formData.patchFile||1===this.process)},enumerable:!1,configurable:!0}),e.prototype.updated=function(){this.getScrollStatus()},e.prototype.beforeDestroy=function(){(1!==this.process&&.99!==this.process&&this.uploadFile&&(this.uploadFile.cancel(),this.$api.patchInstall.cancelUploadFile({md5:this.uploadFile.uniqueIdentifier})),.99===this.process)&&this.$refs.addPatch.setNeedUploadTip()},e.prototype.show=function(t,e){Object.assign(this.$data,this.$options.data.call(this)),this.visible=!0,this.type=t,this.getScrollStatus(),this.getMaintainer(),["edit","clone"].includes(this.type)&&(this.taskInfo=e,this.formData.id=this.taskInfo.id,this.formData.taskName=this.taskInfo.name||"",this.formData.osType=this.taskInfo.os_type||"",this.formData.serverList=this.taskInfo.server_list||[],this.formData.patchFileId=this.taskInfo.patch_file_id||0,this.formData.speedLimit=this.taskInfo.speed_limit,this.formData.isOpenSpeedLimit=this.taskInfo.open_speed_limit,0===this.formData.patchFileId?(this.$warn("原补丁文件已经被删除，请重新本地上传"),this.formData.patchFile="",this.formData.patchFileId=""):this.formData.patchFile=this.taskInfo.patch_file_name||"",this.formData.filePath=this.taskInfo.file_path||"",this.formData.isNotice=this.taskInfo.mail_notify,this.formData.email=this.taskInfo.custom_mails||[],this.process=1),this.formDataV2=this.$deepClone(this.formData)},e.prototype.tagInputBlur=function(t){if(!t)return!1;this.isSuccessEmail=/^([a-zA-Z]|[0-9])(\w|\-)+@[a-zA-Z0-9]+\.([a-zA-Z]{2,4})$/.test(t),this.isSuccessEmail&&this.formData.email.push(t)},e.prototype.addTag=function(){this.isAddTag=!this.isAddTag},e.prototype.validateEmail=function(t){var e=/^([a-zA-Z]|[0-9])(\w|\-)+@[a-zA-Z0-9]+\.([a-zA-Z]{2,4})$/;return this.isSuccessEmail=e.test(t),e.test(t)},e.prototype.closeTag=function(t){var e=this.formData.email.findIndex((function(e){return e===t}));this.formData.email.splice(e,1)},e.prototype.getMaintainer=function(){return B(this,void 0,void 0,(function(){var t;return q(this,(function(e){switch(e.label){case 0:return this.selectLoading=!0,[4,this.$api.patchInstall.getMaintainer()];case 1:return t=e.sent(),this.selectLoading=!1,t.result?(this.maintainerList=t.data.map((function(t){return{id:t.id,idKey:JSON.stringify(t),displayName:t.chname||t.bk_username}})),["edit","clone"].includes(this.type)&&(this.formData.noticeName=this.taskInfo.mail_list),[2]):[2,this.$error(t.message)]}}))}))},e.prototype.deletePatchFile=function(t){this.formData.patchFile===t.name&&(this.formData.patchFile="",this.formData.patchFileId="")},e.prototype.uploadPatchFile=function(t){if(t.errorUploadFlag)return this.formData.patchFile="",this.formData.patchFileId="",!1;this.uploadFile=t.file,this.formData.patchFile=this.uploadFile.name||"",t.fileId&&(this.formData.patchFileId=t.fileId),this.process=t.process},e.prototype.deleteLoadPatch=function(){var t=this;this.$bkInfo({title:"是否删除该关联补丁文件？",confirmLoading:!0,confirmFn:function(){t.formData.patchFile="",t.formData.patchFileId="";var e=t.$refs.addPatch;1!==t.process&&.99!==t.process&&(t.uploadFile.cancel(),t.$api.patchInstall.cancelUploadFile({md5:t.uploadFile.uniqueIdentifier}),e.cancelUpload()),.99===t.process&&e.setNeedUploadTip()},cancelFn:function(){}})},e.prototype.getPatchFile=function(t){this.formData.patchFile&&this.$success("补丁文件替换成功!"),this.formData.patchFileId=t.id,this.formData.patchFile=t.name||"",this.process=1},e.prototype.addPatchFile=function(){if(this.disabledOsType)return!1;this.$refs.addPatch.show(this.formData.patchFileId)},e.prototype.onChange=function(t){var e=this;this.formData.serverList.length>0||this.formData.patchFile?this.$bkInfo({extCls:"warning-tip",confirmLoading:!0,title:"确认切换操作系统？",subTitle:"切换后已选服务器和上传的补丁文件将清空",confirmFn:function(){try{e.formData.serverList=[],e.formData.filePath="Windows"===e.formData.osType?"C:\\tmp":"/tmp";var t=e.$refs.addPatch;1!==e.process&&.99!==e.process&&e.uploadFile&&(e.uploadFile.cancel(),e.$api.patchInstall.cancelUploadFile({md5:e.uploadFile.uniqueIdentifier}),t.cancelUpload()),.99===e.process&&t.setNeedUploadTip(),e.formData.patchFile="",e.formData.patchFileId=""}catch(t){return!1}},cancelFn:function(){e.formData.osType="Windows"===t?"Linux":"Windows",e.isShow=!1,e.$nextTick((function(){e.isShow=!0}))}}):this.formData.filePath="Windows"===this.formData.osType?"C:\\tmp":"/tmp"},e.prototype.pageChange=function(t){this.selectedPagination.current=t},e.prototype.limitChange=function(t){this.selectedPagination.limit=t,this.selectedPagination.current=1},e.prototype.toDelete=function(t){this.formData.serverList.splice(t,1),this.selectedPagination.count=this.formData.serverList.length,this.selectedPagination.count>0&&this.selectedPagination.count===(this.selectedPagination.current-1)*this.selectedPagination.limit&&this.selectedPagination.current--},e.prototype.getServerList=function(t){this.formData.serverList=t,this.selectedPagination.count=this.formData.serverList.length},e.prototype.getScrollStatus=function(){var t=this;this.$nextTick((function(){var e=document.getElementById("taskForm");e&&(t.hasYScroll=e.scrollHeight>(e.innerHeight||e.clientHeight))}))},e.prototype.toAddServer=function(){this.$refs.addServer.show(this.formData,this.formData.serverList)},e.prototype.createTask=function(){var t=this;this.pageLoading=!0,this.isSuccessEmail=!0,this.$refs.validateForm.validate().then((function(){if("clone"===t.type&&t.formData.taskName===t.taskInfo.name)return t.$warn("任务名称重复，请修改任务名称"),!1;var e={name:t.formData.taskName,os_type:t.formData.osType,server_list:t.formData.serverList,patch_file_name:t.formData.patchFile,patch_file_id:t.formData.patchFileId,file_path:t.formData.filePath,mail_list:t.formData.noticeName,custom_mails:t.formData.email,open_speed_limit:t.formData.isOpenSpeedLimit,speed_limit:t.formData.speedLimit},i="",a="";"add"===t.type?(i="createPatchTask",a="新增"):"edit"===t.type?(i="modifyPatchTask",a="修改"):(i="createPatchTask",a="克隆"),t.$api.patchInstall[i](e,t.formData.id).then((function(e){if(!e.result)return t.$error("".concat(a,"任务失败,")+e.message),!1;t.$success("".concat(a,"任务成功!")),t.visible=!1,t.$emit("refreshList")}))})).finally((function(){t.pageLoading=!1}))},e.prototype.handleCloseFile=function(){(1!==this.process&&.99!==this.process&&this.uploadFile&&(this.uploadFile.cancel(),this.$api.patchInstall.cancelUploadFile({md5:this.uploadFile.uniqueIdentifier})),.99===this.process)&&this.$refs.addPatch.setNeedUploadTip()},e.prototype.cancel=function(){var t=this;this.$compareFormData(this.formData,this.formDataV2)?(this.handleCloseFile(),Object.assign(this.$data,this.$options.data.call(this))):this.$bkInfo({extCls:"warning-tip",confirmLoading:!0,title:"确认离开当前页？",subTitle:"离开将会导致未保存信息丢失",confirmFn:function(){t.handleCloseFile(),Object.assign(t.$data,t.$options.data.call(t))},cancelFn:function(){return!1}})},e=M([Object(s.a)({name:"task-panel",components:{addServer:P,addPatch:N,serverListTable:U}})],e)}(s.e),H=G,J=Object(d.a)(H,(function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",[i("bk-sideslider",{attrs:{"is-show":t.visible,"quick-close":!0,title:t.titleMap[t.type],width:800,"before-close":t.cancel},on:{"update:isShow":function(e){t.visible=e},"update:is-show":function(e){t.visible=e}}},[i("div",{staticClass:"content-box",attrs:{slot:"content"},slot:"content"},[i("div",{staticClass:"main-box"},[i("bk-form",{ref:"validateForm",staticStyle:{flex:"1",overflow:"auto"},attrs:{"label-width":98,model:t.formData,rules:t.rules,id:"taskForm"}},[i("div",{staticClass:"task-main"},[i("div",{staticClass:"base-info form-box"},[i("div",{staticClass:"title"},[t._v("基本信息")]),t._v(" "),i("bk-form-item",{attrs:{"error-display-type":"normal",label:"任务名称",required:"",property:"taskName"}},[i("bk-input",{attrs:{maxlength:100,placeholder:"请输入任务名称"},model:{value:t.formData.taskName,callback:function(e){t.$set(t.formData,"taskName",e)},expression:"formData.taskName"}})],1)],1),t._v(" "),i("div",{staticClass:"add-sever form-box"},[i("div",{staticClass:"title"},[t._v("添加服务器")]),t._v(" "),i("bk-form-item",{attrs:{"ext-cls":"whether-class",label:"操作系统",required:"",property:"os_type"}},[t.isShow?i("bk-radio-group",{on:{change:t.onChange},model:{value:t.formData.osType,callback:function(e){t.$set(t.formData,"osType",e)},expression:"formData.osType"}},[i("bk-radio",{staticStyle:{"margin-right":"36px"},attrs:{value:"Windows",disabled:t.disabledOsType}},[t._v("\n                                        Windows\n                                        "),i("span",{directives:[{name:"bk-tooltips",rawName:"v-bk-tooltips.top-start",value:"支持Windows Server 2012 R2及以上版本",expression:"'支持Windows Server 2012 R2及以上版本'",modifiers:{"top-start":!0}}],staticClass:"top-start",staticStyle:{"margin-left":"13px"}},[i("bk-icon",{attrs:{type:"info-circle"}})],1)]),t._v(" "),i("bk-radio",{attrs:{value:"Linux",disabled:t.disabledOsType}},[t._v("\n                                        Linux\n                                        "),i("span",{directives:[{name:"bk-tooltips",rawName:"v-bk-tooltips.top-start",value:"不支持SUSE Linux",expression:"'不支持SUSE Linux'",modifiers:{"top-start":!0}}],staticClass:"top-start",staticStyle:{"margin-left":"13px"}},[i("bk-icon",{attrs:{type:"info-circle"}})],1)])],1):t._e()],1),t._v(" "),i("bk-form-item",{attrs:{"error-display-type":"normal",label:"服务器",required:"",property:"serverList"}},[i("bk-button",{staticClass:"mr10",attrs:{theme:"default",title:"添加服务器",icon:"plus"},on:{click:t.toAddServer}},[t._v("\n                                    添加服务器\n                                ")]),t._v(" "),t.formData.serverList.length>0?i("server-list-table",{staticStyle:{"margin-top":"20px"},attrs:{"server-list":t.formData.serverList,"selected-pagination":t.selectedPagination},on:{toDelete:t.toDelete,pageChange:t.pageChange,limitChange:t.limitChange}}):t._e()],1)],1),t._v(" "),i("div",{staticClass:"add-patch form-box"},[i("div",{staticClass:"title"},[t._v("补丁添加")]),t._v(" "),i("bk-form-item",{attrs:{"error-display-type":"normal",label:"上传补丁",required:"",property:"patchFile"}},[i("div",{class:["add-patch-btn",t.disabledOsType&&"disabled-btn"],on:{click:t.addPatchFile}},[i("i",{staticClass:"bk-icon left-icon icon-plus"}),t._v(" "),i("span",[t._v("添加补丁文件")])]),t._v(" "),t.formData.patchFile?i("div",{staticClass:"progress-class"},[i("div",{staticClass:"progress-icon"},[i("bk-icon",{attrs:{type:"file"}})],1),t._v(" "),i("div",[i("div",[i("div",{staticClass:"file-name"},[t._v(t._s(t.formData.patchFile))]),t._v(" "),i("bk-icon",{staticClass:"process-close",attrs:{type:"close"},on:{click:t.deleteLoadPatch}})],1),t._v(" "),i("bk-progress",{attrs:{percent:t.process,size:"small","title-style":{fontSize:"12px"}}})],1)]):t._e()]),t._v(" "),i("bk-form-item",{attrs:{"error-display-type":"normal",label:"目标路径",required:"",property:"filePath"}},[i("bk-input",{attrs:{placeholder:"请输入目标路径"},model:{value:t.formData.filePath,callback:function(e){t.$set(t.formData,"filePath",e)},expression:"formData.filePath"}})],1),t._v(" "),i("bk-form-item",{attrs:{label:"传输限速"}},[i("div",{staticStyle:{display:"flex","align-items":"center",height:"32px"}},[i("bk-checkbox",{attrs:{"true-value":!0,"false-value":!1},model:{value:t.formData.isOpenSpeedLimit,callback:function(e){t.$set(t.formData,"isOpenSpeedLimit",e)},expression:"formData.isOpenSpeedLimit"}}),t._v(" "),t.formData.isOpenSpeedLimit?i("bk-input",{staticStyle:{flex:"1","margin-left":"15px"},attrs:{"right-icon":"bk-icon icon-search",type:"number",clearable:!0},model:{value:t.formData.speedLimit,callback:function(e){t.$set(t.formData,"speedLimit",e)},expression:"formData.speedLimit"}},[i("template",{slot:"append"},[i("div",{staticClass:"group-text"},[t._v("MB/s")])])],2):t._e(),t._v(" "),t.formData.isOpenSpeedLimit?i("div",{staticClass:"speed-limit-tip",attrs:{id:"speed-limit-tip"}},[i("div",{staticClass:"row"},[t._v("\n                                            请根据机器的网卡情况酌情配置速率，以免影响其他服务的正常使用；\n                                        ")]),t._v(" "),i("div",{staticClass:"row"},[t._v("\n                                            未开启时，将按 Agent 默认配置规则限速 （Agent会根据机器资源使用情况，有自身保护机制）\n                                        ")])]):t._e(),t._v(" "),t.formData.isOpenSpeedLimit?i("bk-icon",{directives:[{name:"bk-tooltips",rawName:"v-bk-tooltips",value:t.htmlConfig,expression:"htmlConfig"}],staticStyle:{"margin-left":"15px"},attrs:{type:"info-circle"}}):t._e()],1)])],1),t._v(" "),i("div",{staticClass:"notification-settings form-box"},[i("div",{staticClass:"title"},[t._v("通知设置")]),t._v(" "),i("bk-form-item",{attrs:{"error-display-type":"normal",label:"通知人"}},[i("bk-select",{attrs:{multiple:"","display-tag":"",placeholder:"请输入用户名/中文名",loading:t.selectLoading,"enable-virtual-scroll":"",list:t.maintainerList,"id-key":"idKey","display-key":"displayName","ext-popover-cls":"select-popover-custom",searchable:""},model:{value:t.formData.noticeName,callback:function(e){t.$set(t.formData,"noticeName",e)},expression:"formData.noticeName"}})],1),t._v(" "),i("bk-form-item",{attrs:{"error-display-type":"normal",label:"其他邮箱"}},[i("bk-tag-input",{attrs:{"create-tag-validator":t.validateEmail,placeholder:"请输入邮箱","allow-create":!0,"has-delete-icon":!0},on:{blur:t.tagInputBlur},model:{value:t.formData.email,callback:function(e){t.$set(t.formData,"email",e)},expression:"formData.email"}}),t._v(" "),t.isSuccessEmail?t._e():i("span",{staticStyle:{color:"#ea3636","font-size":"12px"}},[t._v("请输入合法的邮箱格式!")])],1)],1)])])],1),t._v(" "),i("div",{staticClass:"footer-box",style:{marginRight:(t.hasYScroll?6:0)+"px"}},[i("bk-button",{attrs:{loading:t.pageLoading,theme:"default"},on:{click:t.cancel}},[t._v("取消")]),t._v(" "),i("bk-button",{staticStyle:{"margin-right":"20px"},attrs:{loading:t.pageLoading,disabled:1!==t.process||t.pageLoading,theme:"primary",type:"submit"},on:{click:t.createTask}},[t._v("\n                    确定\n                ")])],1)])]),t._v(" "),i("add-server",{ref:"addServer",on:{sendServerList:t.getServerList}}),t._v(" "),i("add-patch",{ref:"addPatch",attrs:{"os-type":t.formData.osType},on:{sendPatchFile:t.getPatchFile,uploadPatchFile:t.uploadPatchFile,deletePatchFile:t.deletePatchFile}})],1)}),[],!1,null,"0a61121d",null).exports,Y=function(){var t=function(e,i){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])},t(e,i)};return function(e,i){if("function"!=typeof i&&null!==i)throw new TypeError("Class extends value "+String(i)+" is not a constructor or null");function a(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(a.prototype=i.prototype,new a)}}(),Z=function(t,e,i,a){var n,s=arguments.length,o=s<3?e:null===a?a=Object.getOwnPropertyDescriptor(e,i):a;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(t,e,i,a);else for(var r=t.length-1;r>=0;r--)(n=t[r])&&(o=(s<3?n(o):s>3?n(e,i,o):n(e,i))||o);return s>3&&o&&Object.defineProperty(e,i,o),o},K=function(t,e,i,a){return new(i||(i=Promise))((function(n,s){function o(t){try{l(a.next(t))}catch(t){s(t)}}function r(t){try{l(a.throw(t))}catch(t){s(t)}}function l(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(o,r)}l((a=a.apply(t,e||[])).next())}))},Q=function(t,e){var i,a,n,s,o={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]};return s={next:r(0),throw:r(1),return:r(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function r(s){return function(r){return function(s){if(i)throw new TypeError("Generator is already executing.");for(;o;)try{if(i=1,a&&(n=2&s[0]?a.return:s[0]?a.throw||((n=a.return)&&n.call(a),0):a.next)&&!(n=n.call(a,s[1])).done)return n;switch(a=0,n&&(s=[2&s[0],n.value]),s[0]){case 0:case 1:n=s;break;case 4:return o.label++,{value:s[1],done:!1};case 5:o.label++,a=s[1],s=[0];continue;case 7:s=o.ops.pop(),o.trys.pop();continue;default:if(!(n=o.trys,(n=n.length>0&&n[n.length-1])||6!==s[0]&&2!==s[0])){o=0;continue}if(3===s[0]&&(!n||s[1]>n[0]&&s[1]<n[3])){o.label=s[1];break}if(6===s[0]&&o.label<n[1]){o.label=n[1],n=s;break}if(n&&o.label<n[2]){o.label=n[2],o.ops.push(s);break}n[2]&&o.ops.pop(),o.trys.pop();continue}s=e.call(t,o)}catch(t){s=[6,t],a=0}finally{i=n=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,r])}}},X=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.visible=!1,e.exportDetailId=1,e.loading=!1,e.searchValue="",e.dataList=[],e.columns=[{label:"任务名称",key:"name",align:"left",fixed:"left",minWidth:"100px",scopedSlots:"name"},{label:"补丁名称",key:"patch_file_name",align:"left",minWidth:"150px"},{label:"创建时间",key:"created_at",align:"left",minWidth:"150px"},{label:"操作系统类型",key:"os_type",align:"left",minWidth:"110px"},{label:"服务器数量",key:"server_count",align:"left",minWidth:"100px"},{label:"执行次数",key:"run_count",align:"left",minWidth:"80px"},{label:"上次执行时间",key:"last_at",align:"left",minWidth:"150px"},{label:"上次执行结果(异常/失败/成功)",key:"last_task_result",align:"left",minWidth:"195px"},{label:"定时执行时间",key:"next_at",align:"left",minWidth:"150px",scopedSlots:"next_at"},{label:"执行进度",key:"progress",align:"left",minWidth:"150px",scopedSlots:"progress"},{label:"操作",key:"operation",fixed:"right",minWidth:"265px",scopedSlots:"operation"}],e.pagination={current:1,count:1,limit:10},e.userSelectList=[],e.isShow=!0,e.progressMap={finish:"执行完成",install:"补丁安装中",running:"补丁分发中",no_start:"任务未进行",waiting:"任务待执行",lose:"任务已失效"},e.timer=null,e.borderColorMap={finish:"#3FC06D",no_start:"#C4C6CC",waiting:"#1768EF",lose:"#FF9C01"},e.backGroundColorMap={finish:"#E5F6EA",no_start:"#F0F1F5",waiting:"#E1ECFF",lose:"#FFE8C3"},e.maxHeight="",e}return Y(e,t),Object.defineProperty(e.prototype,"powerParams",{get:function(){return{id:this.$route.name,type:"operateAuth"}},enumerable:!1,configurable:!0}),e.prototype.mounted=function(){var t=this;this.fetchData(),this.timedExecution();this.maxHeight=window.innerHeight-179,window.onresize=function(){t.maxHeight=window.innerHeight-179}},e.prototype.beforeDestroy=function(){window.clearInterval(this.timer)},e.prototype.timedExecution=function(){var t=this;this.timer=window.setInterval((function(){return t.fetchData("noLoading")}),6e4)},e.prototype.onSearch=function(){this.pagination.current=1,this.fetchData()},e.prototype.handlePageChange=function(t){this.pagination.current=t,this.fetchData()},e.prototype.limitChange=function(t){this.pagination.current=1,this.pagination.limit=t,this.fetchData()},e.prototype.handlePatchTask=function(t,e){if(!this.$BtnPermission(this.powerParams))return!1;this.$refs.taskPanel.show(t,e)},e.prototype.fetchData=function(t){return K(this,void 0,void 0,(function(){var e=this;return Q(this,(function(i){return"noLoading"!==t&&(this.loading=!0),this.$api.patchInstall.getPatchTask({page:this.pagination.current,page_size:this.pagination.limit,name:this.searchValue}).then((function(t){if(!t.result)return e.$error(t.message),e.dataList=[],!1;e.pagination.count=t.data.count,e.dataList=t.data.items,e.dataList.forEach((function(t){t.server_count=t.server_list.length}))})).finally((function(){e.loading=!1})),[2]}))}))},e.prototype.exportDetail=function(t){return K(this,void 0,void 0,(function(){var e=this;return Q(this,(function(i){return this.$bkInfo({title:"导出详情",subTitle:'您好，仅导出最后一次任务执行的详情，若要继续导出，请点击"导出"按钮',okText:"导出",confirmLoading:!0,confirmFn:function(){return K(e,void 0,void 0,(function(){var e;return Q(this,(function(i){return e=window.siteUrl+"patch_mgmt/patchtask/import_task_server_detail/?patch_task_id="+t.id,window.open(e),[2]}))}))}}),[2]}))}))},e.prototype.toDelete=function(t){var e=this;if(!this.$BtnPermission(this.powerParams))return!1;this.$bkInfo({title:"确认要删除："+t.name+"?",confirmLoading:!0,confirmFn:function(){e.loading=!0,e.$api.patchInstall.deletePatchTask({id:t.id}).then((function(t){t.result?(e.$success("删除成功"),1===e.dataList.length&&(e.pagination.current-=1,0===e.pagination.current&&(e.pagination.current=1)),e.fetchData()):(e.loading=!1,e.$error(t.message))}))}})},e.prototype.toExecute=function(t){if(!this.$BtnPermission(this.powerParams))return!1;this.$refs.execTask.showDialog(t)},e.prototype.toDetail=function(t){this.$refs.patchDetailRef.show(t)},e=Z([Object(s.a)({name:"patch-install",components:{comTable:n.a,patchDetail:h,execTask:_,taskPanel:J}})],e)}(s.e),tt=X,et=Object(d.a)(tt,(function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"table—common-wrapper patch-install"},[i("div",{staticClass:"header-table-operation"},[i("bk-input",{staticStyle:{flex:"1"},attrs:{clearable:"",placeholder:"请输入搜索任务名","right-icon":"bk-icon icon-search"},on:{enter:t.onSearch,"right-icon-click":t.onSearch},model:{value:t.searchValue,callback:function(e){t.searchValue=e},expression:"searchValue"}}),t._v(" "),i("bk-button",{directives:[{name:"permission",rawName:"v-permission",value:t.powerParams,expression:"powerParams"}],staticClass:"ml20",attrs:{theme:"primary",title:"新建"},on:{click:function(e){return t.handlePatchTask("add")}}},[t._v("\n            新建\n        ")])],1),t._v(" "),i("div",{directives:[{name:"bkloading",rawName:"v-bkloading",value:{isLoading:t.loading,zIndex:10},expression:"{ isLoading: loading, zIndex: 10 }"}]},[i("com-table",{attrs:{data:t.dataList,columns:t.columns,pagination:t.pagination,"max-height":t.maxHeight},on:{"page-change":t.handlePageChange,"page-limit-change":t.limitChange},scopedSlots:t._u([{key:"name",fn:function(e){var a=e.row;return[i("span",{staticStyle:{color:"#0d90fc",cursor:"pointer"},on:{click:function(e){return t.toDetail(a)}}},[t._v(t._s(a.name))])]}},{key:"progress",fn:function(e){var a=e.row;return[["no_start","finish","waiting","lose"].includes(a.progress)?i("div",{staticClass:"progress-class",style:{borderColor:t.borderColorMap[a.progress],backgroundColor:t.backGroundColorMap[a.progress]}}):i("bk-spin",{staticStyle:{"margin-right":"8px",width:"10px",height:"10px"},attrs:{size:"mini"}}),t._v("\n                "+t._s(t.progressMap[a.progress])+"\n            ")]}},{key:"next_at",fn:function(e){var a=e.row;return[i("span",{style:{color:0===a.patch_file_id?"#dcdee5":"#575961"}},[t._v(t._s(a.next_at))])]}},{key:"operation",fn:function(e){var a=e.row;return t.isShow?[i("bk-button",{directives:[{name:"permission",rawName:"v-permission",value:t.powerParams,expression:"powerParams"}],staticClass:"mr10",attrs:{theme:"primary",disabled:!a.status||0===a.patch_file_id,text:""},on:{click:function(e){return t.toExecute(a)}}},[t._v("\n                    执行设置\n                ")]),t._v(" "),i("bk-button",{directives:[{name:"permission",rawName:"v-permission",value:t.powerParams,expression:"powerParams"}],staticClass:"mr10",attrs:{theme:"primary",disabled:!a.status,text:""},on:{click:function(e){return t.handlePatchTask("edit",a)}}},[t._v("\n                    修改\n                ")]),t._v(" "),i("bk-button",{staticClass:"mr10",attrs:{theme:"primary",text:""},on:{click:function(e){return t.exportDetail(a)}}},[t._v("导出详情\n                ")]),t._v(" "),i("bk-button",{directives:[{name:"permission",rawName:"v-permission",value:t.powerParams,expression:"powerParams"}],staticClass:"mr10",attrs:{theme:"primary",text:""},on:{click:function(e){return t.handlePatchTask("clone",a)}}},[t._v("克隆\n                ")]),t._v(" "),i("bk-button",{directives:[{name:"permission",rawName:"v-permission",value:t.powerParams,expression:"powerParams"}],staticClass:"mr10",attrs:{theme:"primary",disabled:!a.status,text:""},on:{click:function(e){return t.toDelete(a)}}},[t._v("删除\n                ")])]:void 0}}],null,!0)})],1),t._v(" "),i("patchDetail",{ref:"patchDetailRef"}),t._v(" "),i("exec-task",{ref:"execTask",on:{search:t.fetchData}}),t._v(" "),i("task-panel",{ref:"taskPanel",on:{refreshList:t.fetchData}})],1)}),[],!1,null,"fa017c40",null);e.default=et.exports}}]);