(window.webpackJsonp=window.webpackJsonp||[]).push([[29],{v4rw:function(t,e,a){"use strict";a.r(e);var i=a("yXPU"),n=a.n(i),o=(a("91GP"),a("L9s1"),a("Z2Ku"),a("o0o1")),r=a.n(o),s={name:"record-operation",props:{condition:{operation_date_range:[],operator:""},backButtonStatus:{type:Boolean,default:!1}},data:function(){return{localCondition:{operation_date_range:[],operator:""}}},created:function(){this.localCondition=this.$copy(this.condition)},methods:{search:function(){var t=Object.assign(this.$copy(this.condition),this.localCondition);!t.operator&&delete t.operator,!(t.operation_date_range?t.operation_date_range.length:0)&&delete t.operation_date_range,this.$emit("search",t)},changeDate:function(t){this.$set(this.localCondition,"operation_date_range",t)},handleBackBtnClick:function(){var t=Object.assign(this.$copy(this.condition),this.localCondition);!t.operator&&delete t.operator,!t.operation_date_range.length&&delete t.operation_date_range,this.$emit("back-button-click",t)}}},l=a("KHd+"),c=Object(l.a)(s,(function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("div",{staticClass:"record-operation mb20"},[a("span",{staticClass:"mr8"},[t._v(t._s(t.$t("时间范围")))]),t._v(" "),a("bk-date-picker",{staticClass:"mr8",staticStyle:{width:"300px"},attrs:{value:t.localCondition.operation_date_range,type:"datetimerange",format:"yyyy-MM-dd HH:mm:ss",placeholder:"选择日期时间范围",clearable:!1},on:{change:t.changeDate}}),t._v(" "),a("span",{staticClass:"mr8"},[t._v(t._s(t.$t("操作账号")))]),t._v(" "),a("bk-input",{staticClass:"w150",attrs:{placeholder:t.$t("请输入用户")},model:{value:t.localCondition.operator,callback:function(e){t.$set(t.localCondition,"operator",e)},expression:"localCondition.operator"}}),t._v(" "),a("bk-button",{staticClass:"ml8",attrs:{theme:"primary",title:t.$t("查询")},on:{click:t.search}},[t._v("\n        "+t._s(t.$t("查询"))+"\n    ")]),t._v(" "),t.backButtonStatus?a("bk-button",{staticClass:"ml8",attrs:{title:t.$t("查询")},on:{click:t.handleBackBtnClick}},[t._v("返回")]):t._e()],1)}),[],!1,null,"dff11d04",null).exports,d=(a("ioFf"),a("mYba"),a("jm62"),a("lSNA")),u=a.n(d),h=(a("xfY5"),a("CX2u"),a("Btvt"),a("VRzm"),a("XfO3"),a("yt8O"),a("rGqo"),a("RW0V"),a("0l/t"),a("L2JU")),p={name:"cw-bk-table",components:{},filters:{contentText:function(t){return["",void 0].includes(t)?"--":t}},props:{column:{type:Array,default:function(){return[]}},data:{type:Array,default:function(){}},config:{type:Object,default:function(){return{showOperator:!1}}},pagination:{type:Object,default:function(){return{current:1,count:0,limit:20,limitList:[10,20,50,100,500]}}},maxHeight:{type:[Number,String],default:""},headerAlign:{type:String,default:"left",validator:function(t){return["left","center","right"].includes(t)}}},data:function(){return{}},computed:{maxTableHeight:function(){if(!this.maxHeight){var t=document.body.scrollHeight-200;return t>250?t:250}return this.maxHeight}},watch:{},created:function(){},mounted:function(){},methods:{getTableRowStyle:function(t){var e=t.row;t.column,t.rowIndex,t.columnIndex;if(e.isStyleChange)return{"background-color":"#dcffe2"}},handlePageChange:function(t){this.pagination.current!==t&&(this.pagination.current=t,this.$emit("page-change",t))},handlePageLimitChange:function(t){this.pagination.current=1,this.$emit("page-limit-change",t)},handleRowClick:function(t,e,a,i,n){this.$emit("row-click",t,e,a,i,n)}}};function g(t,e){var a=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),a.push.apply(a,i)}return a}function b(t){for(var e=1;e<arguments.length;e++){var a=null!=arguments[e]?arguments[e]:{};e%2?g(Object(a),!0).forEach((function(e){u()(t,e,a[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(a)):g(Object(a)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(a,e))}))}return t}var f={name:"cw-bk-sideslider",components:{CwBkTable:Object(l.a)(p,(function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("div",{staticClass:"cw-bk-table"},[a("bk-table",{attrs:{"max-height":t.maxTableHeight,data:t.data,pagination:t.pagination,"row-style":t.getTableRowStyle},on:{"page-change":t.handlePageChange,"page-limit-change":t.handlePageLimitChange,"row-click":t.handleRowClick}},[t._l(t.column,(function(e,i){return a("bk-table-column",{key:i,attrs:{"show-overflow-tooltip":"",label:e.label,width:e.width,"header-align":e.headerAlign,align:e.align},scopedSlots:t._u([{key:"default",fn:function(i){return[a("div",{staticClass:"custom-row"},[t._v("\n                    "+t._s(t._f("contentText")(i.row[e.prop]))+"\n                ")])]}}],null,!0)})})),t._v(" "),t.config.showOperator?a("bk-table-column",{attrs:{label:"操作",width:"200"}},[[a("bk-button",{staticClass:"mr10",attrs:{theme:"primary",text:""}},[t._v("移除")]),t._v(" "),a("bk-popover",{staticClass:"dot-menu",attrs:{placement:"bottom",theme:"light",trigger:"click","ext-cls":"dot-menu-popover"}},[a("span",{staticClass:"dot-menu-trigger"}),t._v(" "),a("ul",{staticClass:"dot-menu-list",attrs:{slot:"content"},slot:"content"},[a("li",{staticClass:"dot-menu-item"},[t._v("导入")]),t._v(" "),a("li",{staticClass:"dot-menu-item"},[t._v("导出")])])])]],2):t._e()],2)],1)}),[],!1,null,"72d31d76",null).exports},props:{config:{type:Object,default:function(){return{isShow:!1,asideInfo:{},row:{}}}},width:{type:Number,default:400}},data:function(){return{isOpen:!1,isSidesliderLoading:!1,tableStatus:"update",allTableData:[],filterTableData:[]}},computed:b(b({},Object(h.mapGetters)({objAttMap:"obj/objAttMap"})),{},{objId:function(){return this.config.row.operation_target},column:function(){return{update:[{label:"属性",prop:"arrtribute",headerAlign:"right",align:"right"},{label:"变更前",prop:"old"},{label:"变更后",prop:"new"}],delete:[{label:"属性",prop:"arrtribute",headerAlign:"right",align:"right"},{label:"变更前",prop:"old"}],add:[{label:"属性",prop:"arrtribute",headerAlign:"right",align:"right"},{label:"变更后",prop:"new"}]}[this.tableStatus]},maxHeight:function(){return document.body.scrollHeight-100-136-40},labelMap:function(){return{bk_biz_id:"所属业务",operation_target_name:"操作对象",action_desc:"动作",operation_category:"模型类型",resource_name:"操作实例",description:"操作描述",operation_time:"操作时间",operator:"操作帐号"}},tableData:function(){return this.isOpen?this.allTableData:this.filterTableData},objAttNameMap:function(){var t={};return this.objAttMap[this.objId]&&this.objAttMap[this.objId].forEach((function(e){t[e.bk_property_id]=e.bk_property_name})),t}}),watch:{},created:function(){this.init()},mounted:function(){},methods:{init:function(){var t=this;return n()(r.a.mark((function e(){return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t.isSidesliderLoading=!0,Promise.all([t.$store.dispatch("obj/searchObjectAttribute",{bk_obj_id:t.objId}),t.getAsideInfo()]).finally((function(){t.isSidesliderLoading=!1}));case 2:case"end":return e.stop()}}),e)})))()},getLabelContent:function(t){var e=this.config;return e.row[t]?e.row[t]:"--"},handleOpenToggle:function(){this.isOpen=!this.isOpen},getAsideInfo:function(){var t=this;return n()(r.a.mark((function e(){var a,i,n;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a={ids:[t.config.row.id]},e.next=3,t.$http.post("/api/audit_log/search_audit_log_details",a);case 3:if((i=e.sent).result){e.next=6;break}return e.abrupt("return",t.$message.error(i.message));case 6:t.config.asideInfo=i.data[0],n=t.config.asideInfo.details,t.tableStatus=t.handleTableStatus(n),t.handleTAbleData(n,t.tableStatus);case 10:case"end":return e.stop()}}),e)})))()},handleTableStatus:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=t.curr_data,a=t.pre_data;return null===e&&Object.keys(a).length?"delete":null===a&&Object.keys(e).length?"add":Object.keys(e).length&&Object.keys(a).length?"update":void 0},handleTAbleData:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"update";if(this.allTableData=[],"update"===e)for(var a in t.curr_data)this.allTableData.push({arrtribute:this.objAttNameMap[a]||a,old:t.pre_data[a],new:t.curr_data[a],isStyleChange:Object.keys(t.update_fields).includes(a)});else{var i="add"===e?t.curr_data:t.pre_data,n="add"===e?"new":"old";for(var o in i){var r;this.allTableData.push((r={arrtribute:this.objAttNameMap[o]||o},u()(r,n,i[o]),u()(r,"isStyleChange",!0),r))}}this.filterTableData=this.allTableData.filter((function(t){return t.isStyleChange}))}}},m=f,_={name:"cmdb-instance-record",components:{RecordOperation:c,CwBkSideslider:Object(l.a)(m,(function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("bk-sideslider",{staticClass:"cw-bk-sideslider",attrs:{"is-show":t.config.isShow,width:t.width},on:{"update:isShow":function(e){return t.$set(t.config,"isShow",e)},"update:is-show":function(e){return t.$set(t.config,"isShow",e)}}},[a("div",{attrs:{slot:"header"},slot:"header"},[t._v("操作详情")]),t._v(" "),a("div",{directives:[{name:"bkloading",rawName:"v-bkloading",value:{isLoading:t.isSidesliderLoading,zIndex:10},expression:"{ isLoading: isSidesliderLoading, zIndex: 10 }"}],staticClass:"sideslider-content",attrs:{slot:"content"},slot:"content"},[a("ul",{staticClass:"details-info"},t._l(t.labelMap,(function(e,i,n){return a("li",{key:n,staticClass:"info-group"},[a("label",{staticClass:"info-label"},[t._v(t._s(e)+"：")]),t._v(" "),a("span",{staticClass:"info-content",attrs:{title:t.getLabelContent(i)}},[t._v(t._s(t.getLabelContent(i)))])])})),0),t._v(" "),a("div",{staticClass:"details-table"},[a("cw-bk-table",{attrs:{column:t.column,data:t.tableData,"max-height":t.maxHeight}}),t._v(" "),a("div",{staticClass:"details-toggle"},[a("span",{on:{click:t.handleOpenToggle}},[t._v(t._s(t.isOpen?"收起":"展开"))])])],1)])])}),[],!1,null,"01687126",null).exports},props:{config:{default:function(){return{}}}},computed:{currNode:function(){return this.config.currNode},objId:function(){return this.currNode.bk_obj_id},instId:function(){return this.currNode.bk_inst_id}},data:function(){return{isTableLoading:!1,isBackButtonShow:!1,logTablePagination:{current:1,count:0,limit:20,limitList:[20,50,100,200,500]},pid:0,condition:{},auditData:{},columns:[{title:"变更内容",key:"description"},{title:"操作账号",key:"operator"},{title:"操作时间",key:"operation_time"}],batchDictionary:["batch_update","batch_create","batch_delete","batch_import","batch_export","import_create","import_update"],sideSliderConfig:{isShow:!1,asideInfo:{},row:{}}}},created:function(){this.searchLogList()},methods:{search:function(t){this.condition=t||{},this.logTablePagination.current=1,this.searchLogList()},searchLogList:function(){var t=this;return n()(r.a.mark((function e(){var a,i;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=t.handleReqParams(),t.isTableLoading=!0,e.next=4,t.$http.post("/api/audit_log/search_audit_log",a);case 4:if(i=e.sent,t.isTableLoading=!1,i.result){e.next=8;break}return e.abrupt("return",t.$message.error(i.message));case 8:t.auditData=i.data;case 9:case"end":return e.stop()}}),e)})))()},handleReqParams:function(){var t={condition:{resource_id:this.instId},operation_category:"resources",operation_target:this.objId,pid:this.pid,page:{page_num:this.logTablePagination.current,page_limit:this.logTablePagination.limit}};return Object.assign(t,this.condition)},pageChange:function(t){this.logTablePagination=t,this.searchLogList()},handleRowClick:function(t){this.batchDictionary.includes(t.action)?(this.pid=t.id,this.isBackButtonShow=!0,this.searchLogList()):(this.sideSliderConfig.isShow=!0,this.sideSliderConfig.row=t)},handleBackBtnClick:function(t){this.condition=t,this.pid=0,this.logTablePagination.current=1,this.isBackButtonShow=!1,this.searchLogList()}}},v=Object(l.a)(_,(function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("div",{staticClass:"cmdb-instance-record"},[a("record-operation",{attrs:{condition:t.condition,"back-button-status":t.isBackButtonShow},on:{search:t.search,"back-button-click":t.handleBackBtnClick}}),t._v(" "),a("div",{staticClass:"content"},[a("cw-bk-table",{directives:[{name:"bkloading",rawName:"v-bkloading",value:{isLoading:t.isTableLoading,zIndex:10},expression:"{ isLoading: isTableLoading, zIndex: 10 }"}],attrs:{columns:t.columns,data:t.auditData.info,total:t.auditData.count},on:{"page-change":t.pageChange,"row-click":t.handleRowClick}}),t._v(" "),t.sideSliderConfig.isShow?a("cw-bk-sideslider",{attrs:{config:t.sideSliderConfig,width:800}}):t._e()],1)],1)}),[],!1,null,"148c41f5",null);e.default=v.exports}}]);